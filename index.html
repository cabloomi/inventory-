<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory Intake (Cloudflare Pages)</title>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e6f1ff; margin:0; }
  .wrap { max-width: 1100px; margin: 20px auto; padding: 16px; background:#0f141a; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  h1 { margin-top:0; }
  textarea { width:100%; min-height: 140px; border-radius:10px; padding:10px; background:#0d1218; color:#def; border:1px solid #213244; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .btn { background:#00e29b; color:#062612; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#18344a; color:#bfeaff; }
  .muted { opacity:.7; font-size: 13px; }
  table { width:100%; border-collapse: collapse; margin-top: 16px; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #213244; vertical-align: top; }
  th { text-align:left; color:#bfeaff; }
  input[type="text"], input[type="number"] { background:#0d1218; color:#def; border:1px solid #213244; border-radius:8px; padding:8px; width:100%; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; background:#1b2a3a; color:#bfeaff; font-size:12px; }
  .tag.red { background:#3a1b1b; color:#ffbfbf; }
  .right { text-align:right; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Inventory Intake (Pages Functions)</h1>
  <p class="muted">Uses Sickw (service 61) and your live CSV. We’ll pre-fill <b>Price Paid ($)</b> with whole dollars, editable.</p>

  <div id="balance" class="muted"></div>

  <form id="form">
    <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
    <textarea id="imeis" placeholder="354442067957452&#10;353052118765432&#10;..."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn" type="submit">Lookup & Price</button>
      <button class="btn secondary" id="reset" type="button">Reset</button>
      <span class="muted">We match iPhones to iPhone sheets and Unlocked phones to the “iPhone New Unlocked” sheet first.</span>
    </div>
  </form>

  <div id="out"></div>
</div>

<script>
async function fetchBalance() {
  try {
    const r = await fetch('/api/balance');
    const j = await r.json();
    const val = (j.balance || '').toString().trim();
    let text = 'API Balance: ';
    text += val && !isNaN(Number(val)) ? `<span class="tag">$${val}</span>` : `<span class="tag red">${val || '—'}</span>`;
    document.getElementById('balance').innerHTML = text;
  } catch {}
}
fetchBalance();

document.getElementById('reset').onclick = () => {
  document.getElementById('imeis').value = '';
  document.getElementById('out').innerHTML = '';
};

document.getElementById('form').onsubmit = async (e) => {
  e.preventDefault();
  const raw = document.getElementById('imeis').value || '';
  const imeis = raw.split(/[\s,;\n\r]+/).map(s=>s.trim()).filter(Boolean).slice(0,200);
  if (!imeis.length) return;

  const res = await fetch('/api/intake', {
    method: 'POST',
    headers: { 'content-type':'application/json' },
    body: JSON.stringify({ imeis })
  });
  const data = await res.json();

  const el = document.getElementById('out');
  if (!res.ok) {
    el.innerHTML = '<div class="err">' + (data.error || 'Error') + '</div>';
    return;
  }

  const rows = data.items || [];
  const table = [];
  table.push(`<table>
    <thead>
      <tr>
        <th>IMEI</th>
        <th>Device</th>
        <th>Color</th>
        <th>Storage</th>
        <th>Carrier</th>
        <th>Matched (Sheet)</th>
        <th class="right">Price Paid ($)</th>
        <th>Notes</th>
      </tr>
    </thead><tbody>`);

  rows.forEach((r, idx) => {
    if (!r.ok) {
      table.push(`<tr><td colspan="8" class="err">IMEI ${r.imei} → ${r.error || 'error'}</td></tr>`);
      return;
    }
    const warn = r.icloud_lock_on ? `<span class="tag red">iCloud Lock: ON</span>` : '';
    const display = (r.device_display || ((r.manufacturer||'') + ' ' + (r.model_name||''))).trim();
    const paidDollars = typeof r.suggested_price_dollars === 'number' ? r.suggested_price_dollars : '';
    table.push(`<tr>
      <td><code>${r.imei}</code></td>
      <td>${display} ${warn ? `<div>${warn}</div>` : ''}</td>
      <td>${r.color || ''}</td>
      <td>${r.storage || ''}</td>
      <td><span class="tag">${r.carrier || 'Unknown'}</span></td>
      <td><div>${r.match_device || '—'}</div><div class="muted">${r.match_sheet || ''}</div></td>
      <td class="right"><input type="number" id="paid_${idx}" value="${paidDollars}" step="1" min="0" /></td>
      <td><input type="text" id="note_${idx}" /></td>
    </tr>`);
  });

  table.push(`</tbody></table>
    <div class="row" style="margin-top:12px;">
      <button class="btn" id="download">Download CSV</button>
      <span class="muted">CSV exports price paid in <b>cents</b> (dollars × 100).</span>
    </div>`);

  el.innerHTML = table.join('');

  document.getElementById('download').onclick = () => {
    const payload = rows.map((r, idx) => r.ok ? (() => {
      const dollars = Number((document.getElementById('paid_'+idx)?.value || '').trim());
      const cents = Number.isFinite(dollars) ? Math.round(dollars * 100) : '';
      return {
        imei: r.imei,
        manufacturer: r.manufacturer || '',
        model_name: r.model_name || '',
        model_code: r.model_code || '',
        device: r.device_display || '',
        color: r.color || '',
        storage: r.storage || '',
        carrier: r.carrier || 'Unknown',
        icloud_lock: r.icloud_lock_on ? 'ON' : 'OFF',
        suggested_price_cents: r.suggested_price_cents ?? '',
        price_paid_cents: cents,
        notes: (document.getElementById('note_'+idx)?.value || '').trim(),
      };
    })() : null).filter(Boolean);

    const header = ['imei','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','suggested_price_cents','price_paid_cents','notes'];
    const csv = [header.join(',')].concat(payload.map(o =>
      header.map(k => JSON.stringify(String(o[k] ?? '')).replace(/^\uFEFF/, '')).join(',')
    )).join('\n');

    const blob = new Blob([csv], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: 'intake_export.csv' });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
};
</script>
</body>
</html>
