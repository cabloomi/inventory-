<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory Intake</title>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e6f1ff; margin:0; }
  .wrap { max-width: 1200px; margin: 20px auto; padding: 16px; background:#0f141a; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); position: relative; }
  h1 { margin-top:0; }
  textarea { width:100%; min-height: 140px; border-radius:10px; padding:10px; background:#0d1218; color:#def; border:1px solid #213244; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .btn { background:#00e29b; color:#062612; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#18344a; color:#bfeaff; }
  .muted { opacity:.7; font-size: 13px; }
  table { width:100%; border-collapse: collapse; margin-top: 16px; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #213244; vertical-align: top; }
  th { text-align:left; color:#bfeaff; font-weight: 600; }
  input[type="text"], input[type="number"] { background:#0d1218; color:#def; border:1px solid #213244; border-radius:8px; padding:8px; width:100%; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; background:#1b2a3a; color:#bfeaff; font-size:12px; }
  .tag.red { background:#3a1b1b; color:#ffbfbf; }
  .right { text-align:right; }
  .totals { margin-top:12px; font-weight:700; }
  /* loader */
  .loader { position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; border-radius:14px; }
  .loader.show { display:flex; }
  .spinner { width:42px; height:42px; border:5px solid #1b2a3a; border-top-color:#00e29b; border-radius:50%; animation: spin 0.9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  /* chips */
  .chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:8px 12px; border-radius:999px; background:#101720; color:#cfe8ff; border:1px solid #1a2a3c; cursor:pointer; opacity:0.98; user-select:none; }
  .chip:hover { opacity:1; }
  .chip .label { opacity:.65; }
  .chip .value { font-weight:700; }
  /* menu */
  .menu { position:absolute; background:#0d1218; border:1px solid #213244; border-radius:10px; min-width:180px; box-shadow: 0 10px 25px rgba(0,0,0,.35); z-index:999; display:none; }
  .menu.show { display:block; }
  .menu-item { padding:10px 12px; cursor:pointer; font-size:13px; }
  .menu-item:hover { background:#13202d; }
</style>
</head>
<body>
<div class="wrap">
  <div id="loader" class="loader"><div><div class="spinner" style="margin:auto"></div><div class="muted" style="margin-top:10px;text-align:center">Looking up IMEIs…</div></div></div>

  <h1>Inventory Intake</h1>
  <p class="muted">We auto-fill <b>Price Paid</b> from your price variants. Change <b>Condition</b>, <b>Carrier</b>, or <b>Storage</b> with the chips; the price re-computes instantly (but you can still type over it).</p>

  <div id="balance" class="muted"></div>

  <form id="form">
    <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
    <textarea id="imeis" placeholder="354442067957452u&#10;353052118765432&#10;..."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="lookupBtn" type="submit">Lookup & Price</button>
      <button class="btn secondary" id="reset" type="button">Reset</button>
    </div>
  </form>

  <div id="out"></div>
  <div class="totals" id="totals"></div>
</div>

<div id="menu" class="menu" role="menu"></div>

<script>
var state = { rows: [], manual: [] };
const CARRIERS = ["Unlocked","Verizon","T-Mobile","AT&T","Xfinity","Spectrum","US Cellular","Cricket"];
const STORAGES = ["64GB","128GB","256GB","512GB","1TB","2TB"];

function variantKey(cond, carrier){ const lock=(carrier==='Unlocked')?'UNLOCKED':'LOCKED'; return (cond||'New').toUpperCase() + '_' + lock; }
function centsToDollars(c){ return (typeof c==='number' && isFinite(c)) ? Math.round(c)/100 : ''; }
function autoPriceDollars(row){ const key=variantKey(row.ui?.condition, row.ui?.carrier); const cents=row.ui?.variants?row.ui.variants[key]:undefined; return (typeof cents==='number')?centsToDollars(cents):''; }
function setUserPrice(row, dollars){ row.ui=row.ui||{}; row.ui.userPriceDollars = (isFinite(Number(dollars))?Number(dollars):''); }
function getDisplayPrice(row){ if(row.ui && row.ui.userPriceDollars!=='' && typeof row.ui.userPriceDollars!=='undefined') return row.ui.userPriceDollars; const v=autoPriceDollars(row); if(v!=='' ) return v; if(typeof row.suggested_price_dollars==='number') return row.suggested_price_dollars; return ''; }

async function ensureVariants(row){
  if(row && row.ui && row.ui.variants) return;
  const q = encodeURIComponent(row.device_display || row.device || row.model_name || '');
  const storage = encodeURIComponent(row.ui?.storage || row.storage || '');
  const brand = ''; // backend usually preloads; fallback fetch is generic
  try {
    const res = await fetch(`/api/variants?q=${q}&storage=${storage}&brand=${brand}`);
    const data = await res.json();
    if (data && data.prices) { row.ui = row.ui || {}; row.ui.variants = data.prices; }
  } catch(e) {}
}

function render(){
  const el=document.getElementById('out');
  const rows=state.rows, mrows=state.manual;
  const head=['Identifier (IMEI / Serial)','Device','Condition','Storage','Carrier','Matched (Sheet)','Price Paid ($)','Qty','Notes'];
  let html='<table><thead><tr>'+head.map(h=>'<th>'+h+'</th>').join('')+'</tr></thead><tbody>';

  rows.forEach((r, idx)=>{
    r._idx=idx; r.ui=r.ui||{};
    if(!r.ui.condition) r.ui.condition = r.used ? 'Used' : 'New';
    if(!r.ui.carrier) r.ui.carrier = r.carrier && CARRIERS.includes(r.carrier) ? r.carrier : 'Unlocked';
    if(!r.ui.storage) r.ui.storage = r.storage || '';

    // If no user price yet, populate it now from variants/suggested
    if (typeof r.ui.userPriceDollars === 'undefined' || r.ui.userPriceDollars === '') {
      const v = getDisplayPrice(r);
      if (v !== '') r.ui.userPriceDollars = v;
    }

    const paid = getDisplayPrice(r);

    html += `<tr>
      <td><code>${r.imei||''}</code></td>
      <td>${(r.device_display || ((r.manufacturer||'')+' '+(r.model_name||''))).trim()}</td>
      <td><span class="chip" data-kind="cond" data-rowkind="api" data-idx="${idx}"><span class="label">Cond</span><span class="value">${r.ui.condition}</span></span></td>
      <td><span class="chip" data-kind="store" data-rowkind="api" data-idx="${idx}"><span class="label">Storage</span><span class="value">${r.ui.storage||'—'}</span></span></td>
      <td><span class="chip" data-kind="car" data-rowkind="api" data-idx="${idx}"><span class="label">Carrier</span><span class="value">${r.ui.carrier}</span></span></td>
      <td>${r.match_device ? ('<div>'+r.match_device+'</div><div class="muted">'+(r.match_sheet||'')+'</div>') : '<div class="muted">—</div>'}</td>
      <td class="right"><input type="number" class="paid" data-kind="api" data-idx="${idx}" value="${paid!==''?paid:''}" step="1" min="0" /></td>
      <td class="right">1</td>
      <td><input type="text" class="note" data-kind="api" data-idx="${idx}" /></td>
    </tr>`;
  });

  html += '</tbody></table><div class="row" style="margin-top:12px;"><button class="btn" id="download">Download CSV</button></div>';
  el.innerHTML = html;

  bindDelegatedChipMenus();
  attachPriceHandlers();
  bindDownload();
  computeTotals();
}

function attachPriceHandlers(){
  document.querySelectorAll('.paid').forEach(inp=>{
    inp.addEventListener('input', function(){
      const idx=Number(inp.getAttribute('data-idx')); const row=state.rows[idx];
      if(!row)return; setUserPrice(row, inp.value); computeTotals();
    });
  });
}

function bindDownload(){
  document.getElementById('download').onclick=function(){
    const payload=[];
    state.rows.forEach((r,idx)=>{
      const paid=document.querySelector('.paid[data-idx="'+idx+'"]')?.value;
      const cents=isFinite(Number(paid))?Math.round(Number(paid)*100):'';
      payload.push({
        manual:'no', used:(r.ui?.condition==='Used')?'yes':'no', used_source:r.used_source||'',
        identifier:r.imei||'', manufacturer:r.manufacturer||'', model_name:r.model_name||'', model_code:r.model_code||'',
        device:r.device_display||'', color:r.color||'', storage:r.ui?.storage||r.storage||'', carrier:r.ui?.carrier||r.carrier||'Unlocked',
        icloud_lock:r.icloud_lock_on?'ON':'OFF', condition_hint:r.condition_hint||'', estimated_purchase_date:r.estimated_purchase_date||'',
        quantity:1, unit_price_cents:cents, line_total_cents:cents, suggested_price_cents:'', notes: document.querySelector('.note[data-idx="'+idx+'"]')?.value||''
      });
    });
    const header=['manual','used','used_source','identifier','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','condition_hint','estimated_purchase_date','quantity','unit_price_cents','line_total_cents','suggested_price_cents','notes'];
    const lines=[header.join(',')];
    payload.forEach(o=>lines.push(header.map(k=>JSON.stringify((o[k]!=null?String(o[k]):'').replace(/^\uFEFF/,''))).join(',')));
    const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='intake_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
}

/* ---- Global delegated click for chips ---- */
(function setupChipClicks(){
  const menu=document.getElementById('menu');
  document.addEventListener('click', async function(e){
    const chip = e.target.closest && e.target.closest('.chip');
    if (chip) { e.preventDefault(); await openMenuFor(chip, menu); return; }
    if (!menu.contains(e.target)) menu.classList.remove('show');
  });
})();

async function openMenuFor(target, menu){
  const kind=target.getAttribute('data-kind');
  const rowkind=target.getAttribute('data-rowkind');
  const idx=parseInt(target.getAttribute('data-idx'),10);
  const row = rowkind==='api' ? state.rows[idx] : state.manual[idx];
  if(!row) return;

  let items=[]; if(kind==='cond') items=['New','Used']; if(kind==='car') items=CARRIERS.slice(); if(kind==='store') items=STORAGES.slice();
  menu.innerHTML = items.map(v=>`<div class="menu-item" data-v="${v}">${v}</div>`).join('');
  const rect=target.getBoundingClientRect(); menu.style.left=(window.scrollX+rect.left)+'px'; menu.style.top=(window.scrollY+rect.bottom+6)+'px'; menu.classList.add('show');

  Array.from(menu.querySelectorAll('.menu-item')).forEach(mi=>{
    mi.onclick = async function(){
      const v=mi.getAttribute('data-v');
      row.ui=row.ui||{};
      if(kind==='cond') row.ui.condition=v;
      if(kind==='car') row.ui.carrier=v;
      if(kind==='store') row.ui.storage=v;

      // Make sure variants exist, then recalc and write price
      await ensureVariants(row);
      const autop=autoPriceDollars(row);
      if (autop !== '') setUserPrice(row, autop);
      render();
    };
  });
}

/* ---------- Totals ---------- */
function computeTotals(){
  let total=0;
  document.querySelectorAll('.paid').forEach(inp=>{ const v=Number(inp.value||''); if(isFinite(v)) total+=v; });
  document.getElementById('totals').innerText='Total: $'+Math.round(total);
}

/* ---------- Submit IMEIs ---------- */
document.getElementById('form').onsubmit = async function(e){
  e.preventDefault();
  const raw=document.getElementById('imeis').value||''; const imeis=raw.split(/[\s,;\n\r]+/).map(s=>s.trim()).filter(Boolean).slice(0,200);
  if(!imeis.length) return;
  const loader=document.getElementById('loader'); const btn=document.getElementById('lookupBtn');
  loader.classList.add('show'); btn.disabled=true; btn.innerText='Looking up…';
  try{
    const res=await fetch('/api/intake',{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ imeis }) });
    const data=await res.json(); if(!res.ok) throw new Error(data.error||'Lookup failed');
    state.rows=(data.items||[]).map(x=>{ x.ui=x.ui||{ condition:x.used?'Used':'New', carrier:(x.carrier && CARRIERS.includes(x.carrier))?x.carrier:'Unlocked', storage:x.storage||'' }; return x; });
    // Ensure all rows have variants & set initial "Price Paid"
    await Promise.all(state.rows.map(async (r)=>{ await ensureVariants(r); const v=autoPriceDollars(r); if(v!==''){ setUserPrice(r, v); } else if(typeof r.suggested_price_dollars==='number'){ setUserPrice(r, r.suggested_price_dollars); } }));
    render();
  }catch(err){ alert(String(err && err.message ? err.message : err)); console.error(err); }
  finally{ loader.classList.remove('show'); btn.disabled=false; btn.innerText='Lookup & Price'; }
};
</script>
</body>
</html>
