<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory Intake (Cloudflare Pages)</title>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e6f1ff; margin:0; }
  .wrap { max-width: 1100px; margin: 20px auto; padding: 16px; background:#0f141a; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); position: relative; }
  h1 { margin-top:0; }
  textarea { width:100%; min-height: 140px; border-radius:10px; padding:10px; background:#0d1218; color:#def; border:1px solid #213244; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .btn { background:#00e29b; color:#062612; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#18344a; color:#bfeaff; }
  .muted { opacity:.7; font-size: 13px; }
  table { width:100%; border-collapse: collapse; margin-top: 16px; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #213244; vertical-align: top; }
  th { text-align:left; color:#bfeaff; }
  input[type="text"], input[type="number"] { background:#0d1218; color:#def; border:1px solid #213244; border-radius:8px; padding:8px; width:100%; }
  select { background:#0d1218; color:#def; border:1px solid #213244; border-radius:8px; padding:8px; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; background:#1b2a3a; color:#bfeaff; font-size:12px; }
  .tag.red { background:#3a1b1b; color:#ffbfbf; }
  .tag.yellow { background:#3a321b; color:#ffe4a6; }
  .tag.green { background:#1b3a2a; color:#bfffd4; }
  .right { text-align:right; }
  .totals { margin-top:12px; font-weight:700; }
  /* loader */
  .loader { position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; border-radius:14px; }
  .loader.show { display:flex; }
  .spinner { width:42px; height:42px; border:5px solid #1b2a3a; border-top-color:#00e29b; border-radius:50%; animation: spin 0.9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* typeahead */
  .typeahead { position: relative; flex: 2 1 260px; }
  .suggestions {
    position: absolute; top: 100%; left: 0; right: 0;
    background: #0d1218; border: 1px solid #213244; border-radius: 10px;
    margin-top: 6px; max-height: 320px; overflow-y: auto; z-index: 50;
    box-shadow: 0 10px 25px rgba(0,0,0,.35);
  }
  .sug-item {
    padding: 10px; cursor: pointer; display:flex; align-items: center; justify-content: space-between; gap: 10px;
  }
  .sug-item:hover, .sug-item.active { background: #13202d; }
  .sug-left { display:flex; flex-direction: column; }
  .sug-device { font-weight: 600; color:#dff3ff; }
  .sug-sheet { font-size: 12px; color:#9ac7ff; opacity:.8; }
  .sug-price { font-weight: 700; }
</style>
</head>
<body>
<div class="wrap">
  <div id="loader" class="loader"><div><div class="spinner" style="margin:auto"></div><div class="muted" style="margin-top:10px;text-align:center">Looking up IMEIs…</div></div></div>

  <h1>Inventory Intake (Pages Functions)</h1>
  <p class="muted">Add a trailing <b>“u”</b> after an IMEI to mark it as <b>Used</b> (we won’t send the “u” to Sickw). Unlocked iPhones use “iPhone New Unlocked”; Used devices use brand-specific <b>USED</b> pages.</p>

  <div id="balance" class="muted"></div>

  <form id="form">
    <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
    <textarea id="imeis" placeholder="354442067957452u&#10;353052118765432&#10;..."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="lookupBtn" type="submit">Lookup & Price</button>
      <button class="btn secondary" id="reset" type="button">Reset</button>
      <span class="muted">We’ll pre-fill <b>Price Paid ($)</b> with whole dollars from your site CSV.</span>
    </div>
  </form>

  <h3 style="margin-top:20px;">Add Manual Item</h3>
  <div class="row">
    <div class="typeahead">
      <input type="text" id="m_device" placeholder="Start typing (e.g., AirPods Pro 2, iPhone 13 Mini 128GB)" autocomplete="off" />
      <div id="m_suggest" class="suggestions" style="display:none;"></div>
    </div>
    <input type="text" id="m_color" placeholder="Color" style="flex: 1 1 140px;" />
    <input type="text" id="m_storage" placeholder="Storage (e.g., 256GB)" style="flex: 1 1 140px;" />
    <select id="m_carrier">
      <option value="Unknown">Carrier</option>
      <option>Unlocked</option>
      <option>Verizon</option>
      <option>T-Mobile</option>
      <option>AT&T</option>
      <option>Xfinity</option>
      <option>Spectrum</option>
      <option>US Cellular</option>
      <option>Cricket</option>
    </select>
    <input type="number" id="m_qty" placeholder="Qty" min="1" step="1" value="1" style="width:90px" />
    <input type="number" id="m_price" placeholder="Unit Price ($)" min="0" step="1" style="width:140px" />
    <button class="btn" id="addManual">Add</button>
  </div>

  <div id="out"></div>
  <div class="totals" id="totals"></div>
</div>

<script>
async function fetchBalance() {
  try {
    const r = await fetch('/api/balance');
    const j = await r.json();
    const val = (j.balance || '').toString().trim();
    let text = 'API Balance: ';
    text += val && !isNaN(Number(val)) ? '<span class="tag">$' + val + '</span>' : '<span class="tag red">' + (val || '—') + '</span>';
    document.getElementById('balance').innerHTML = text;
  } catch (e) {}
}
fetchBalance();

var state = { rows: [], manual: [] };

/* ---------- Manual item typeahead ---------- */
(function setupTypeahead() {
  var input = document.getElementById('m_device');
  var box   = document.getElementById('m_suggest');
  var activeIdx = -1;
  var lastQ = ""; var inflight = 0;

  function hide() { box.style.display = 'none'; box.innerHTML = ''; activeIdx = -1; }
  function show() { box.style.display = 'block'; }

  function parseColorAndStorage(deviceText) {
    var COLORS = ["Black","White","Blue","Pink","Purple","Gold","Desert","Titanium","Natural","Green","Red","Yellow","Silver","Midnight","Starlight"];
    var color = null;
    var upper = deviceText.toUpperCase();
    for (var i=0;i<COLORS.length;i++) {
      var c = COLORS[i];
      var re = new RegExp("\\b" + c.toUpperCase() + "\\b");
      if (re.test(upper)) { color = c; break; }
    }
    var storage = null;
    var m = upper.match(/(\d{2,4})\s*GB\b/);
    if (m) storage = m[1] + "GB";
    return { color: color, storage: storage };
  }

  function selectItem(obj) {
    input.value = obj.device;
    var parsed = parseColorAndStorage(obj.device);
    if (parsed.color && !document.getElementById('m_color').value) document.getElementById('m_color').value = parsed.color;
    if (parsed.storage && !document.getElementById('m_storage').value) document.getElementById('m_storage').value = parsed.storage;
    document.getElementById('m_price').value = obj.price_dollars || 0;
    hide();
  }

  function renderList(arr) {
    if (!arr.length) { hide(); return; }
    var html = arr.map(function(r, i) {
      return '<div class="sug-item" data-idx="'+i+'">'
        + '<div class="sug-left">'
        +   '<div class="sug-device">'+ r.device +'</div>'
        +   '<div class="sug-sheet">'+ (r.sheet || '') +'</div>'
        + '</div>'
        + '<div class="sug-price">$'+ (r.price_dollars || 0) +'</div>'
        + '</div>';
    }).join('');
    box.innerHTML = html;
    Array.prototype.forEach.call(box.querySelectorAll('.sug-item'), function(el) {
      el.addEventListener('mousedown', function(e) {
        e.preventDefault();
        var idx = parseInt(el.getAttribute('data-idx'), 10);
        selectItem(arr[idx]);
      });
    });
    show();
  }

  function debounce(fn, ms) {
    var t; return function(){ clearTimeout(t); var args=arguments; t=setTimeout(function(){ fn.apply(null,args); }, ms); };
  }

  var doFetch = debounce(async function(q) {
    if (!q || q.length < 2) { hide(); return; }
    if (q === lastQ) return;
    lastQ = q;
    var myTicket = ++inflight;
    try {
      const res = await fetch('/api/search?q=' + encodeURIComponent(q) + '&limit=20');
      const data = await res.json();
      if (inflight !== myTicket) return; // out-of-order guard
      renderList((data && data.results) ? data.results : []);
    } catch (e) {
      hide();
    }
  }, 180);

  input.addEventListener('input', function() {
    var q = input.value.trim();
    doFetch(q);
  });

  input.addEventListener('keydown', function(e) {
    var items = box.querySelectorAll('.sug-item');
    if (box.style.display === 'none' || !items.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIdx = (activeIdx + 1) % items.length;
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIdx = (activeIdx - 1 + items.length) % items.length;
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIdx >= 0 && activeIdx < items.length) {
        var idx = parseInt(items[activeIdx].getAttribute('data-idx'), 10);
        var results = Array.from(items).map(function(it){
          return {
            device: it.querySelector('.sug-device').textContent,
            sheet:  it.querySelector('.sug-sheet').textContent,
            price_dollars: Number(it.querySelector('.sug-price').textContent.replace(/^\D+/, '')) || 0
          };
        });
        selectItem(results[activeIdx]);
      }
    } else if (e.key === 'Escape') {
      hide();
    }
    Array.prototype.forEach.call(items, function(el, i){
      if (i === activeIdx) el.classList.add('active'); else el.classList.remove('active');
    });
  });

  input.addEventListener('blur', function() { setTimeout(hide, 120); });
})();

/* ---------- Existing rendering / download / totals ---------- */
function render() {
  var rows = state.rows;
  var mrows = state.manual;

  var el = document.getElementById('out');
  var table = [];
  table.push('<table><thead><tr>'
    + '<th>IMEI</th>'
    + '<th>Device</th>'
    + '<th>Color</th>'
    + '<th>Storage</th>'
    + '<th>Carrier</th>'
    + '<th>Matched (Sheet)</th>'
    + '<th class="right">Price Paid ($)</th>'
    + '<th>Qty</th>'
    + '<th>Notes</th>'
    + '</tr></thead><tbody>');

  rows.forEach(function(r, idx) {
    if (!r.ok) {
      table.push('<tr><td colspan="9" class="err">IMEI ' + r.imei + ' → ' + (r.error || 'error') + '</td></tr>');
      return;
    }
    var warnIcloud = r.icloud_lock_on ? '<span class="tag red">iCloud Lock: ON</span>' : '';
    var hint = r.condition_hint === 'assume_used'
      ? '<span class="tag red">Assume Used</span>'
      : (r.condition_hint === 'check_for_use' ? '<span class="tag yellow">Check for signs of use</span>' : '');
    var usedTag = r.used ? '<span class="tag green">Used</span>' : '';

    var purchInfo = r.estimated_purchase_date
      ? '<div class="muted">Est. Purchase: ' + r.estimated_purchase_date + (typeof r.estimated_purchase_age_days === 'number' ? ' (' + r.estimated_purchase_age_days + 'd ago)' : '') + '</div>'
      : '';

    var display = (r.device_display || ((r.manufacturer || '') + ' ' + (r.model_name || ''))).trim();
    var paidDollars = (typeof r.suggested_price_dollars === 'number') ? r.suggested_price_dollars : '';

    table.push('<tr>'
      + '<td><code>' + r.imei + '</code></td>'
      + '<td>' + display
        + (warnIcloud ? ('<div>' + warnIcloud + '</div>') : '')
        + (hint ? ('<div>' + hint + '</div>') : '')
        + (usedTag ? ('<div>' + usedTag + '</div>') : '')
        + (purchInfo || '')
      + '</td>'
      + '<td>' + (r.color || '') + '</td>'
      + '<td>' + (r.storage || '') + '</td>'
      + '<td><span class="tag">' + (r.carrier || 'Unknown') + '</span></td>'
      + '<td><div>' + (r.match_device || '—') + '</div><div class="muted">' + (r.match_sheet || '') + '</div></td>'
      + '<td class="right"><input type="number" class="paid" data-kind="api" data-idx="' + idx + '" value="' + paidDollars + '" step="1" min="0" /></td>'
      + '<td class="right">1</td>'
      + '<td><input type="text" class="note" data-kind="api" data-idx="' + idx + '" /></td>'
      + '</tr>');
  });

  mrows.forEach(function(r, idx) {
    table.push('<tr>'
      + '<td><em class="muted">manual</em></td>'
      + '<td>' + (r.device || '') + '</td>'
      + '<td>' + (r.color || '') + '</td>'
      + '<td>' + (r.storage || '') + '</td>'
      + '<td><span class="tag">' + (r.carrier || 'Unknown') + '</span></td>'
      + '<td><div class="muted">—</div></td>'
      + '<td class="right"><input type="number" class="mpaid" data-idx="' + idx + '" value="' + (r.unitPrice || '') + '" step="1" min="0" /></td>'
      + '<td class="right"><input type="number" class="mqty" data-idx="' + idx + '" value="' + (r.qty || 1) + '" step="1" min="1" style="width:80px"/></td>'
      + '<td><input type="text" class="mnote" data-idx="' + idx + '" value="' + (r.notes || '') + '" /></td>'
      + '</tr>');
  });

  table.push('</tbody></table>'
    + '<div class="row" style="margin-top:12px;">'
    + '  <button class="btn" id="download">Download CSV</button>'
    + '  <span class="muted">CSV exports price paid in <b>cents</b>, includes <b>quantity</b> & <b>line total</b>, and marks <b>used</b>.</span>'
    + '</div>');

  el.innerHTML = table.join('');

  Array.prototype.forEach.call(document.querySelectorAll('.paid,.mpaid,.mqty'), function(inp) {
    inp.addEventListener('input', computeTotals);
  });

  document.getElementById('download').onclick = function() {
    var payload = [];
    state.rows.forEach(function(r, idx) {
      if (!r.ok) return;
      var paidEl = document.querySelector('.paid[data-kind="api"][data-idx="' + idx + '"]');
      var noteEl = document.querySelector('.note[data-kind="api"][data-idx="' + idx + '"]');
      var dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
      var cents = isFinite(dollars) ? Math.round(dollars * 100) : '';
      var note = noteEl ? noteEl.value : '';
      payload.push({
        manual: 'no',
        used: r.used ? 'yes' : 'no',
        used_source: r.used_source || '',
        imei: r.imei,
        manufacturer: r.manufacturer || '',
        model_name: r.model_name || '',
        model_code: r.model_code || '',
        device: r.device_display || '',
        color: r.color || '',
        storage: r.storage || '',
        carrier: r.carrier || 'Unknown',
        icloud_lock: r.icloud_lock_on ? 'ON' : 'OFF',
        condition_hint: r.condition_hint || '',
        estimated_purchase_date: r.estimated_purchase_date || '',
        quantity: 1,
        unit_price_cents: cents,
        line_total_cents: cents,
        suggested_price_cents: (typeof r.suggested_price_cents !== 'undefined' ? r.suggested_price_cents : ''),
        notes: (note || '').trim()
      });
    });
    state.manual.forEach(function(r, idx) {
      var paidEl = document.querySelector('.mpaid[data-idx="' + idx + '"]');
      var qtyEl  = document.querySelector('.mqty[data-idx="' + idx + '"]');
      var noteEl = document.querySelector('.mnote[data-idx="' + idx + '"]');
      var dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
      var qty = Number((qtyEl && qtyEl.value) ? qtyEl.value : '1');
      var cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
      payload.push({
        manual: 'yes',
        used: '', used_source: '',
        imei: '',
        manufacturer: '',
        model_name: '',
        model_code: '',
        device: r.device || '',
        color: r.color || '',
        storage: r.storage || '',
        carrier: r.carrier || 'Unknown',
        icloud_lock: '',
        condition_hint: '',
        estimated_purchase_date: '',
        quantity: qty,
        unit_price_cents: cents,
        line_total_cents: cents * Math.max(1, qty),
        suggested_price_cents: '',
        notes: noteEl ? noteEl.value : ''
      });
    });

    var header = ['manual','used','used_source','imei','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','condition_hint','estimated_purchase_date','quantity','unit_price_cents','line_total_cents','suggested_price_cents','notes'];
    var lines = [header.join(',')];
    payload.forEach(function(o) {
      var row = header.map(function(k) {
        var v = (o[k] != null) ? String(o[k]) : '';
        return JSON.stringify(v).replace(/^\uFEFF/, '');
      }).join(',');
      lines.push(row);
    });
    var csv = lines.join('\n');

    var blob = new Blob([csv], { type:'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'intake_export.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  computeTotals();
}

function computeTotals() {
  var totalDollars = 0;
  Array.prototype.forEach.call(document.querySelectorAll('.paid'), function(inp) {
    var v = Number(inp.value || '');
    if (isFinite(v)) totalDollars += v;
  });
  state.manual.forEach(function(r, idx) {
    var paidEl = document.querySelector('.mpaid[data-idx="' + idx + '"]');
    var qtyEl  = document.querySelector('.mqty[data-idx="' + idx + '"]');
    var dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
    var qty = Number((qtyEl && qtyEl.value) ? qtyEl.value : '1');
    if (isFinite(dollars) && isFinite(qty)) totalDollars += dollars * Math.max(1, qty);
  });
  document.getElementById('totals').innerText = 'Total: $' + Math.round(totalDollars);
}

document.getElementById('reset').onclick = function() {
  document.getElementById('imeis').value = '';
  state.rows = [];
  state.manual = [];
  document.getElementById('out').innerHTML = '';
  document.getElementById('totals').innerText = '';
};

document.getElementById('addManual').onclick = function(e) {
  e.preventDefault();
  var device  = document.getElementById('m_device').value.trim();
  var color   = document.getElementById('m_color').value.trim();
  var storage = document.getElementById('m_storage').value.trim();
  var carrier = document.getElementById('m_carrier').value || 'Unknown';
  var qty     = Number(document.getElementById('m_qty').value || '1');
  var unitPrice = Number(document.getElementById('m_price').value || '');
  if (!device) return;
  state.manual.push({
    device: device, color: color, storage: storage, carrier: carrier,
    qty: Math.max(1, qty), unitPrice: isFinite(unitPrice) ? unitPrice : 0, notes: ''
  });
  render();
};

document.getElementById('form').onsubmit = async function(e) {
  e.preventDefault();
  var raw = document.getElementById('imeis').value || '';
  var imeis = raw.split(/[\s,;\n\r]+/).map(function(s){ return s.trim(); }).filter(Boolean).slice(0,200);
  if (!imeis.length) return;

  var loader = document.getElementById('loader');
  var btn = document.getElementById('lookupBtn');
  loader.classList.add('show'); btn.disabled = true; btn.innerText = 'Looking up…';

  try {
    const res = await fetch('/api/intake', {
      method: 'POST',
      headers: { 'content-type':'application/json' },
      body: JSON.stringify({ imeis: imeis })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Lookup failed');
    state.rows = data.items || [];
    render();
  } catch (err) {
    alert(String(err && err.message ? err.message : err));
    console.error(err);
  } finally {
    loader.classList.remove('show'); btn.disabled = false; btn.innerText = 'Lookup & Price';
  }
};
</script>
</body>
</html>
