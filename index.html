<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory Intake (Cloudflare Pages)</title>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e6f1ff; margin:0; }
  .wrap { max-width: 1100px; margin: 20px auto; padding: 16px; background:#0f141a; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); position: relative; }
  h1 { margin-top:0; }
  textarea { width:100%; min-height: 140px; border-radius:10px; padding:10px; background:#0d1218; color:#def; border:1px solid #213244; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .btn { background:#00e29b; color:#062612; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .btn.secondary { background:#18344a; color:#bfeaff; }
  .muted { opacity:.7; font-size: 13px; }
  table { width:100%; border-collapse: collapse; margin-top: 16px; }
  th, td { padding: 10px 8px; border-bottom: 1px solid #213244; vertical-align: top; }
  th { text-align:left; color:#bfeaff; }
  input[type="text"], input[type="number"] { background:#0d1218; color:#def; border:1px solid #213244; border-radius:8px; padding:8px; width:100%; }
  select { background:#0d1218; color:#def; border:1px solid #213244; border-radius:8px; padding:8px; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; background:#1b2a3a; color:#bfeaff; font-size:12px; }
  .tag.red { background:#3a1b1b; color:#ffbfbf; }
  .tag.yellow { background:#3a321b; color:#ffe4a6; }
  .tag.green { background:#1b3a2a; color:#bfffd4; }
  .right { text-align:right; }
  .totals { margin-top:12px; font-weight:700; }
  /* loader */
  .loader { position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; border-radius:14px; }
  .loader.show { display:flex; }
  .spinner { width:42px; height:42px; border:5px solid #1b2a3a; border-top-color:#00e29b; border-radius:50%; animation: spin 0.9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  /* typeahead */
  .typeahead { position: relative; flex: 2 1 260px; }
  .suggestions {
    position: absolute; top: 100%; left: 0; right: 0;
    background: #0d1218; border: 1px solid #213244; border-radius: 10px;
    margin-top: 6px; max-height: 320px; overflow-y: auto; z-index: 50;
    box-shadow: 0 10px 25px rgba(0,0,0,.35);
  }
  .sug-item { padding: 10px; cursor: pointer; display:flex; align-items: center; justify-content: space-between; gap: 10px; }
  .sug-item:hover, .sug-item.active { background: #13202d; }
  .sug-left { display:flex; flex-direction: column; }
  .sug-device { font-weight: 600; color:#dff3ff; }
  .sug-sheet { font-size: 12px; color:#9ac7ff; opacity:.8; }
  .sug-price { font-weight: 700; }
  /* identifier validation highlight */
  .bad { border-color:#b44 !important; box-shadow: 0 0 0 2px rgba(255,64,64,.18); }

  /* Hide the 'Matched (Sheet)' column by default */
  th:nth-child(6), td:nth-child(6) { display: none; }
</style>
</head>
<body>
<div class="wrap">
  <div id="loader" class="loader"><div><div class="spinner" style="margin:auto"></div><div class="muted" style="margin-top:10px;text-align:center">Looking up IMEIs…</div></div></div>

  <h1>Inventory Intake (Pages Functions)</h1>
  <p class="muted">Add a trailing <b>“u”</b> after an IMEI to mark it as <b>Used</b> (we won’t send the “u” to Sickw). Unlocked iPhones use “iPhone New Unlocked”; Used devices use brand-specific <b>USED</b> pages.</p>

  <div id="balance" class="muted"></div>

  <form id="form">
    <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
    <textarea id="imeis" placeholder="354442067957452u&#10;353052118765432&#10;..."></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="lookupBtn" type="submit">Lookup & Price</button>
      <button class="btn secondary" id="reset" type="button">Reset</button>
      <span class="muted">We’ll pre-fill <b>Price Paid ($)</b> with whole dollars from your site CSV.</span>
    </div>
  </form>

  <h3 style="margin-top:20px;">Add Manual Item</h3>
  <div class="row">
    <div class="typeahead" style="flex: 3 1 320px;">
      <input type="text" id="m_device" placeholder="Start typing (e.g., AirPods Pro 2, iPhone 13 Mini 128GB)" autocomplete="off" />
      <div id="m_suggest" class="suggestions" style="display:none;"></div>
    </div>

    <!-- Color dynamic search -->
    <div class="typeahead" style="flex: 2 1 220px;">
      <input type="text" id="m_color" placeholder="Color (type to search)" autocomplete="off" />
      <div id="m_color_suggest" class="suggestions" style="display:none;"></div>
    </div>

    <!-- Storage dropdown (narrow) -->
    <select id="m_storage" style="width: 120px;">
      <option value="">Storage</option>
      <option>64GB</option>
      <option>128GB</option>
      <option>256GB</option>
      <option>512GB</option>
      <option>1TB</option>
      <option>2TB</option>
    </select>

    <select id="m_carrier">
      <option value="Unknown">Carrier</option>
      <option>Unlocked</option><option>Verizon</option><option>T-Mobile</option><option>AT&T</option>
      <option>Xfinity</option><option>Spectrum</option><option>US Cellular</option><option>Cricket</option>
    </select>
    <input type="number" id="m_qty" placeholder="Qty" min="1" step="1" value="1" style="width:90px" />
    <input type="number" id="m_price" placeholder="Unit Price ($)" min="0" step="1" style="width:140px" />
    <button class="btn" id="addManual">Add</button>
  </div>

  <div id="out"></div>
  <div class="totals" id="totals"></div>
</div>

<script>
async function fetchBalance() {
  try {
    const r = await fetch('/api/balance');
    const j = await r.json();
    const val = (j.balance || '').toString().trim();
    let text = 'API Balance: ';
    text += val && !isNaN(Number(val)) ? '<span class="tag">$' + val + '</span>' : '<span class="tag red">' + (val || '—') + '</span>';
    document.getElementById('balance').innerHTML = text;
  } catch (e) {}
}
fetchBalance();

var state = { rows: [], manual: [] };

/* ---------- Color list (Apple + Samsung, 2022+) ---------- */
const COLOR_LIST = Array.from(new Set([
  // Apple 2022+: iPhone 14/14 Plus
  "Midnight","Starlight","Blue","Purple","Yellow","(PRODUCT)RED","Red",
  // iPhone 14 Pro/Max
  "Deep Purple","Space Black","Silver","Gold",
  // iPhone 15/15 Plus
  "Black","Light Blue","Light Green","Light Yellow","Light Pink","Pink","Green","Yellow",
  // iPhone 15 Pro/Max
  "Natural Titanium","Blue Titanium","White Titanium","Black Titanium","Titanium",
  // iPhone 16/Pro (as used in your data)
  "Desert","Desert Titanium","Natural",
  // Samsung S22 family
  "Phantom Black","Phantom White","Green","Pink Gold","Burgundy","Graphite","Sky Blue","Red",
  // Samsung S23 family
  "Cream","Lavender","Lime",
  // Samsung S24 family
  "Onyx Black","Marble Gray","Cobalt Violet","Amber Yellow",
  "Titanium Black","Titanium Gray","Titanium Violet","Titanium Yellow","Titanium Blue","Titanium Green","Titanium Orange"
])).sort((a,b)=>a.localeCompare(b));

/* ---------- Device typeahead (from /api/search) ---------- */
(function setupDeviceTypeahead() {
  var input = document.getElementById('m_device');
  var box   = document.getElementById('m_suggest');
  var activeIdx = -1;
  var lastQ = ""; var inflight = 0;

  function hide() { box.style.display = 'none'; box.innerHTML = ''; activeIdx = -1; }
  function show() { box.style.display = 'block'; }

  function setStorageFromText(storageText) {
    if (!storageText) return;
    var val = storageText.toUpperCase().replace(/\s+/g,'').replace(/B$/, 'B'); // e.g., 256GB
    var select = document.getElementById('m_storage');
    for (var i=0;i<select.options.length;i++) {
      if (select.options[i].text.toUpperCase() === val) { select.selectedIndex = i; return; }
    }
  }

  function parseColorAndStorage(deviceText) {
    var upper = (deviceText || '').toUpperCase();
    // Storage
    var storage = null;
    var m = upper.match(/(64|128|256|512|1024|2048)\s*GB\b|\b(1|2)\s*TB\b/);
    if (m) {
      if (m[1]) storage = m[1] + "GB";
      else if (m[2]) storage = m[2] + "TB";
    }
    // Color: pick first match from COLOR_LIST
    var color = null;
    for (var i=0;i<COLOR_LIST.length;i++) {
      var c = COLOR_LIST[i];
      var re = new RegExp('(^|\\s)'+c.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')+'(\\s|$)', 'i');
      if (re.test(deviceText)) { color = c; break; }
    }
    return { color: color, storage: storage };
  }

  function selectItem(obj) {
    input.value = obj.device;
    var parsed = parseColorAndStorage(obj.device);
    if (parsed.color && !document.getElementById('m_color').value) document.getElementById('m_color').value = parsed.color;
    if (parsed.storage) setStorageFromText(parsed.storage);
    document.getElementById('m_price').value = obj.price_dollars || 0;
    hide();
  }

  function renderList(arr) {
    if (!arr.length) { hide(); return; }
    var html = arr.map(function(r, i) {
      return '<div class="sug-item" data-idx="'+i+'">'
        + '<div class="sug-left"><div class="sug-device">'+ r.device +'</div><div class="sug-sheet">'+ (r.sheet || '') +'</div></div>'
        + '<div class="sug-price">$'+ (r.price_dollars || 0) +'</div></div>';
    }).join('');
    box.innerHTML = html;
    Array.prototype.forEach.call(box.querySelectorAll('.sug-item'), function(el) {
      el.addEventListener('mousedown', function(e) {
        e.preventDefault();
        var idx = parseInt(el.getAttribute('data-idx'), 10);
        selectItem(arr[idx]);
      });
    });
    show();
  }

  function debounce(fn, ms) { var t; return function(){ clearTimeout(t); var args=arguments; t=setTimeout(function(){ fn.apply(null,args); }, ms); }; }

  var doFetch = debounce(async function(q) {
    if (!q || q.length < 2) { hide(); return; }
    if (q === lastQ) return;
    lastQ = q;
    var myTicket = ++inflight;
    try {
      const res = await fetch('/api/search?q=' + encodeURIComponent(q) + '&limit=20');
      const data = await res.json();
      if (inflight !== myTicket) return;
      renderList((data && data.results) ? data.results : []);
    } catch (e) { hide(); }
  }, 180);

  input.addEventListener('input', function() { doFetch(input.value.trim()); });

  input.addEventListener('keydown', function(e) {
    var items = box.querySelectorAll('.sug-item');
    if (box.style.display === 'none' || !items.length) return;
    if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = (activeIdx + 1) % items.length; }
    else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = (activeIdx - 1 + items.length) % items.length; }
    else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIdx >= 0 && activeIdx < items.length) {
        var idx = parseInt(items[activeIdx].getAttribute('data-idx'), 10);
        var it = items[activeIdx];
        selectItem({
          device: it.querySelector('.sug-device').textContent,
          sheet:  it.querySelector('.sug-sheet').textContent,
          price_dollars: Number(it.querySelector('.sug-price').textContent.replace(/^\D+/, '')) || 0
        });
      }
    } else if (e.key === 'Escape') { hide(); }
    Array.prototype.forEach.call(items, function(el, i){ if (i === activeIdx) el.classList.add('active'); else el.classList.remove('active'); });
  });

  input.addEventListener('blur', function() { setTimeout(hide, 120); });
})();

/* ---------- Color typeahead (local list) ---------- */
(function setupColorTypeahead() {
  var input = document.getElementById('m_color');
  var box   = document.getElementById('m_color_suggest');
  var activeIdx = -1;
  function hide() { box.style.display = 'none'; box.innerHTML = ''; activeIdx = -1; }
  function show() { box.style.display = 'block'; }

  function filterColors(q) {
    if (!q) return COLOR_LIST.slice(0, 20);
    q = q.toLowerCase();
    return COLOR_LIST
      .map(c => ({ c, score: (c.toLowerCase().startsWith(q) ? 2 : (c.toLowerCase().includes(q) ? 1 : 0)) }))
      .filter(x => x.score > 0)
      .sort((a,b) => b.score - a.score || a.c.localeCompare(b.c))
      .slice(0, 20)
      .map(x => x.c);
  }

  function renderList(arr) {
    if (!arr.length) { hide(); return; }
    var html = arr.map((name, i) => '<div class="sug-item" data-idx="'+i+'"><div>'+name+'</div></div>').join('');
    box.innerHTML = html;
    Array.prototype.forEach.call(box.querySelectorAll('.sug-item'), function(el) {
      el.addEventListener('mousedown', function(e) {
        e.preventDefault();
        var idx = parseInt(el.getAttribute('data-idx'), 10);
        input.value = arr[idx];
        hide();
      });
    });
    show();
  }

  input.addEventListener('input', function() {
    var q = input.value.trim();
    renderList(filterColors(q));
  });

  input.addEventListener('keydown', function(e) {
    var items = box.querySelectorAll('.sug-item');
    if (box.style.display === 'none' || !items.length) return;
    if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = (activeIdx + 1) % items.length; }
    else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = (activeIdx - 1 + items.length) % items.length; }
    else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIdx >= 0 && activeIdx < items.length) {
        var idx = parseInt(items[activeIdx].getAttribute('data-idx'), 10);
        input.value = items[idx].innerText.trim();
        hide();
      }
    } else if (e.key === 'Escape') { hide(); }
    Array.prototype.forEach.call(items, function(el, i){ if (i === activeIdx) el.classList.add('active'); else el.classList.remove('active'); });
  });

  input.addEventListener('focus', function() {
    if (!input.value.trim()) renderList(filterColors(''));
  });

  input.addEventListener('blur', function() { setTimeout(hide, 120); });
})();


/* ---------- Helpers for editable API rows ---------- */
function ensureColorDatalist() {
  if (!document.getElementById('colorlist')) {
    var dl = document.createElement('datalist');
    dl.id = 'colorlist';
    (COLOR_LIST || []).forEach(function(c){
      var opt = document.createElement('option');
      opt.value = c;
      dl.appendChild(opt);
    });
    document.body.appendChild(dl);
  }
}
function escapeHtml(s) {
  return String(s == null ? '' : s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
function parseColorAndStorageFromText(deviceText) {
  var upper = (deviceText || '').toUpperCase();
  var storage = null;
  var m = upper.match(/(64|128|256|512|1024|2048)\s*GB\b|\b(1|2)\s*TB\b/);
  if (m) {
    if (m[1]) storage = m[1] + "GB";
    else if (m[2]) storage = m[2] + "TB";
  }
  var color = null;
  for (var i=0;i<COLOR_LIST.length;i++) {
    var c = COLOR_LIST[i];
    var re = new RegExp('(^|\\s)'+c.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')+'(\\s|$)', 'i');
    if (re.test(deviceText)) { color = c; break; }
  }
  return { color: color, storage: storage };
}
var STORAGE_OPTIONS = ["","64GB","128GB","256GB","512GB","1TB","2TB"];
var CARRIER_OPTIONS = ["Unknown","Unlocked","Verizon","T-Mobile","AT&T","Xfinity","Spectrum","US Cellular","Cricket"];

function makeEditableRows() {
  ensureColorDatalist();
  // For each API row (identified by the .paid[data-kind="api"] input), swap read-only cells for inputs/selects.
  var paidInputs = Array.prototype.slice.call(document.querySelectorAll('.paid[data-kind="api"]'));
  paidInputs.forEach(function(inp){
    var idx = Number(inp.getAttribute('data-idx'));
    if (!isFinite(idx) || !state.rows || !state.rows[idx] || !state.rows[idx].ok) return;
    var r = state.rows[idx];
    var tr = inp.closest('tr');
    if (!tr) return;
    var tds = tr.querySelectorAll('td');
    if (!tds || tds.length < 9) return;

    // Cells: 0 Identifier | 1 Device | 2 Color | 3 Storage | 4 Carrier | 5 Matched (hidden) | 6 Price | 7 Qty | 8 Notes

    // Device cell: text input + original warning tags
    var deviceCell = tds[1];
    var display = (r.device_display || ((r.manufacturer || '') + ' ' + (r.model_name || ''))).trim();
    var warnIcloud = r.icloud_lock_on ? '<div class="tag red">iCloud Lock: ON</div>' : '';
    var hint = r.condition_hint === 'assume_used' ? '<div class="tag red">Assume Used</div>'
              : (r.condition_hint === 'check_for_use' ? '<div class="tag yellow">Check for signs of use</div>' : '');
    var usedTag = r.used ? '<div class="tag green">Used</div>' : '';
    var purchInfo = r.estimated_purchase_date ? ('<div class="muted">Est. Purchase: ' + r.estimated_purchase_date + (typeof r.estimated_purchase_age_days === 'number' ? ' (' + r.estimated_purchase_age_days + 'd ago)' : '') + '</div>') : '';
    deviceCell.innerHTML = '<input type="text" class="adev" data-idx="'+idx+'" value="'+escapeHtml(display)+'" style="width:100%;margin-bottom:6px" />'
                         + warnIcloud + hint + usedTag + purchInfo;

    // Color cell: input with datalist
    var colorCell = tds[2];
    var curColor = r.color || '';
    colorCell.innerHTML = '<input type="text" class="acolor" list="colorlist" data-idx="'+idx+'" value="'+escapeHtml(curColor)+'" style="width:100%" />';

    // Storage cell: select
    var storageCell = tds[3];
    var curStorage = (r.storage || '').toUpperCase();
    var storageHtml = '<select class="astorage" data-idx="'+idx+'" style="width:100%;">';
    STORAGE_OPTIONS.forEach(function(opt){
      var sel = (opt.toUpperCase() === curStorage) ? ' selected' : '';
      storageHtml += '<option'+sel+'>' + opt + '</option>';
    });
    storageHtml += '</select>';
    storageCell.innerHTML = storageHtml;

    // Carrier cell: select
    var carrierCell = tds[4];
    var curCarrier = (r.carrier || 'Unknown');
    var carrierHtml = '<select class="acarrier" data-idx="'+idx+'" style="width:100%;">';
    CARRIER_OPTIONS.forEach(function(opt){
      var sel = (opt === curCarrier) ? ' selected' : '';
      carrierHtml += '<option'+sel+'>' + opt + '</option>';
    });
    carrierHtml += '</select>';
    carrierCell.innerHTML = carrierHtml;
  });

  // Wire listeners (update state.rows live)
  Array.prototype.forEach.call(document.querySelectorAll('.adev'), function(el){
    el.addEventListener('change', function(){
      var idx = Number(el.getAttribute('data-idx'));
      if (!isFinite(idx) || !state.rows[idx]) return;
      state.rows[idx].device_display = el.value.trim();

      // Try to auto-fill color/storage if empty
      var parsed = parseColorAndStorageFromText(el.value || '');
      var colorInput = document.querySelector('.acolor[data-idx="'+idx+'"]');
      var storageSelect = document.querySelector('.astorage[data-idx="'+idx+'"]');
      if (parsed.color && (!state.rows[idx].color || !(state.rows[idx].color||'').trim())) {
        state.rows[idx].color = parsed.color;
        if (colorInput) colorInput.value = parsed.color;
      }
      if (parsed.storage && (!state.rows[idx].storage || !(state.rows[idx].storage||'').trim())) {
        state.rows[idx].storage = parsed.storage;
        if (storageSelect) {
          Array.prototype.forEach.call(storageSelect.options, function(o, i){
            if ((o.text || o.value).toUpperCase() === parsed.storage.toUpperCase()) storageSelect.selectedIndex = i;
          });
        }
      }
    });
  });
  Array.prototype.forEach.call(document.querySelectorAll('.acolor'), function(el){
    el.addEventListener('change', function(){
      var idx = Number(el.getAttribute('data-idx'));
      if (!isFinite(idx) || !state.rows[idx]) return;
      state.rows[idx].color = el.value.trim();
    });
  });
  Array.prototype.forEach.call(document.querySelectorAll('.astorage'), function(el){
    el.addEventListener('change', function(){
      var idx = Number(el.getAttribute('data-idx'));
      if (!isFinite(idx) || !state.rows[idx]) return;
      state.rows[idx].storage = el.value.trim();
    });
  });
  Array.prototype.forEach.call(document.querySelectorAll('.acarrier'), function(el){
    el.addEventListener('change', function(){
      var idx = Number(el.getAttribute('data-idx'));
      if (!isFinite(idx) || !state.rows[idx]) return;
      state.rows[idx].carrier = el.value.trim();
    });
  });
}

/* ---------- Render table ---------- */
function render() {
  var rows = state.rows;
  var mrows = state.manual;

  var el = document.getElementById('out');
  var table = [];
  table.push('<table><thead><tr>'
    + '<th>Identifier (IMEI / Serial)</th>'
    + '<th>Device</th>'
    + '<th>Color</th>'
    + '<th>Storage</th>'
    + '<th>Carrier</th>'
    + '<th>Matched (Sheet)</th>'
    + '<th class="right">Price Paid ($)</th>'
    + '<th>Qty</th>'
    + '<th>Notes</th>'
    + '</tr></thead><tbody>');

  /* API rows (identifier = IMEI, qty=1) */
  rows.forEach(function(r, idx) {
    if (!r.ok) {
      table.push('<tr><td colspan="9" class="err">IMEI ' + r.imei + ' → ' + (r.error || 'error') + '</td></tr>');
      return;
    }
    var warnIcloud = r.icloud_lock_on ? '<span class="tag red">iCloud Lock: ON</span>' : '';
    var hint = r.condition_hint === 'assume_used' ? '<span class="tag red">Assume Used</span>'
              : (r.condition_hint === 'check_for_use' ? '<span class="tag yellow">Check for signs of use</span>' : '');
    var usedTag = r.used ? '<span class="tag green">Used</span>' : '';
    var purchInfo = r.estimated_purchase_date ? '<div class="muted">Est. Purchase: ' + r.estimated_purchase_date + (typeof r.estimated_purchase_age_days === 'number' ? ' (' + r.estimated_purchase_age_days + 'd ago)' : '') + '</div>' : '';
    var display = (r.device_display || ((r.manufacturer || '') + ' ' + (r.model_name || ''))).trim();
    var paidDollars = (typeof r.suggested_price_dollars === 'number') ? r.suggested_price_dollars : '';

    table.push('<tr>'
      + '<td><code>' + r.imei + '</code></td>'
      + '<td>' + display + (warnIcloud?'<div>'+warnIcloud+'</div>':'') + (hint?'<div>'+hint+'</div>':'') + (usedTag?'<div>'+usedTag+'</div>':'') + (purchInfo||'') + '</td>'
      + '<td>' + (r.color || '') + '</td>'
      + '<td>' + (r.storage || '') + '</td>'
      + '<td><span class="tag">' + (r.carrier || 'Unknown') + '</span></td>'
      + '<td><div>' + (r.match_device || '—') + '</div><div class="muted">' + (r.match_sheet || '') + '</div></td>'
      + '<td class="right"><input type="number" class="paid" data-kind="api" data-idx="' + idx + '" value="' + paidDollars + '" step="1" min="0" /></td>'
      + '<td class="right">1</td>'
      + '<td><input type="text" class="note" data-kind="api" data-idx="' + idx + '" /></td>'
      + '</tr>');
  });

  /* Manual rows (identifier input; qty=1 per row) */
  mrows.forEach(function(r, idx) {
    table.push('<tr>'
      + '<td><input type="text" class="mident" data-idx="'+idx+'" placeholder="IMEI or Serial" value="'+ (r.identifier || '') + '"/></td>'
      + '<td>' + (r.device || '') + '</td>'
      + '<td>' + (r.color || '') + '</td>'
      + '<td>' + (r.storage || '') + '</td>'
      + '<td><span class="tag">' + (r.carrier || 'Unknown') + '</span></td>'
      + '<td><div class="muted">—</div></td>'
      + '<td class="right"><input type="number" class="mpaid" data-idx="' + idx + '" value="' + (r.unitPrice || '') + '" step="1" min="0" /></td>'
      + '<td class="right">1</td>'
      + '<td><input type="text" class="mnote" data-idx="' + idx + '" value="' + (r.notes || '') + '" /></td>'
      + '</tr>');
  });

  table.push('</tbody></table>'
    + '<div class="row" style="margin-top:12px;">'
    + '  <button class="btn" id="download">Download CSV</button>'
    + '  <span class="muted">CSV uses a single <b>identifier</b> column (IMEI or Serial).</span>'
    + '</div>');

  el.innerHTML = table.join('');

  // Make automated rows editable + hide matched sheet column already via CSS
  makeEditableRows();

  /* ------- Identifier validation additions ------- */
  function refreshIdentifierValidation() {
    const inputs = Array.from(document.querySelectorAll('.mident'));
    const seen = new Map();
    inputs.forEach(inp => {
      const v = (inp.value || '').trim();
      const key = v.toUpperCase();
      inp.classList.remove('bad');
      inp.removeAttribute('title');

      if (!v) return;

      // Duplicate highlight
      if (seen.has(key)) {
        inp.classList.add('bad');
        const other = seen.get(key);
        if (other) other.classList.add('bad');
      } else {
        seen.set(key, inp);
      }

      // Soft IMEI check: if all digits and not 15 chars
      if (/^\d+$/.test(v) && v.length !== 15) {
        inp.classList.add('bad');
        inp.title = 'IMEI is usually 15 digits (serials can be any length).';
      }
    });
  }
  refreshIdentifierValidation();
  document.querySelectorAll('.mident').forEach(inp => {
    inp.addEventListener('input', refreshIdentifierValidation);
  });

  /* totals update */
  Array.prototype.forEach.call(document.querySelectorAll('.paid,.mpaid'), function(inp) {
    inp.addEventListener('input', computeTotals);
  });

  /* Enter → focus next identifier (manual rows) */
  var idents = Array.prototype.slice.call(document.querySelectorAll('.mident'));
  idents.forEach(function(inp, i) {
    inp.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        var next = idents[i + 1];
        if (next) next.focus();
      }
    });
  });

  /* Download CSV */
  document.getElementById('download').onclick = function() {
    var payload = [];

    /* API rows */
    state.rows.forEach(function(r, idx) {
      if (!r.ok) return;
      var paidEl = document.querySelector('.paid[data-kind="api"][data-idx="' + idx + '"]');
      var noteEl = document.querySelector('.note[data-kind="api"][data-idx="' + idx + '"]');
      var dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
      var cents = isFinite(dollars) ? Math.round(dollars * 100) : '';
      payload.push({
        manual: 'no', used: r.used ? 'yes' : 'no', used_source: r.used_source || '',
        identifier: r.imei,                    /* unified field */
        manufacturer: r.manufacturer || '', model_name: r.model_name || '', model_code: r.model_code || '',
        device: r.device_display || '', color: r.color || '', storage: r.storage || '', carrier: r.carrier || 'Unknown',
        icloud_lock: r.icloud_lock_on ? 'ON' : 'OFF', condition_hint: r.condition_hint || '', estimated_purchase_date: r.estimated_purchase_date || '',
        quantity: 1, unit_price_cents: cents, line_total_cents: cents,
        suggested_price_cents: (typeof r.suggested_price_cents !== 'undefined' ? r.suggested_price_cents : ''),
        notes: (noteEl ? noteEl.value : '')
      });
    });

    /* Manual rows */
    state.manual.forEach(function(r, idx) {
      var paidEl = document.querySelector('.mpaid[data-idx="' + idx + '"]');
      var noteEl = document.querySelector('.mnote[data-idx="' + idx + '"]');
      var identEl = document.querySelector('.mident[data-idx="' + idx + '"]');
      var dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
      var cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
      payload.push({
        manual: 'yes', used: '', used_source: '',
        identifier: identEl ? identEl.value.trim() : '',  /* unified field */
        manufacturer: '', model_name: '', model_code: '',
        device: r.device || '', color: r.color || '', storage: r.storage || '', carrier: r.carrier || 'Unknown',
        icloud_lock: '', condition_hint: '', estimated_purchase_date: '',
        quantity: 1, unit_price_cents: cents, line_total_cents: cents,
        suggested_price_cents: '', notes: noteEl ? noteEl.value : ''
      });
    });

    var header = ['manual','used','used_source','identifier','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','condition_hint','estimated_purchase_date','quantity','unit_price_cents','line_total_cents','suggested_price_cents','notes'];
    var lines = [header.join(',')];
    payload.forEach(function(o) {
      var row = header.map(function(k) {
        var v = (o[k] != null) ? String(o[k]) : '';
        return JSON.stringify(v).replace(/^\uFEFF/, '');
      }).join(',');
      lines.push(row);
    });
    var csv = lines.join('\n');

    var blob = new Blob([csv], { type:'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url; a.download = 'intake_export.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  computeTotals();
}

/* ---------- Totals ---------- */
function computeTotals() {
  var totalDollars = 0;
  Array.prototype.forEach.call(document.querySelectorAll('.paid'), function(inp) {
    var v = Number(inp.value || '');
    if (isFinite(v)) totalDollars += v;
  });
  Array.prototype.forEach.call(document.querySelectorAll('.mpaid'), function(inp) {
    var v = Number(inp.value || '');
    if (isFinite(v)) totalDollars += v;
  });
  document.getElementById('totals').innerText = 'Total: $' + Math.round(totalDollars);
}

/* ---------- Controls ---------- */
document.getElementById('reset').onclick = function() {
  document.getElementById('imeis').value = '';
  state.rows = [];
  state.manual = [];
  document.getElementById('out').innerHTML = '';
  document.getElementById('totals').innerText = '';
};

/* Add manual → explode into N rows (identifier input per row) */
document.getElementById('addManual').onclick = function(e) {
  e.preventDefault();
  var device  = document.getElementById('m_device').value.trim();
  var color   = document.getElementById('m_color').value.trim();
  var storage = document.getElementById('m_storage').value.trim();
  var carrier = document.getElementById('m_carrier').value || 'Unknown';
  var qty     = Math.max(1, Number(document.getElementById('m_qty').value || '1'));
  var unitPrice = Number(document.getElementById('m_price').value || '');
  if (!device) return;

  for (var i=0; i<qty; i++) {
    state.manual.push({
      device: device, color: color, storage: storage, carrier: carrier,
      identifier: '', unitPrice: isFinite(unitPrice) ? unitPrice : 0, notes: ''
    });
  }
  render();

  /* focus first empty identifier */
  setTimeout(function() {
    var firstEmpty = Array.prototype.find.call(document.querySelectorAll('.mident'), function(inp){ return !inp.value; });
    if (firstEmpty) firstEmpty.focus();
  }, 0);
};

/* IMEI lookup submit */
document.getElementById('form').onsubmit = async function(e) {
  e.preventDefault();
  var raw = document.getElementById('imeis').value || '';
  var imeis = raw.split(/[\s,;\n\r]+/).map(function(s){ return s.trim(); }).filter(Boolean).slice(0,200);
  if (!imeis.length) return;

  var loader = document.getElementById('loader');
  var btn = document.getElementById('lookupBtn');
  loader.classList.add('show'); btn.disabled = true; btn.innerText = 'Looking up…';

  try {
    const res = await fetch('/api/intake', {
      method: 'POST',
      headers: { 'content-type':'application/json' },
      body: JSON.stringify({ imeis: imeis })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Lookup failed');
    state.rows = data.items || [];
    render();
  } catch (err) {
    alert(String(err && err.message ? err.message : err));
    console.error(err);
  } finally {
    loader.classList.remove('show'); btn.disabled = false; btn.innerText = 'Lookup & Price';
  }
};
</script>
</body>
</html>
