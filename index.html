<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inventory Management</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0b0f14;
    color: #e6f1ff;
    margin: 20px;
  }
  .tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    background: #18344a;
    border-radius: 10px;
    padding: 5px;
  }
  .tab {
    padding: 12px 20px;
    cursor: pointer;
    border-radius: 8px;
    font-weight: 600;
    text-align: center;
    flex: 1;
    transition: all 0.2s ease;
    color: #a0b8d0;
  }
  .tab.active {
    background: #0f141a;
    color: #e6f1ff;
  }
  .tab:hover:not(.active) {
    background: #1f4060;
    color: #e6f1ff;
  }
  .tab-content {
    display: none;
    padding: 20px;
    background: #0f141a;
    border-radius: 10px;
  }
  .tab-content.active {
    display: block;
  }
  textarea, input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    background: #18222f;
    color: #e6f1ff;
    margin-bottom: 15px;
  }
  button {
    background: #00e29b;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    cursor: pointer;
    color: #062612;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #00b37a;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    border: 1px solid #213244;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #18344a;
  }
</style>
</head>
<body>
  <div class="header-right" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
    <div class="balance-display">
      <i class="fas fa-wallet"></i>
      <span>API Balance: <span id="balance-value">Loading...</span></span>
    </div>
    <button class="btn secondary" id="refresh-balance">Refresh Balance</button>
  </div>
  <div class="tabs">
    <a href="#lookup" class="tab active" data-tab="lookup">Lookup / Manual Add</a>
    <a href="#inventory" class="tab" data-tab="inventory">Inventory</a>
  </div>
  <div id="lookup-tab" class="tab-content active">
    <h2>Lookup and Add Manual Item</h2>
    <textarea id="imei-input" placeholder="Enter IMEI numbers (one per line)"></textarea>
    <button id="lookup-btn">Lookup IMEIs</button>
    <hr />
    <h3>Manual Add</h3>
    <div style="display:flex; gap: 6px; flex-wrap: wrap; align-items: center;">
      <div style="flex: 1 1 160px;"><input type="text" id="m_device" placeholder="Device Name" style="width:100%; height:28px; font-size:0.9em;" /></div>
      <div style="flex: 0 0 100px;"><input type="text" id="m_color" placeholder="Color" style="width:100%; height:28px; font-size:0.9em;" /></div>
      <div style="flex: 0 0 90px;"><input type="text" id="m_storage" placeholder="Storage" style="width:100%; height:28px; font-size:0.9em;" /></div>
      <div style="flex: 0 0 110px;"><input type="text" id="m_carrier" placeholder="Carrier" style="width:100%; height:28px; font-size:0.9em;" /></div>
      <div style="flex: 0 0 90px;"><input type="number" id="m_price" placeholder="Price ($)" min="0" style="width:100%; height:28px; font-size:0.9em;" /></div>
      <div><button id="add-manual-btn">Add Item</button></div>
    </div>
    <div id="lookup-results"></div>
  </div>
  <div id="inventory-tab" class="tab-content">
    <h2>Inventory</h2>
    <table>
      <thead>
        <tr>
          <th>Device</th>
          <th>Color</th>
          <th>IMEI / Serial Number</th>
          <th>Storage</th>
          <th>Carrier</th>
          <th>Condition</th>
          <th>Price Paid</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="inventory-body">
        <tr><td colspan="8" style="text-align:center;">Loading inventory...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // Check Balance
    async function checkBalance() {
      const balanceValue = document.getElementById('balance-value');
      balanceValue.textContent = 'Loading...';
      try {
        const res = await fetch('/api/balance');
        if (!res.ok) throw new Error('Failed to fetch balance');
        const data = await res.json();
        if (data.balance) {
          balanceValue.textContent = '$' + data.balance;
          balanceValue.classList.remove('error');
        } else {
          balanceValue.textContent = 'Error';
          balanceValue.classList.add('error');
        }
      } catch (e) {
        balanceValue.textContent = 'Error';
        balanceValue.classList.add('error');
      }
    }

    document.getElementById('refresh-balance').addEventListener('click', checkBalance);
    document.addEventListener('DOMContentLoaded', checkBalance);

    // Tab Switching Logic
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', e => {
        e.preventDefault();
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId + '-tab').classList.add('active');
      });
    });

    // Lookup Function
    document.getElementById('lookup-btn').addEventListener('click', async () => {
      const imeiInput = document.getElementById('imei-input').value.trim();
      if (!imeiInput) return alert('Please enter at least one IMEI');
      const imeis = imeiInput.split('\n').map(i => i.trim()).filter(i => i);
      const resultsDiv = document.getElementById('lookup-results');
      resultsDiv.innerHTML = 'Loading...';
      try {
        const res = await fetch('/api/intake', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imeis })
        });
        if (!res.ok) throw new Error('Lookup failed');
        const data = await res.json();
        if (!data.items || !data.items.length) {
          resultsDiv.innerHTML = 'No results found';
          return;
        }
        resultsDiv.innerHTML = '<table><thead><tr><th>IMEI</th><th>Device</th><th>Color</th><th>Storage</th><th>Carrier</th><th>Suggested Price</th><th>Actions</th></tr></thead><tbody>' +
          data.items.map(item => `
          <tr data-imei="${escapeHtml(item.imei)}">
            <td>${escapeHtml(item.imei)}</td>
            <td>${escapeHtml(item.device_display || '')}</td>
            <td>${escapeHtml(item.color || '')}</td>
            <td>${escapeHtml(item.storage || '')}</td>
            <td>${escapeHtml(item.carrier || '')}</td>
            <td><input class="suggested-price-input" type="number" min="0" value="$${Number(item.suggested_price_dollars || 0).toFixed(2)}" style="width:80px;" /></td>
            <td><button class="btn add-to-inventory">Add</button></td>
          </tr>
        `).join('') + '</tbody></table><div><button id="add-all-to-inventory" class="btn" style="margin-top:12px;">Add All to Inventory</button> <strong style="margin-left:20px;">Total Payout: $<span id="total-payout">0.00</span></strong></div>';
      } catch (e) {
        resultsDiv.innerHTML = 'Error: ' + e.message;
      }
    });

    // Manual Add Function
    document.getElementById('add-manual-btn').addEventListener('click', async () => {
      const device = document.getElementById('m_device').value.trim();
      const color = document.getElementById('m_color').value.trim();
      const storage = document.getElementById('m_storage').value.trim();
      const carrier = document.getElementById('m_carrier').value.trim();
      const price = parseFloat(document.getElementById('m_price').value.trim()) || 0;

      if (!device) return alert('Device name is required');

      const item = { device, color, storage, carrier, price };

      try {
        const res = await fetch('/api/addToSheet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        });
        if (!res.ok) throw new Error('Failed to add item');
        alert('Item added successfully to inventory sheet');
        // Clear fields
        document.getElementById('m_device').value = '';
        document.getElementById('m_color').value = '';
        document.getElementById('m_storage').value = '';
        document.getElementById('m_carrier').value = '';
        document.getElementById('m_price').value = '';
      } catch (e) {
        alert('Error adding item: ' + e.message);
      }
    });

    // Add to Inventory buttons for lookup results
    document.getElementById('lookup-results').addEventListener('click', async event => {
      if (!event.target.classList.contains('add-to-inventory')) return;
      const row = event.target.closest('tr');
      if (!row) return;

      const imei = row.dataset.imei || '';
      const device = row.children[1]?.textContent || '';
      const color = row.children[2]?.textContent || '';
      const storage = row.children[3]?.textContent || '';
      const carrier = row.children[4]?.textContent || '';
      const price = parseFloat(row.querySelector('.suggested-price-input')?.value) || 0;

      const item = { device, color, storage, carrier, price, imei };

      try {
        const res = await fetch('/api/addToSheet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        });
        if (!res.ok) throw new Error('Failed to add item');
        alert('Item added to inventory successfully');
        updateTotalPayout(price);
      } catch (e) {
        alert('Error adding item: ' + e.message);
      }
    });

    // Update total payout
    var totalPayout = 0;
    function updateTotalPayout(amount) {
      totalPayout += amount;
      document.getElementById('total-payout').textContent = totalPayout.toFixed(2);
    }

    // Add All to Inventory Button
    document.addEventListener('click', async e => {
      if (e.target && e.target.id === 'add-all-to-inventory') {
        const rows = document.querySelectorAll('#lookup-results tbody tr');
        let itemsToAdd = [];
        let payoutTotal = 0;
        rows.forEach(row => {
          const imei = row.dataset.imei || '';
          const device = row.children[1]?.textContent || '';
          const color = row.children[2]?.textContent || '';
          const storage = row.children[3]?.textContent || '';
          const carrier = row.children[4]?.textContent || '';
          const price = parseFloat(row.querySelector('.suggested-price-input')?.value) || 0;
          itemsToAdd.push({ device, color, storage, carrier, price, imei });
          payoutTotal += price;
        });
        document.getElementById('total-payout').textContent = payoutTotal.toFixed(2);
        try {
          for (let item of itemsToAdd) {
            const res = await fetch('/api/addToSheet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(item)
            });
            if (!res.ok) throw new Error('Failed to add one or more items');
          }
          alert('All items added to inventory successfully');
        } catch (e) {
          alert('Error adding items: ' + e.message);
        }
      }
    });

    function escapeHtml(text) {
      if (!text) return '';
      return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Initially load inventory if inventory tab active
    if (document.getElementById('inventory-tab').classList.contains('active')) {
      loadInventory();
    }

    // Load inventory on tab click
    document.querySelectorAll('[data-tab="inventory"]').forEach(tab => {
      tab.addEventListener('click', loadInventory);
    });
  </script>
</body>
</html>
