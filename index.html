<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Complete Inventory Management System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #00e29b;
      --primary-dark: #00b37a;
      --secondary: #18344a;
      --secondary-light: #1f4060;
      --background: #0b0f14;
      --card-bg: #0f141a;
      --input-bg: #0d1218;
      --border: #213244;
      --text: #e6f1ff;
      --text-muted: #a0b8d0;
      --success: #48ffb3;
      --warning: #ffb648;
      --error: #ff4848;
      --info: #48b6ff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }
    
    h1, h2, h3, h4, h5, h6 {
      color: var(--text);
      margin-bottom: 15px;
    }
    
    a {
      color: var(--primary);
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
    }
    
    .header h1 i {
      margin-right: 10px;
      color: var(--primary);
    }
    
    .header-right {
      display: flex;
      align-items: center;
    }
    
    .api-balance {
      background: var(--secondary);
      padding: 8px 15px;
      border-radius: 8px;
      margin-right: 15px;
      display: flex;
      align-items: center;
    }
    
    .api-balance i {
      margin-right: 8px;
      color: var(--primary);
    }
    
    .refresh-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      margin-left: 8px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .tab {
      padding: 10px 20px;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }
    
    .tab i {
      margin-right: 8px;
    }
    
    .tab:hover {
      color: var(--text);
      text-decoration: none;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    textarea, input[type="text"], input[type="number"], input[type="password"], select {
      width: 100%;
      padding: 10px 15px;
      background-color: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 15px;
      transition: border-color 0.3s ease;
    }
    
    textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, select:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      background-color: var(--primary);
      color: var(--background);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn i {
      margin-right: 8px;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--text);
    }
    
    .btn-secondary:hover {
      background-color: var(--secondary-light);
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-muted);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-row > div {
      flex: 1;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .alert i {
      margin-right: 10px;
      font-size: 18px;
    }
    
    .success {
      background-color: rgba(72, 255, 179, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }
    
    .error {
      background-color: rgba(255, 72, 72, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }
    
    .warning {
      background-color: rgba(255, 182, 72, 0.1);
      border-left: 4px solid var(--warning);
      color: var(--warning);
    }
    
    .info {
      background-color: rgba(72, 182, 255, 0.1);
      border-left: 4px solid var(--info);
      color: var(--info);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      color: var(--text-muted);
      font-weight: 500;
    }
    
    tr:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-right: 5px;
      margin-top: 5px;
    }
    
    .tag.success {
      background-color: rgba(72, 255, 179, 0.1);
      color: var(--success);
      border: 1px solid rgba(72, 255, 179, 0.3);
    }
    
    .tag.error {
      background-color: rgba(255, 72, 72, 0.1);
      color: var(--error);
      border: 1px solid rgba(255, 72, 72, 0.3);
    }
    
    .tag.warning {
      background-color: rgba(255, 182, 72, 0.1);
      color: var(--warning);
      border: 1px solid rgba(255, 182, 72, 0.3);
    }
    
    .tag.info {
      background-color: rgba(72, 182, 255, 0.1);
      color: var(--info);
      border: 1px solid rgba(72, 182, 255, 0.3);
    }
    
    .warning-tag {
      margin-left: 8px;
    }
    
    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .right {
      text-align: right;
    }
    
    .center {
      text-align: center;
    }
    
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(11, 15, 20, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .loader.show {
      visibility: visible;
      opacity: 1;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 226, 155, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(11, 15, 20, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .modal.show {
      visibility: visible;
      opacity: 1;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .modal.show .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }
    
    .compact-manual-entry {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }
    
    .compact-manual-entry input,
    .compact-manual-entry select {
      margin-bottom: 0;
    }
    
    .typeahead {
      position: relative;
    }
    
    .typeahead-results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .typeahead-results.show {
      display: block;
    }
    
    .typeahead-item {
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .typeahead-item:hover {
      background-color: var(--secondary);
    }
    
    .cash-drawer-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .cash-stat {
      background: var(--secondary);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .cash-stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-top: 5px;
    }
    
    .cash-stat-label {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .transaction-list {
      margin-top: 20px;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .pagination a {
      padding: 8px 12px;
      margin: 0 5px;
      border-radius: 4px;
      background-color: var(--secondary);
      color: var(--text);
      transition: all 0.3s ease;
    }
    
    .pagination a:hover {
      background-color: var(--secondary-light);
      text-decoration: none;
    }
    
    .pagination a.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .admin-panel {
      padding: 20px;
      background-color: var(--secondary);
      border-radius: 10px;
      margin-top: 20px;
    }
    
    .admin-panel h3 {
      margin-top: 0;
    }
    
    .log-entry {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-timestamp {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .log-action {
      font-weight: 500;
    }
    
    .log-details {
      margin-top: 5px;
      font-size: 13px;
    }
    
    .passcode-input {
      letter-spacing: 0.5em;
      text-align: center;
      font-size: 24px;
    }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-boxes"></i> Enhanced Inventory Management</h1>
      <div class="header-right">
        <div class="api-balance">
          <i class="fas fa-wallet"></i>
          <span>API Balance: <span id="balance-value">Loading...</span></span>
          <button class="refresh-btn" id="refresh-balance"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>
    </div>
    
    <div class="tabs">
      <a href="#lookup" class="tab active" data-tab="lookup">
        <i class="fas fa-search"></i> IMEI Lookup
      </a>
      <a href="#manual-entry" class="tab" data-tab="manual-entry">
        <i class="fas fa-edit"></i> Manual Entry
      </a>
      <a href="#inventory" class="tab" data-tab="inventory">
        <i class="fas fa-boxes"></i> Inventory
      </a>
      <a href="#cash-drawer" class="tab" data-tab="cash-drawer">
        <i class="fas fa-cash-register"></i> Cash Drawer
      </a>
      <a href="#warehouse" class="tab" data-tab="warehouse">
        <i class="fas fa-warehouse"></i> Warehouse
      </a>
      <a href="#customers" class="tab" data-tab="customers">
        <i class="fas fa-users"></i> Customers
      </a>
      <a href="#invoices" class="tab" data-tab="invoices">
        <i class="fas fa-file-invoice-dollar"></i> Invoices
      </a>
      <a href="#admin" class="tab" data-tab="admin">
        <i class="fas fa-shield-alt"></i> Admin
      </a>
    </div>
    
    <div id="alerts-container">
      <!-- Alerts will be dynamically inserted here -->
    </div>
    
    <!-- IMEI Lookup Tab -->
    <!-- Manual Entry Tab -->
    <div id="manual-entry-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Manual Item Entry</h2>
          <div class="btn-group">
            <button class="btn" id="add-to-store-btn">
              <i class="fas fa-store"></i> Add to Store
            </button>
            <button class="btn" id="add-to-warehouse-btn">
              <i class="fas fa-warehouse"></i> Add to Warehouse
            </button>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>Device</label>
            <div class="typeahead">
              <input type="text" id="manual_device" placeholder="Device Name">
              <div class="typeahead-results" id="manual-device-results"></div>
            </div>
          </div>
          <div>
            <label>Color</label>
            <div class="typeahead">
              <input type="text" id="manual_color" placeholder="Color">
              <div class="typeahead-results" id="manual-color-results"></div>
            </div>
          </div>
          <div>
            <label>Storage</label>
            <input type="text" id="manual_storage" placeholder="Storage">
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>IMEI/Serial</label>
            <input type="text" id="manual_imei" placeholder="IMEI or Serial Number">
          </div>
          <div>
            <label>Carrier</label>
            <select id="manual_carrier">
              <option value="Unknown">Select Carrier</option>
              <option value="Unlocked">Unlocked</option>
              <option value="AT&T">AT&T</option>
              <option value="Verizon">Verizon</option>
              <option value="T-Mobile">T-Mobile</option>
              <option value="Sprint">Sprint</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label>Condition</label>
            <select id="manual_condition">
              <option value="NIB">NIB - New In Box</option>
              <option value="A">A - Like New</option>
              <option value="B" selected>B - Good</option>
              <option value="C">C - Fair</option>
              <option value="D">D - Poor</option>
            </select>
          </div>
          <div>
            <label>Device Type</label>
            <select id="manual_type">
              <option value="Phone" selected>Phone</option>
              <option value="Tablet">Tablet</option>
              <option value="Laptop">Laptop</option>
              <option value="Smartwatch">Smartwatch</option>
              <option value="Accessory">Accessory</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div>
            <label>Price Paid</label>
            <input type="number" id="manual_price" placeholder="Price" step="0.01">
          </div>
          <div>
            <label>Quantity</label>
            <input type="number" id="manual_quantity" value="1" min="1">
          </div>
          <div>
            <label>Purchase Date</label>
            <input type="date" id="manual_purchase_date">
          </div>
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="manual_notes" rows="2" placeholder="Additional notes..."></textarea>
        </div>
        
        <div class="form-group">
          <button class="btn" id="manual-add-item-btn">
            <i class="fas fa-plus"></i> Add Item
          </button>
          <button class="btn btn-secondary" id="manual-clear-btn">
            <i class="fas fa-times"></i> Clear Form
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Recently Added Items</h2>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>IMEI/Serial</th>
                <th>Device</th>
                <th>Condition</th>
                <th>Location</th>
                <th>Price Paid</th>
                <th>Date Added</th>
              </tr>
            </thead>
            <tbody id="recent-items-body">
              <!-- Recently added items will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="lookup-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>Bulk IMEI Lookup</h2>
        </div>
        
        <div class="form-group">
          <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
          <textarea id="imeis" rows="5" placeholder="Enter IMEIs here..."></textarea>
          <p class="muted">We'll fetch details from Sickw and suggest a price by matching the device name to the site's CSV.</p>
        </div>
        
        <div class="form-group">
          <div class="btn-group">
            <button class="btn" id="lookup-btn">
              <i class="fas fa-search"></i> Lookup IMEIs
            </button>
            <button class="btn btn-secondary" id="reset-btn">
              <i class="fas fa-times"></i> Reset
            </button>
          </div>
        </div>
      </div>
      
      <div id="results-container" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2>Results</h2>
            <div class="btn-group">
              <button class="btn" id="import-to-inventory-btn">
                <i class="fas fa-file-import"></i> Import to Inventory
              </button>
              <button class="btn" id="import-to-warehouse-btn">
                <i class="fas fa-warehouse"></i> Import to Warehouse
              </button>
              <button class="btn btn-secondary" id="download">
                <i class="fas fa-download"></i> Download CSV
              </button>
            </div>
          </div>
          
          <div class="table-responsive">
            <table id="results-table">
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="select-all">
                  </th>
                  <th>IMEI</th>
                  <th>Device</th>
                  <th>Color</th>
                  <th>Storage</th>
                  <th>Carrier</th>
                  <th>Condition</th>
                  <th>Price Paid</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="results-body">
                <!-- Results will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <div class="form-row">
              <div>
                <h3 id="totals">Total: $0.00</h3>
              </div>
              <div>
                <h3 id="total-devices">Total Devices: 0</h3>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2>Add Manual Item</h2>
          </div>
          
          <div class="compact-manual-entry">
            <div class="typeahead">
              <input type="text" id="m_device" placeholder="Device Name">
              <div class="typeahead-results" id="device-results"></div>
            </div>
            <div class="typeahead">
              <input type="text" id="m_color" placeholder="Color">
              <div class="typeahead-results" id="color-results"></div>
            </div>
            <input type="text" id="m_storage" placeholder="Storage">
            <select id="m_carrier">
              <option value="Unknown">Carrier</option>
              <option value="Unlocked">Unlocked</option>
              <option value="AT&T">AT&T</option>
              <option value="Verizon">Verizon</option>
              <option value="T-Mobile">T-Mobile</option>
              <option value="Sprint">Sprint</option>
              <option value="Other">Other</option>
            </select>
            <div style="display: flex; gap: 10px;">
              <input type="number" id="m_price" placeholder="Price" style="flex: 1;">
              <button class="btn" id="addManual" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Inventory Tab -->
    <div id="inventory-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Inventory Management</h2>
          <button class="btn" id="transfer-to-warehouse-btn">
            <i class="fas fa-truck-loading"></i> Transfer to Warehouse
          </button>
        </div>
        
        <div class="form-row">
          <div>
            <input type="text" id="inventory-search" placeholder="Search by IMEI or device name">
          </div>
          <div style="flex: 0 0 auto;">
            <button class="btn" id="inventory-search-btn">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
          <div style="flex: 0 0 auto;">
            <select id="status-filter">
              <option value="all">All Status</option>
              <option value="in_stock" selected>In Stock</option>
              <option value="sold">Sold</option>
              <option value="transferred">Transferred</option>
            </select>
          </div>
          <div style="flex: 0 0 auto;">
            <select id="location-filter">
              <option value="all">All Locations</option>
              <option value="store" selected>Store</option>
              <option value="warehouse">Warehouse</option>
            </select>
          </div>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th style="width: 30px;">
                  <input type="checkbox" id="inventory-select-all">
                </th>
                <th>IMEI</th>
                <th>Device</th>
                <th>Condition</th>
                <th>Carrier</th>
                <th>Price Paid</th>
                <th>Status</th>
                <th>Location</th>
                <th>Date Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-body">
              <!-- Inventory items will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
        
        <div class="pagination" id="inventory-pagination">
          <!-- Pagination will be dynamically inserted here -->
        </div>
      </div>
    </div>
    
    <!-- Cash Drawer Tab -->
    <div id="cash-drawer-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Cash Drawer Management</h2>
          <div id="cash-drawer-actions">
            <button class="btn" id="open-drawer-btn">
              <i class="fas fa-cash-register"></i> Open Drawer
            </button>
          </div>
        </div>
        
        <div id="cash-drawer-content">
          <!-- Cash drawer content will be dynamically inserted here -->
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Recent Transactions</h3>
            <button class="btn" id="add-transaction-btn">
              <i class="fas fa-plus"></i> Add Transaction
            </button>
          </div>
          
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="transactions-body">
                <!-- Transactions will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Warehouse Tab -->
    <div id="warehouse-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Warehouse Management</h2>
        </div>
        
        <div id="warehouse-locked">
          <div style="text-align: center; padding: 50px 20px;">
            <i class="fas fa-lock" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
            <h3>Warehouse Access Restricted</h3>
            <p class="muted">Enter passcode to access warehouse inventory</p>
            <div style="max-width: 200px; margin: 20px auto;">
              <input type="password" id="warehouse-passcode" class="passcode-input" placeholder="****" maxlength="4">
              <button class="btn" id="warehouse-unlock-btn" style="width: 100%; margin-top: 10px;">
                <i class="fas fa-unlock"></i> Unlock
              </button>
            </div>
          </div>
        </div>
        
        <div id="warehouse-content" style="display: none;">
          <div class="form-row">
            <div>
              <input type="text" id="warehouse-search" placeholder="Search by IMEI or device name">
            </div>
            <div style="flex: 0 0 auto;">
              <button class="btn" id="warehouse-search-btn">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
            <div style="flex: 0 0 auto;">
              <select id="warehouse-status-filter">
                <option value="all">All Status</option>
                <option value="in_stock" selected>In Stock</option>
                <option value="sold">Sold</option>
                <option value="transferred">Transferred</option>
              </select>
            </div>
            <div style="flex: 0 0 auto;">
              <select id="warehouse-carrier-filter">
                <option value="all">All Carriers</option>
                <option value="Unlocked">Unlocked</option>
                <option value="AT&T">AT&T</option>
                <option value="Verizon">Verizon</option>
                <option value="T-Mobile">T-Mobile</option>
                <option value="Sprint">Sprint</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div style="flex: 0 0 auto;">
              <select id="warehouse-condition-filter">
                <option value="all">All Conditions</option>
                <option value="NIB">NIB - New</option>
                <option value="A">A - Like New</option>
                <option value="B">B - Good</option>
                <option value="C">C - Fair</option>
                <option value="D">D - Poor</option>
              </select>
            </div>
            <div style="flex: 0 0 auto;">
              <select id="warehouse-type-filter">
                <option value="all">All Types</option>
                <option value="Phone">Phones</option>
                <option value="Tablet">Tablets</option>
                <option value="Laptop">Laptops</option>
                <option value="Smartwatch">Smartwatches</option>
                <option value="Accessory">Accessories</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          
          <div class="form-row" style="margin-top: 10px;">
            <div style="flex: 0 0 auto;">
              <button class="btn" id="mass-select-all-btn">
                <i class="fas fa-check-square"></i> Select All
              </button>
            </div>
            <div style="flex: 0 0 auto;">
              <button class="btn" id="mass-deselect-all-btn">
                <i class="fas fa-square"></i> Deselect All
              </button>
            </div>
            <div style="flex: 0 0 auto;">
              <button class="btn" id="create-invoice-from-selected-btn" disabled>
                <i class="fas fa-file-invoice-dollar"></i> Create Invoice from Selected
              </button>
            </div>
            <div style="flex: 0 0 auto;">
              <button class="btn btn-secondary" id="export-selected-btn" disabled>
                <i class="fas fa-file-export"></i> Export Selected
              </button>
            </div>
            <div style="margin-left: auto; display: flex; align-items: center;">
              <span id="selected-count">0 items selected</span>
            </div>
          </div>
          
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="warehouse-select-all">
                  </th>
                  <th>IMEI</th>
                  <th>Device</th>
                  <th>Condition</th>
                  <th>Carrier</th>
                  <th>Price Paid</th>
                  <th>Status</th>
                  <th>Date Added</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="warehouse-body">
                <!-- Warehouse items will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
          
          <div class="pagination" id="warehouse-pagination">
            <!-- Pagination will be dynamically inserted here -->
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3>Add Device to Warehouse</h3>
            </div>
            
            <div class="form-row">
              <div>
                <label>Device</label>
                <div class="typeahead">
                  <input type="text" id="w_device" placeholder="Device Name">
                  <div class="typeahead-results" id="w-device-results"></div>
                </div>
              </div>
              <div>
                <label>Color</label>
                <div class="typeahead">
                  <input type="text" id="w_color" placeholder="Color">
                  <div class="typeahead-results" id="w-color-results"></div>
                </div>
              </div>
              <div>
                <label>Storage</label>
                <input type="text" id="w_storage" placeholder="Storage">
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>IMEI/Serial</label>
                <input type="text" id="w_imei" placeholder="IMEI or Serial Number">
              </div>
              <div>
                <label>Carrier</label>
                <select id="w_carrier">
                  <option value="Unknown">Select Carrier</option>
                  <option value="Unlocked">Unlocked</option>
                  <option value="AT&T">AT&T</option>
                  <option value="Verizon">Verizon</option>
                  <option value="T-Mobile">T-Mobile</option>
                  <option value="Sprint">Sprint</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label>Condition</label>
                <select id="w_condition">
                  <option value="A">A - Like New</option>
                  <option value="B" selected>B - Good</option>
                  <option value="C">C - Fair</option>
                  <option value="D">D - Poor</option>
                </select>
              </div>
              <div>
                <label>Price Paid</label>
                <input type="number" id="w_price" placeholder="Price" step="0.01">
              </div>
            </div>
            
            <div class="form-group">
              <label>Notes</label>
              <textarea id="w_notes" rows="2" placeholder="Additional notes..."></textarea>
            </div>
            
            <div class="form-group">
              <button class="btn" id="add-warehouse-device-btn">
                <i class="fas fa-plus"></i> Add to Warehouse
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Admin Tab -->
    <!-- Customers Tab -->
    <div id="customers-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Customer Management</h2>
          <button class="btn" id="add-customer-btn">
            <i class="fas fa-user-plus"></i> Add Customer
          </button>
        </div>
        
        <div class="form-row">
          <div>
            <input type="text" id="customer-search" placeholder="Search customers...">
          </div>
          <div style="flex: 0 0 auto;">
            <button class="btn" id="customer-search-btn">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Customer Name</th>
                <th>Contact</th>
                <th>Email</th>
                <th>Balance</th>
                <th>Last Purchase</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customers-body">
              <!-- Customers will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div id="customer-detail" class="card" style="display: none;">
        <div class="card-header">
          <h2>Customer Details: <span id="customer-detail-name"></span></h2>
          <div class="btn-group">
            <button class="btn" id="create-invoice-btn">
              <i class="fas fa-file-invoice-dollar"></i> Create Invoice
            </button>
            <button class="btn" id="record-payment-btn">
              <i class="fas fa-money-bill-wave"></i> Record Payment
            </button>
          </div>
        </div>
        
        <div class="customer-summary">
          <div class="customer-info">
            <p><strong>Contact:</strong> <span id="customer-detail-contact"></span></p>
            <p><strong>Email:</strong> <span id="customer-detail-email"></span></p>
            <p><strong>Address:</strong> <span id="customer-detail-address"></span></p>
            <p><strong>Notes:</strong> <span id="customer-detail-notes"></span></p>
          </div>
          
          <div class="customer-balance">
            <div class="balance-card">
              <div class="balance-title">Current Balance</div>
              <div class="balance-amount" id="customer-detail-balance">$0.00</div>
            </div>
            <div class="balance-card">
              <div class="balance-title">Total Purchases</div>
              <div class="balance-amount" id="customer-detail-purchases">$0.00</div>
            </div>
            <div class="balance-card">
              <div class="balance-title">Total Payments</div>
              <div class="balance-amount" id="customer-detail-payments">$0.00</div>
            </div>
          </div>
        </div>
        
        <div class="tabs sub-tabs">
          <a href="#customer-invoices" class="sub-tab active" data-subtab="customer-invoices">Invoices</a>
          <a href="#customer-payments" class="sub-tab" data-subtab="customer-payments">Payments</a>
          <a href="#customer-statement" class="sub-tab" data-subtab="customer-statement">Statement</a>
        </div>
        
        <div id="customer-invoices-tab" class="sub-tab-content active">
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="customer-invoices-body">
                <!-- Invoices will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="customer-payments-tab" class="sub-tab-content">
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Payment #</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="customer-payments-body">
                <!-- Payments will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="customer-statement-tab" class="sub-tab-content">
          <div class="statement-controls">
            <div class="form-row">
              <div>
                <label>Start Date</label>
                <input type="date" id="statement-start-date">
              </div>
              <div>
                <label>End Date</label>
                <input type="date" id="statement-end-date">
              </div>
              <div style="align-self: flex-end;">
                <button class="btn" id="generate-statement-btn">
                  <i class="fas fa-file-alt"></i> Generate Statement
                </button>
              </div>
              <div style="align-self: flex-end;">
                <button class="btn btn-secondary" id="print-statement-btn">
                  <i class="fas fa-print"></i> Print
                </button>
              </div>
            </div>
          </div>
          
          <div id="statement-content" class="statement-preview">
            <!-- Statement will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Invoices Tab -->
    <div id="invoices-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Invoice Management</h2>
          <button class="btn" id="create-new-invoice-btn">
            <i class="fas fa-plus"></i> Create New Invoice
          </button>
        </div>
        
        <div class="form-row">
          <div>
            <input type="text" id="invoice-search" placeholder="Search invoices...">
          </div>
          <div style="flex: 0 0 auto;">
            <button class="btn" id="invoice-search-btn">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
          <div style="flex: 0 0 auto;">
            <select id="invoice-status-filter">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
              <option value="partial">Partial</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Due Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoices-body">
              <!-- Invoices will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
        
        <div class="pagination" id="invoices-pagination">
          <!-- Pagination will be dynamically inserted here -->
        </div>
      </div>
      
      <div id="invoice-detail" class="card" style="display: none;">
        <div class="card-header">
          <h2>Invoice #<span id="invoice-detail-number"></span></h2>
          <div class="btn-group">
            <button class="btn" id="edit-invoice-btn">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn" id="record-invoice-payment-btn">
              <i class="fas fa-money-bill-wave"></i> Record Payment
            </button>
            <button class="btn btn-secondary" id="print-invoice-btn">
              <i class="fas fa-print"></i> Print
            </button>
            <button class="btn btn-secondary" id="download-invoice-pdf-btn">
              <i class="fas fa-file-pdf"></i> Download PDF
            </button>
          </div>
        </div>
        
        <div class="invoice-summary">
          <div class="invoice-info">
            <p><strong>Customer:</strong> <span id="invoice-detail-customer"></span></p>
            <p><strong>Date:</strong> <span id="invoice-detail-date"></span></p>
            <p><strong>Due Date:</strong> <span id="invoice-detail-due-date"></span></p>
            <p><strong>Status:</strong> <span id="invoice-detail-status"></span></p>
          </div>
          
          <div class="invoice-totals">
            <div class="total-card">
              <div class="total-title">Subtotal</div>
              <div class="total-amount" id="invoice-detail-subtotal">$0.00</div>
            </div>
            <div class="total-card">
              <div class="total-title">Tax</div>
              <div class="total-amount" id="invoice-detail-tax">$0.00</div>
            </div>
            <div class="total-card">
              <div class="total-title">Total</div>
              <div class="total-amount" id="invoice-detail-total">$0.00</div>
            </div>
            <div class="total-card">
              <div class="total-title">Paid</div>
              <div class="total-amount" id="invoice-detail-paid">$0.00</div>
            </div>
            <div class="total-card">
              <div class="total-title">Balance</div>
              <div class="total-amount" id="invoice-detail-balance">$0.00</div>
            </div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Description</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="invoice-items-body">
              <!-- Invoice items will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
        
        <div class="invoice-notes">
          <h3>Notes</h3>
          <p id="invoice-detail-notes"></p>
        </div>
        
        <div class="invoice-payments">
          <h3>Payments</h3>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="invoice-payments-body">
                <!-- Invoice payments will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div id="admin-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Admin Panel</h2>
        </div>
        
        <div id="admin-locked">
          <div style="text-align: center; padding: 50px 20px;">
            <i class="fas fa-shield-alt" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
            <h3>Admin Access Restricted</h3>
            <p class="muted">Enter admin passcode to access admin panel</p>
            <div style="max-width: 200px; margin: 20px auto;">
              <input type="password" id="admin-passcode" class="passcode-input" placeholder="****" maxlength="4">
              <button class="btn" id="admin-unlock-btn" style="width: 100%; margin-top: 10px;">
                <i class="fas fa-unlock"></i> Unlock
              </button>
            </div>
          </div>
        </div>
        
        <div id="admin-content" style="display: none;">
          <div class="tabs sub-tabs">
            <a href="#admin-dashboard" class="sub-tab active" data-subtab="admin-dashboard">Dashboard</a>
            <a href="#admin-logs" class="sub-tab" data-subtab="admin-logs">System Logs</a>
            <a href="#admin-settings" class="sub-tab" data-subtab="admin-settings">Settings</a>
            <a href="#admin-users" class="sub-tab" data-subtab="admin-users">Users</a>
            <a href="#admin-backup" class="sub-tab" data-subtab="admin-backup">Backup & Restore</a>
          </div>
          
          <div id="admin-dashboard-tab" class="sub-tab-content active">
            <div class="dashboard-summary">
              <div class="summary-card">
                <div class="summary-icon"><i class="fas fa-boxes"></i></div>
                <div class="summary-title">Total Inventory</div>
                <div class="summary-value" id="dashboard-total-inventory">0</div>
              </div>
              <div class="summary-card">
                <div class="summary-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="summary-title">Inventory Value</div>
                <div class="summary-value" id="dashboard-inventory-value">$0.00</div>
              </div>
              <div class="summary-card">
                <div class="summary-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                <div class="summary-title">Outstanding Invoices</div>
                <div class="summary-value" id="dashboard-outstanding-invoices">$0.00</div>
              </div>
              <div class="summary-card">
                <div class="summary-icon"><i class="fas fa-chart-line"></i></div>
                <div class="summary-title">Monthly Sales</div>
                <div class="summary-value" id="dashboard-monthly-sales">$0.00</div>
              </div>
            </div>
            
            <div class="dashboard-charts">
              <div class="chart-container">
                <h3>Most Purchased Devices</h3>
                <canvas id="top-devices-chart"></canvas>
              </div>
              <div class="chart-container">
                <h3>Sales by Month</h3>
                <canvas id="sales-chart"></canvas>
              </div>
            </div>
            
            <div class="dashboard-charts">
              <div class="chart-container">
                <h3>Inventory by Condition</h3>
                <canvas id="condition-chart"></canvas>
              </div>
              <div class="chart-container">
                <h3>Inventory by Carrier</h3>
                <canvas id="carrier-chart"></canvas>
              </div>
            </div>
            
            <div class="admin-panel" style="margin-top: 20px;">
              <h3>Low Stock Alerts</h3>
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>Device</th>
                      <th>Current Stock</th>
                      <th>Threshold</th>
                      <th>Last Received</th>
                    </tr>
                  </thead>
                  <tbody id="low-stock-body">
                    <!-- Low stock alerts will be dynamically inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div id="admin-logs-tab" class="sub-tab-content">
            <div class="form-row">
              <div>
                <select id="log-filter">
                  <option value="all">All Actions</option>
                  <option value="inventory_add">Inventory Add</option>
                  <option value="inventory_edit">Inventory Edit</option>
                  <option value="inventory_delete">Inventory Delete</option>
                  <option value="transfer">Transfer</option>
                  <option value="cash_drawer">Cash Drawer</option>
                  <option value="transaction">Transaction</option>
                  <option value="invoice">Invoice</option>
                  <option value="payment">Payment</option>
                  <option value="customer">Customer</option>
                </select>
              </div>
              <div style="flex: 0 0 auto;">
                <button class="btn" id="filter-logs-btn">
                  <i class="fas fa-filter"></i> Filter
                </button>
              </div>
              <div style="flex: 0 0 auto;">
                <button class="btn btn-secondary" id="export-logs-btn">
                  <i class="fas fa-file-export"></i> Export Logs
                </button>
              </div>
            </div>
            
            <div class="admin-panel">
              <h3>System Logs</h3>
              <div id="system-logs">
                <!-- Logs will be dynamically inserted here -->
              </div>
            </div>
          </div>
          
          <div id="admin-settings-tab" class="sub-tab-content">
            <div class="admin-panel">
              <h3>System Settings</h3>
              <div class="form-group">
                <label>Default Device Condition Age (days)</label>
                <input type="number" id="condition-age-setting" value="45" min="1">
                <p class="muted">Devices older than this will be automatically marked as B grade</p>
              </div>
              <div class="form-group">
                <label>Tax Rate (%)</label>
                <input type="number" id="tax-rate-setting" value="8.25" min="0" step="0.01">
                <p class="muted">Default tax rate for invoices</p>
              </div>
              <div class="form-group">
                <label>Invoice Due Days</label>
                <input type="number" id="invoice-due-days-setting" value="30" min="1">
                <p class="muted">Default number of days until invoice is due</p>
              </div>
              <div class="form-group">
                <label>Low Stock Threshold</label>
                <input type="number" id="low-stock-threshold-setting" value="5" min="1">
                <p class="muted">Alert when stock falls below this number</p>
              </div>
              <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="company-name-setting" placeholder="Your Company Name">
                <p class="muted">Used on invoices and statements</p>
              </div>
              <div class="form-group">
                <label>Company Address</label>
                <textarea id="company-address-setting" rows="3" placeholder="Your Company Address"></textarea>
                <p class="muted">Used on invoices and statements</p>
              </div>
              <div class="form-group">
                <label>Company Phone</label>
                <input type="text" id="company-phone-setting" placeholder="Your Company Phone">
                <p class="muted">Used on invoices and statements</p>
              </div>
              <div class="form-group">
                <label>Company Email</label>
                <input type="email" id="company-email-setting" placeholder="Your Company Email">
                <p class="muted">Used on invoices and statements</p>
              </div>
              <div class="form-group">
                <button class="btn" id="save-settings-btn">
                  <i class="fas fa-save"></i> Save Settings
                </button>
              </div>
            </div>
          </div>
          
          <div id="admin-users-tab" class="sub-tab-content">
            <div class="admin-panel">
              <h3>User Management</h3>
              <div class="form-row">
                <div style="flex: 0 0 auto;">
                  <button class="btn" id="add-user-btn">
                    <i class="fas fa-user-plus"></i> Add User
                  </button>
                </div>
              </div>
              
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>Username</th>
                      <th>Role</th>
                      <th>Email</th>
                      <th>Last Login</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="users-body">
                    <!-- Users will be dynamically inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div id="admin-backup-tab" class="sub-tab-content">
            <div class="admin-panel">
              <h3>Backup & Restore</h3>
              <div class="form-row">
                <div style="flex: 0 0 auto;">
                  <button class="btn" id="create-backup-btn">
                    <i class="fas fa-download"></i> Create Backup
                  </button>
                </div>
                <div style="flex: 0 0 auto;">
                  <button class="btn btn-secondary" id="restore-backup-btn">
                    <i class="fas fa-upload"></i> Restore from Backup
                  </button>
                </div>
              </div>
              
              <div class="form-group" style="margin-top: 20px;">
                <h4>Previous Backups</h4>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Size</th>
                        <th>Created By</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="backups-body">
                      <!-- Backups will be dynamically inserted here -->
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="form-group">
                <h4>Automatic Backups</h4>
                <div class="checkbox-group">
                  <input type="checkbox" id="auto-backup-enabled" checked>
                  <label for="auto-backup-enabled">Enable automatic backups</label>
                </div>
                <div class="form-row">
                  <div>
                    <label>Frequency</label>
                    <select id="auto-backup-frequency">
                      <option value="daily">Daily</option>
                      <option value="weekly" selected>Weekly</option>
                      <option value="monthly">Monthly</option>
                    </select>
                  </div>
                  <div>
                    <label>Retention Period (days)</label>
                    <input type="number" id="auto-backup-retention" value="30" min="1">
                  </div>
                </div>
                <div class="form-group">
                  <button class="btn" id="save-backup-settings-btn">
                    <i class="fas fa-save"></i> Save Backup Settings
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal" id="import-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Import to Inventory</h3>
          <button class="modal-close" id="import-modal-close">&times;</button>
        </div>
        <p>Are you sure you want to import the selected items to inventory?</p>
        <p class="muted">This will deduct the total amount from the cash drawer.</p>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="import-modal-cancel">Cancel</button>
          <button class="btn" id="import-confirm">Import</button>
        </div>
      </div>
    </div>
    
    <!-- Import to Warehouse Modal -->
    <div class="modal" id="import-warehouse-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Import to Warehouse</h3>
          <button class="modal-close" id="import-warehouse-modal-close">&times;</button>
        </div>
        <p>Are you sure you want to import the selected items directly to warehouse?</p>
        <p class="muted">This will NOT deduct the amount from the cash drawer.</p>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="import-warehouse-modal-cancel">Cancel</button>
          <button class="btn" id="import-warehouse-confirm">Import</button>
        </div>
      </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal" id="transfer-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Transfer to Warehouse</h3>
          <button class="modal-close" id="transfer-modal-close">&times;</button>
        </div>
        <p>Are you sure you want to transfer the selected items to warehouse?</p>
        <div class="form-group">
          <label>Transfer Notes</label>
          <textarea id="transfer-notes-input" rows="3" placeholder="Add notes about this transfer..."></textarea>
          <input type="hidden" id="transfer-notes">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="transfer-modal-cancel">Cancel</button>
          <button class="btn" id="transfer-confirm">Transfer</button>
        </div>
      </div>
    </div>
    
    <!-- Edit Item Modal -->
    <div class="modal" id="edit-item-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Inventory Item</h3>
          <button class="modal-close" id="edit-item-modal-close">&times;</button>
        </div>
        <input type="hidden" id="edit-item-id">
        <div class="form-row">
          <div>
            <label>Device</label>
            <input type="text" id="edit-device" placeholder="Device Name">
          </div>
          <div>
            <label>Color</label>
            <input type="text" id="edit-color" placeholder="Color">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Storage</label>
            <input type="text" id="edit-storage" placeholder="Storage">
          </div>
          <div>
            <label>Carrier</label>
            <select id="edit-carrier">
              <option value="Unknown">Unknown</option>
              <option value="Unlocked">Unlocked</option>
              <option value="AT&T">AT&T</option>
              <option value="Verizon">Verizon</option>
              <option value="T-Mobile">T-Mobile</option>
              <option value="Sprint">Sprint</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Condition</label>
            <select id="edit-condition">
              <option value="A">A - Like New</option>
              <option value="B">B - Good</option>
              <option value="C">C - Fair</option>
              <option value="D">D - Poor</option>
            </select>
          </div>
          <div>
            <label>Price Paid</label>
            <input type="number" id="edit-price" placeholder="Price" step="0.01">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="edit-notes" rows="3" placeholder="Additional notes..."></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="edit-item-modal-cancel">Cancel</button>
          <button class="btn" id="edit-item-confirm">Save Changes</button>
        </div>
      </div>
    </div>
    
    <!-- Add Transaction Modal -->
    <div class="modal" id="add-transaction-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Transaction</h3>
          <button class="modal-close" id="add-transaction-modal-close">&times;</button>
        </div>
        <div class="form-group">
          <label>Transaction Type</label>
          <select id="transaction-type">
            <option value="deposit">Deposit (Add Cash)</option>
            <option value="withdrawal">Withdrawal (Remove Cash)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="transaction-amount" placeholder="Amount" step="0.01">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="transaction-description" rows="3" placeholder="Transaction description..."></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="add-transaction-modal-cancel">Cancel</button>
          <button class="btn" id="add-transaction-confirm">Add Transaction</button>
        </div>
      </div>
    </div>
    
    <!-- Open Cash Drawer Modal -->
    <div class="modal" id="open-drawer-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Open Cash Drawer</h3>
          <button class="modal-close" id="open-drawer-modal-close">&times;</button>
        </div>
        <form id="open-drawer-form">
          <div class="form-group">
            <label>Opening Amount</label>
            <input type="number" id="opening-amount" placeholder="Amount" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="open-drawer-notes" rows="3" placeholder="Additional notes..."></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="open-drawer-modal-cancel">Cancel</button>
            <button type="submit" class="btn">Open Drawer</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Loader -->
    <div class="loader" id="loader">
      <div class="spinner"></div>
    </div>
  </div>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBxJlPJHgOvxCvMjGN_kxLvg-ylxR2tHH8",
      authDomain: "inventory-system-demo.firebaseapp.com",
      projectId: "inventory-system-demo",
      storageBucket: "inventory-system-demo.appspot.com",
      messagingSenderId: "123456789012",
      appId: "1:123456789012:web:1234567890abcdef"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // State management
    const state = {
      rows: [],
      manual: [],
      inventory: [],
      cashDrawer: null,
      transactions: [],
      logs: [],
      customers: [],
      invoices: [],
      payments: [],
      currentPage: 1,
      itemsPerPage: 10,
      filters: {
        status: 'in_stock',
        location: 'store',
        search: ''
      },
      warehouseFilters: {
        status: 'in_stock',
        carrier: 'all',
        condition: 'all',
        deviceType: 'all',
        search: ''
      },
      invoiceFilters: {
        status: 'all',
        search: ''
      },
      customerFilters: {
        search: ''
      },
      settings: {
        conditionAgeDays: 45,
        taxRate: 8.25,
        invoiceDueDays: 30,
        lowStockThreshold: 5,
        companyName: 'Your Company Name',
        companyAddress: 'Your Company Address',
        companyPhone: 'Your Company Phone',
        companyEmail: 'Your Company Email'
      },
      users: [
        {
          id: 'admin',
          username: 'admin',
          role: 'admin',
          email: 'admin@example.com',
          lastLogin: new Date().toISOString(),
          status: 'active'
        }
      ],
      backups: [],
      backupSettings: {
        autoBackupEnabled: true,
        frequency: 'weekly',
        retention: 30
      },
      selectedItems: [],
      adminUnlocked: false,
      warehouseUnlocked: false,
      currentCustomer: null,
      currentInvoice: null,
      dataInitialized: false
    };
    
    // Helper functions
    function formatMoney(cents) {
      return '$' + (cents / 100).toFixed(2);
    }

    function escapeHtml(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function showLoader() {
      document.getElementById('loader').classList.add('show');
    }

    function hideLoader() {
      document.getElementById('loader').classList.remove('show');
    }

    function showAlert(type, message) {
      const alertsContainer = document.getElementById('alerts-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${type}`;
      
      let icon = '';
      if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
      else if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
      else if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';
      else if (type === 'info') icon = '<i class="fas fa-info-circle"></i>';
      
      alertDiv.innerHTML = `${icon} ${message}`;
      alertsContainer.appendChild(alertDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => {
          alertsContainer.removeChild(alertDiv);
        }, 300);
      }, 5000);
    }

    function getDaysSincePurchase(dateStr) {
      if (!dateStr) return null;
      
      const purchaseDate = new Date(dateStr);
      if (isNaN(purchaseDate.getTime())) return null;
      
      const today = new Date();
      const diffTime = Math.abs(today - purchaseDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }

    function checkDeviceCondition(purchaseDate) {
      const days = getDaysSincePurchase(purchaseDate);
      
      if (days === null) return { condition: 'NIB', warning: null };
      
      if (days > state.settings.conditionAgeDays) {
        return { 
          condition: "B", 
          warning: '<span class="tag error warning-tag">B Grade (45+ days)</span>' 
        };
      }
      
      return { condition: 'NIB', warning: null };
    }

    function addSystemLog(action, details) {
      const log = {
        timestamp: new Date().toISOString(),
        action: action,
        details: details
      };
      
      state.logs.unshift(log);
      
      // Keep logs to a reasonable size
      if (state.logs.length > 1000) {
        state.logs = state.logs.slice(0, 1000);
      }
      
      // If admin panel is open, update the logs display
      if (state.adminUnlocked) {
        renderSystemLogs();
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    function formatShortDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // IMEI lookup function
    function lookupIMEIs() {
      const imeisText = document.getElementById('imeis').value;
      if (!imeisText.trim()) {
        showAlert('error', 'Please enter at least one IMEI.');
        return;
      }
      
      const imeis = imeisText.split(/[\s,;]+/).map(s => s.trim()).filter(Boolean);
      if (!imeis.length) {
        showAlert('error', 'Please enter valid IMEIs.');
        return;
      }
      
      showLoader();
      
      fetch('/api/intake', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imeis: imeis })
      })
      .then(response => response.json())
      .then(data => {
        hideLoader();
        
        if (data.items && data.items.length) {
          state.rows = data.items;
          renderResults();
          document.getElementById('results-container').style.display = 'block';
        } else {
          showAlert('error', 'No results returned.');
        }
      })
      .catch(error => {
        hideLoader();
        showAlert('error', 'Error looking up IMEIs: ' + error.message);
        console.error('Error:', error);
      });
    }

    // Render results table
    function renderResults() {
      const tbody = document.getElementById('results-body');
      tbody.innerHTML = '';
      
      state.rows.forEach((r, idx) => {
        if (!r.ok) {
          const errorRow = document.createElement('tr');
          errorRow.innerHTML = `
            <td></td>
            <td colspan="9" class="error">
              <i class="fas fa-exclamation-circle"></i>
              IMEI ${escapeHtml(r.imei)}  ${escapeHtml(r.error || 'error')}
            </td>
          `;
          tbody.appendChild(errorRow);
          return;
        }
        
        // Check device condition based on purchase date
        const conditionCheck = checkDeviceCondition(r.estimated_purchase_date);
        
        // Add warning for iCloud lock
        const iCloudWarning = r.icloud_lock_on ? 
          '<span class="tag error warning-tag">iCloud Lock: ON</span>' : '';
        
        // Combine all warnings
        const warnings = (conditionCheck.warning || '') + iCloudWarning;
        
        // Convert cents to dollars for display
        const suggestedPriceDollars = r.suggested_price_cents ? 
          (r.suggested_price_cents / 100).toFixed(2) : '';
        
        const row = document.createElement('tr');
        row.className = 'result-row';
        row.setAttribute('data-idx', idx);
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="select-item" data-idx="${idx}">
          </td>
          <td><code>${escapeHtml(r.imei)}</code></td>
          <td>
            ${escapeHtml(r.device_display || ((r.manufacturer || '') + ' ' + (r.model_name || '')))}
            ${warnings}
            ${r.estimated_purchase_date ? 
              `<div class="muted">Est. Purchase: ${r.estimated_purchase_date} 
               ${typeof r.estimated_purchase_age_days === 'number' ? 
                 `(${r.estimated_purchase_age_days}d ago)` : ''}
               </div>` : ''}
          </td>
          <td>${escapeHtml(r.color || '')}</td>
          <td>${escapeHtml(r.storage || '')}</td>
          <td>
            <select class="carrier-select" data-idx="${idx}">
              <option value="Unknown" ${r.carrier === 'Unknown' ? 'selected' : ''}>Unknown</option>
              <option value="Unlocked" ${r.carrier === 'Unlocked' ? 'selected' : ''}>Unlocked</option>
              <option value="AT&T" ${r.carrier === 'AT&T' ? 'selected' : ''}>AT&T</option>
              <option value="Verizon" ${r.carrier === 'Verizon' ? 'selected' : ''}>Verizon</option>
              <option value="T-Mobile" ${r.carrier === 'T-Mobile' ? 'selected' : ''}>T-Mobile</option>
              <option value="Sprint" ${r.carrier === 'Sprint' ? 'selected' : ''}>Sprint</option>
              <option value="Other" ${r.carrier === 'Other' ? 'selected' : ''}>Other</option>
            </select>
          </td>
          <td>
            <select class="condition-select" data-idx="${idx}">
              <option value="NIB" ${conditionCheck.condition === 'NIB' ? 'selected' : ''}>NIB</option>
              <option value="A" ${conditionCheck.condition === 'A' ? 'selected' : ''}>A</option>
              <option value="B" ${conditionCheck.condition === 'B' ? 'selected' : ''}>B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </td>
          <td class="right">
            <input type="number" class="price-paid" data-idx="${idx}" value="${suggestedPriceDollars}" step="0.01" min="0">
          </td>
          <td>
            <input type="text" class="notes" data-idx="${idx}" placeholder="Notes...">
          </td>
        `;
        
        tbody.appendChild(row);
        
        // Hidden fields for data storage
        const hiddenFields = document.createElement('div');
        hiddenFields.style.display = 'none';
        hiddenFields.innerHTML = `
          <input type="hidden" class="imei" data-idx="${idx}" value="${escapeHtml(r.imei)}">
          <input type="hidden" class="manufacturer" data-idx="${idx}" value="${escapeHtml(r.manufacturer || '')}">
          <input type="hidden" class="model-name" data-idx="${idx}" value="${escapeHtml(r.model_name || '')}">
          <input type="hidden" class="model-code" data-idx="${idx}" value="${escapeHtml(r.model_code || '')}">
          <input type="hidden" class="device-display" data-idx="${idx}" value="${escapeHtml(r.device_display || '')}">
          <input type="hidden" class="suggested-price" data-idx="${idx}" value="${escapeHtml(String(r.suggested_price_cents || ''))}">
          <input type="hidden" class="condition-hint" data-idx="${idx}" value="${escapeHtml(String(conditionCheck.condition || ''))}">
          <input type="hidden" class="icloud-lock" data-idx="${idx}" value="${r.icloud_lock_on ? 'ON' : 'OFF'}">
        `;
        tbody.appendChild(hiddenFields);
      });
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
      
      // Update price paid when condition changes
      document.querySelectorAll('.condition-select').forEach(select => {
        select.addEventListener('change', function() {
          const idx = this.getAttribute('data-idx');
          const pricePaidInput = document.querySelector(`.price-paid[data-idx="${idx}"]`);
          
          // If condition is changed, we might want to adjust the price
          // For now, we'll keep the price the same
        });
      });
      
      // Manual rows
      state.manual.forEach((r, idx) => {
        const row = document.createElement('tr');
        row.className = 'manual-row';
        row.setAttribute('data-idx', idx);
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="select-item manual" data-idx="m${idx}" checked>
          </td>
          <td><input type="text" class="mident" data-idx="${idx}" placeholder="IMEI/Serial"></td>
          <td>${escapeHtml(r.device || '')}</td>
          <td>${escapeHtml(r.color || '')}</td>
          <td>${escapeHtml(r.storage || '')}</td>
          <td><span class="tag">${escapeHtml(r.carrier || 'Unknown')}</span></td>
          <td><div class="muted"></div></td>
          <td class="right"><input type="number" class="mpaid" data-idx="${idx}" value="${escapeHtml(String(r.unitPrice || ''))}" step="0.01" min="0" /></td>
          <td><input type="text" class="mnote" data-idx="${idx}" value="${escapeHtml(r.notes || '')}" /></td>
        </tr>`;
        
        tbody.appendChild(row);
      });
      
      // Update totals
      computeTotals();
      updateTotalDevices();
      
      // Identifier validation
      function refreshIdentifierValidation() {
        const inputs = Array.from(document.querySelectorAll('.mident'));
        const seen = new Map();
        inputs.forEach(inp => {
          const v = inp.value.trim();
          if (!v) return;
          
          if (seen.has(v)) {
            inp.classList.add('error');
            seen.get(v).classList.add('error');
          } else {
            inp.classList.remove('error');
            seen.set(v, inp);
          }
        });
      }
      
      // Update validation when identifiers change
      document.querySelectorAll('.mident').forEach(inp => {
        inp.addEventListener('input', refreshIdentifierValidation);
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].identifier = this.value.trim();
          }
        });
      });
      
      // Update state when prices change
      document.querySelectorAll('.price-paid').forEach(inp => {
        inp.addEventListener('input', computeTotals);
      });
      
      document.querySelectorAll('.mpaid').forEach(inp => {
        inp.addEventListener('input', computeTotals);
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].unitPrice = Number(this.value || 0);
          }
        });
      });
      
      // Update state when notes change
      document.querySelectorAll('.mnote').forEach(inp => {
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].notes = this.value.trim();
          }
        });
      });
      
      // Enter  focus next identifier
      const idents = Array.from(document.querySelectorAll('.mident'));
      idents.forEach((inp, i) => {
        inp.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const next = idents[i + 1];
            if (next) next.focus();
          }
        });
      });
      
      // Download CSV
      document.getElementById('download').addEventListener('click', downloadCSV);
      
      computeTotals();
      
      // Focus first empty identifier
      setTimeout(function() {
        const firstEmpty = Array.from(document.querySelectorAll('.mident')).find(inp => !inp.value);
        if (firstEmpty) firstEmpty.focus();
      }, 0);
    }

    // Compute totals
    function computeTotals() {
      let totalDollars = 0;
      
      // Add API rows
      document.querySelectorAll('.price-paid').forEach(inp => {
        const v = Number(inp.value || '');
        if (isFinite(v)) totalDollars += v;
      });
      
      // Add manual rows
      document.querySelectorAll('.mpaid').forEach(inp => {
        const v = Number(inp.value || '');
        if (isFinite(v)) totalDollars += v;
      });
      
      document.getElementById('totals').innerText = 'Total: $' + totalDollars.toFixed(2);
    }

    // Update total devices count
    function updateTotalDevices() {
      let count = 0;
      
      // Count API rows
      count += state.rows.filter(r => r.ok).length;
      
      // Count manual rows
      count += state.manual.length;
      
      document.getElementById('total-devices').innerText = `Total Devices: ${count}`;
    }

    // Download CSV
    function downloadCSV() {
      const payload = [];
      
      // API rows
      state.rows.forEach((r, idx) => {
        if (!r.ok) return;
        
        const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
        const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
        const carrierEl = document.querySelector(`.carrier-select[data-idx="${idx}"]`);
        const conditionEl = document.querySelector(`.condition-select[data-idx="${idx}"]`);
        
        const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
        const cents = isFinite(dollars) ? Math.round(dollars * 100) : ''; // Convert to cents
        const carrier = carrierEl ? carrierEl.value : (r.carrier || 'Unknown');
        const condition = conditionEl ? conditionEl.value : 'B';
        
        payload.push({
          manual: 'no',
          used: r.used ? 'yes' : 'no',
          used_source: r.used_source || '',
          identifier: r.imei,
          manufacturer: r.manufacturer || '',
          model_name: r.model_name || '',
          model_code: r.model_code || '',
          device: r.device_display || '',
          color: r.color || '',
          storage: r.storage || '',
          carrier: carrier,
          icloud_lock: r.icloud_lock_on ? 'ON' : 'OFF',
          condition: condition,
          condition_hint: r.condition_hint || '',
          estimated_purchase_date: r.estimated_purchase_date || '',
          quantity: 1,
          unit_price_cents: cents,
          line_total_cents: cents,
          suggested_price_cents: (typeof r.suggested_price_cents !== 'undefined' ? r.suggested_price_cents : ''),
          notes: (noteEl ? noteEl.value : '')
        });
      });
      
      // Manual rows
      state.manual.forEach((r, idx) => {
        const paidEl = document.querySelector(`.mpaid[data-idx="${idx}"]`);
        const noteEl = document.querySelector(`.mnote[data-idx="${idx}"]`);
        const identEl = document.querySelector(`.mident[data-idx="${idx}"]`);
        const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
        const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0; // Convert to cents
        
        payload.push({
          manual: 'yes',
          used: '',
          used_source: '',
          identifier: identEl ? identEl.value.trim() : '',
          manufacturer: '',
          model_name: '',
          model_code: '',
          device: r.device || '',
          color: r.color || '',
          storage: r.storage || '',
          carrier: r.carrier || 'Unknown',
          icloud_lock: '',
          condition: 'B',
          condition_hint: '',
          estimated_purchase_date: '',
          quantity: 1,
          unit_price_cents: cents,
          line_total_cents: cents,
          suggested_price_cents: '',
          notes: noteEl ? noteEl.value : ''
        });
      });
      
      const header = ['manual','used','used_source','identifier','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','condition','condition_hint','estimated_purchase_date','quantity','unit_price_cents','line_total_cents','suggested_price_cents','notes'];
      const lines = [header.join(',')];
      
      payload.forEach(o => {
        const row = header.map(k => {
          const v = (o[k] != null) ? String(o[k]) : '';
          return JSON.stringify(v).replace(/^\uFEFF/, '');
        }).join(',');
        lines.push(row);
      });
      
      const csv = lines.join('\n');
      
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'intake_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Show import modal
    function showImportModal() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to import.');
        return;
      }
      
      document.getElementById('import-modal').classList.add('show');
    }

    // Show import to warehouse modal
    function showImportWarehouseModal() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to import.');
        return;
      }
      
      document.getElementById('import-warehouse-modal').classList.add('show');
    }

    // Import to inventory
    function importToInventory() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      const payload = [];
      
      // Calculate total amount to deduct from cash drawer
      let totalCents = 0;
      
      selectedItems.forEach(checkbox => {
        const idx = checkbox.dataset.idx;
        let isManual = false;
        
        // Check if this is a manual item
        if (idx.startsWith('m')) {
          isManual = true;
          const manualIdx = parseInt(idx.substring(1), 10);
          
          const paidEl = document.querySelector(`.mpaid[data-idx="${manualIdx}"]`);
          const noteEl = document.querySelector(`.mnote[data-idx="${manualIdx}"]`);
          const identEl = document.querySelector(`.mident[data-idx="${manualIdx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          totalCents += cents;
          
          const manualItem = state.manual[manualIdx];
          
          payload.push({
            imei: identEl ? identEl.value.trim() : '',
            device_display: manualItem.device || '',
            color: manualItem.color || '',
            storage: manualItem.storage || '',
            condition: 'B',
            carrier: manualItem.carrier || 'Unknown',
            price_paid_cents: cents,
            notes: noteEl ? noteEl.value : ''
          });
        } else {
          const numIdx = parseInt(idx, 10);
          
          const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
          const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
          const carrierEl = document.querySelector(`.carrier-select[data-idx="${idx}"]`);
          const conditionEl = document.querySelector(`.condition-select[data-idx="${idx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          totalCents += cents;
          
          const carrier = carrierEl ? carrierEl.value : 'Unknown';
          const condition = conditionEl ? conditionEl.value : 'B';
          
          payload.push({
            imei: document.querySelector(`.imei[data-idx="${idx}"]`).value,
            manufacturer: document.querySelector(`.manufacturer[data-idx="${idx}"]`).value,
            model_name: document.querySelector(`.model-name[data-idx="${idx}"]`).value,
            model_code: document.querySelector(`.model-code[data-idx="${idx}"]`).value,
            device_display: document.querySelector(`.device-display[data-idx="${idx}"]`).value,
            color: state.rows[numIdx].color || '',
            storage: state.rows[numIdx].storage || '',
            condition: condition,
            carrier: carrier,
            price_paid_cents: cents,
            suggested_price_cents: document.querySelector(`.suggested-price[data-idx="${idx}"]`).value,
            notes: noteEl ? noteEl.value : '',
            icloud_lock_on: document.querySelector(`.icloud-lock[data-idx="${idx}"]`).value === 'ON'
          });
        }
      });
      
      // Show loader
      showLoader();
      
      // Check if cash drawer is open
      if (!state.cashDrawer || state.cashDrawer.status !== 'open') {
        hideLoader();
        showAlert('error', 'Cash drawer must be open to import items.');
        document.getElementById('import-modal').classList.remove('show');
        return;
      }
      
      // Deduct from cash drawer
      state.cashDrawer.expected_amount_cents -= totalCents;
      
      // Add system log
      addSystemLog('inventory_add', `Added ${payload.length} items to inventory. Total: ${formatMoney(totalCents)}`);
      
      // Simulate import request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('import-modal').classList.remove('show');
        
        // Add to local inventory
        payload.forEach(item => {
          state.inventory.push({
            id: Date.now() + Math.floor(Math.random() * 1000),
            imei: item.imei,
            device_display: item.device_display,
            color: item.color,
            storage: item.storage,
            condition: item.condition,
            carrier: item.carrier,
            price_paid_cents: item.price_paid_cents,
            status: 'in_stock',
            location: 'store',
            created_at: new Date().toISOString(),
            notes: item.notes
          });
        });
        
        showAlert('success', `Imported ${payload.length} items to inventory. Cash drawer balance updated.`);
        
        // Update cash drawer display
        renderCashDrawer();
        
        // If on inventory tab, refresh the view
        if (document.getElementById('inventory-tab').classList.contains('active')) {
          renderInventory();
        }
      }, 1000);
    }

    // Import to warehouse
    function importToWarehouse() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      const payload = [];
      
      selectedItems.forEach(checkbox => {
        const idx = checkbox.dataset.idx;
        let isManual = false;
        
        // Check if this is a manual item
        if (idx.startsWith('m')) {
          isManual = true;
          const manualIdx = parseInt(idx.substring(1), 10);
          
          const paidEl = document.querySelector(`.mpaid[data-idx="${manualIdx}"]`);
          const noteEl = document.querySelector(`.mnote[data-idx="${manualIdx}"]`);
          const identEl = document.querySelector(`.mident[data-idx="${manualIdx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          
          const manualItem = state.manual[manualIdx];
          
          payload.push({
            imei: identEl ? identEl.value.trim() : '',
            device_display: manualItem.device || '',
            color: manualItem.color || '',
            storage: manualItem.storage || '',
            condition: 'B',
            carrier: manualItem.carrier || 'Unknown',
            price_paid_cents: cents,
            notes: noteEl ? noteEl.value : ''
          });
        } else {
          const numIdx = parseInt(idx, 10);
          
          const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
          const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
          const carrierEl = document.querySelector(`.carrier-select[data-idx="${idx}"]`);
          const conditionEl = document.querySelector(`.condition-select[data-idx="${idx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          
          const carrier = carrierEl ? carrierEl.value : 'Unknown';
          const condition = conditionEl ? conditionEl.value : 'B';
          
          payload.push({
            imei: document.querySelector(`.imei[data-idx="${idx}"]`).value,
            manufacturer: document.querySelector(`.manufacturer[data-idx="${idx}"]`).value,
            model_name: document.querySelector(`.model-name[data-idx="${idx}"]`).value,
            model_code: document.querySelector(`.model-code[data-idx="${idx}"]`).value,
            device_display: document.querySelector(`.device-display[data-idx="${idx}"]`).value,
            color: state.rows[numIdx].color || '',
            storage: state.rows[numIdx].storage || '',
            condition: condition,
            carrier: carrier,
            price_paid_cents: cents,
            suggested_price_cents: document.querySelector(`.suggested-price[data-idx="${idx}"]`).value,
            notes: noteEl ? noteEl.value : '',
            icloud_lock_on: document.querySelector(`.icloud-lock[data-idx="${idx}"]`).value === 'ON'
          });
        }
      });
      
      // Show loader
      showLoader();
      
      // Add system log
      let totalCents = payload.reduce((sum, item) => sum + item.price_paid_cents, 0);
      addSystemLog('inventory_add', `Added ${payload.length} items directly to warehouse. Total: ${formatMoney(totalCents)}`);
      
      // Simulate import request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('import-warehouse-modal').classList.remove('show');
        
        // Add to local inventory with warehouse location
        payload.forEach(item => {
          state.inventory.push({
            id: Date.now() + Math.floor(Math.random() * 1000),
            imei: item.imei,
            device_display: item.device_display,
            color: item.color,
            storage: item.storage,
            condition: item.condition,
            carrier: item.carrier,
            price_paid_cents: item.price_paid_cents,
            status: 'in_stock',
            location: 'warehouse',
            created_at: new Date().toISOString(),
            notes: item.notes
          });
        });
        
        showAlert('success', `Imported ${payload.length} items directly to warehouse.`);
        
        // If on warehouse tab, refresh the view
        if (document.getElementById('warehouse-tab').classList.contains('active') && state.warehouseUnlocked) {
          renderWarehouse();
        }
      }, 1000);
    }

    // Reset lookup
    function resetLookup() {
      document.getElementById('imeis').value = '';
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('results-body').innerHTML = '';
      state.rows = [];
      state.manual = [];
    }

    // Add manual item
    function addManualItem(e) {
      e.preventDefault();
      const device = document.getElementById('m_device').value.trim();
      const color = document.getElementById('m_color').value.trim();
      const storage = document.getElementById('m_storage').value.trim();
      const carrier = document.getElementById('m_carrier').value || 'Unknown';
      const unitPrice = Number(document.getElementById('m_price').value || '');
      
      if (!device) {
        showAlert('error', 'Please enter a device name.');
        return;
      }
      
      state.manual.push({
        device,
        color,
        storage,
        carrier,
        unitPrice,
        notes: ''
      });
      
      // Clear inputs
      document.getElementById('m_device').value = '';
      document.getElementById('m_color').value = '';
      document.getElementById('m_storage').value = '';
      document.getElementById('m_carrier').value = 'Unknown';
      document.getElementById('m_price').value = '';
      
      // Re-render results
      renderResults();
      
      // Focus device input for next entry
      document.getElementById('m_device').focus();
    }
    
    // Add item from manual entry tab
    function addItemFromManualEntry(location) {
      const device = document.getElementById('manual_device').value.trim();
      const color = document.getElementById('manual_color').value.trim();
      const storage = document.getElementById('manual_storage').value.trim();
      const imei = document.getElementById('manual_imei').value.trim();
      const carrier = document.getElementById('manual_carrier').value;
      const condition = document.getElementById('manual_condition').value;
      const deviceType = document.getElementById('manual_type').value;
      const price = document.getElementById('manual_price').value;
      const quantity = parseInt(document.getElementById('manual_quantity').value) || 1;
      const purchaseDate = document.getElementById('manual_purchase_date').value;
      const notes = document.getElementById('manual_notes').value;
      
      if (!device) {
        showAlert('error', 'Please enter a device name.');
        return;
      }
      
      // Convert dollars to cents
      const priceCents = price ? Math.round(parseFloat(price) * 100) : 0;
      
      // Show loader
      showLoader();
      
      // Add system log
      addSystemLog('inventory_add', `Added ${quantity} ${device} directly to ${location}. Price: ${formatMoney(priceCents)}`);
      
      // Create items (one per quantity)
      const newItems = [];
      for (let i = 0; i < quantity; i++) {
        const newItem = {
          id: Date.now() + i,
          imei: imei || `MANUAL-${Date.now()}-${i}`,
          device_display: device,
          color: color,
          storage: storage,
          condition: condition,
          carrier: carrier,
          device_type: deviceType,
          price_paid_cents: priceCents,
          status: 'in_stock',
          location: location,
          created_at: new Date().toISOString(),
          purchase_date: purchaseDate || new Date().toISOString(),
          notes: notes
        };
        
        // Add to inventory
        state.inventory.push(newItem);
        newItems.push(newItem);
      }
      
      // If adding to store, deduct from cash drawer
      if (location === 'store' && state.cashDrawer) {
        state.cashDrawer.expected_amount_cents -= priceCents * quantity;
      }
      
      // Save data
      saveAllData()
        .then(() => {
          hideLoader();
          
          // Clear form
          document.getElementById('manual_device').value = '';
          document.getElementById('manual_color').value = '';
          document.getElementById('manual_storage').value = '';
          document.getElementById('manual_imei').value = '';
          document.getElementById('manual_carrier').value = 'Unknown';
          document.getElementById('manual_condition').value = 'B';
          document.getElementById('manual_type').value = 'Phone';
          document.getElementById('manual_price').value = '';
          document.getElementById('manual_quantity').value = '1';
          document.getElementById('manual_purchase_date').value = '';
          document.getElementById('manual_notes').value = '';
          
          showAlert('success', `Added ${quantity} item(s) to ${location}.`);
          
          // Render recent items
          renderRecentItems();
          
          // Update cash drawer if needed
          if (location === 'store' && state.cashDrawer) {
            renderCashDrawer();
          }
        })
        .catch(error => {
          hideLoader();
          console.error('Error adding item:', error);
          showAlert('error', 'Error adding item: ' + error.message);
        });
    }
    
    // Render recent items
    function renderRecentItems() {
      const tbody = document.getElementById('recent-items-body');
      tbody.innerHTML = '';
      
      // Get the 10 most recent items
      const recentItems = [...state.inventory]
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 10);
      
      if (recentItems.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" class="center">No items added yet</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      recentItems.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td><code>${escapeHtml(item.imei || '')}</code></td>
          <td>${escapeHtml(item.device_display || '')}</td>
          <td><span class="tag">${escapeHtml(item.condition || 'B')}</span></td>
          <td>
            <span class="tag ${item.location === 'store' ? 'info' : 'warning'}">
              ${item.location === 'store' ? 'Store' : 'Warehouse'}
            </span>
          </td>
          <td class="right">${formatMoney(item.price_paid_cents || 0)}</td>
          <td>${formatShortDate(item.created_at)}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Load inventory
    function loadInventory() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderInventory();
      }, 500);
    }

    // Render inventory
    function renderInventory() {
      const tbody = document.getElementById('inventory-body');
      tbody.innerHTML = '';
      
      // Filter inventory based on current filters
      const filtered = state.inventory.filter(item => {
        // Status filter
        if (state.filters.status !== 'all' && item.status !== state.filters.status) {
          return false;
        }
        
        // Location filter
        if (state.filters.location !== 'all' && item.location !== state.filters.location) {
          return false;
        }
        
        // Search filter
        if (state.filters.search) {
          const search = state.filters.search.toLowerCase();
          return (
            (item.imei && item.imei.toLowerCase().includes(search)) ||
            (item.device_display && item.device_display.toLowerCase().includes(search))
          );
        }
        
        return true;
      });
      
      // Pagination
      const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const paginatedItems = filtered.slice(start, end);
      
      // Render items
      paginatedItems.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="inventory-select-item" value="${item.id}">
          </td>
          <td><code>${escapeHtml(item.imei || '')}</code></td>
          <td>${escapeHtml(item.device_display || '')}</td>
          <td><span class="tag">${escapeHtml(item.condition || 'B')}</span></td>
          <td><span class="tag">${escapeHtml(item.carrier || 'Unknown')}</span></td>
          <td class="right">${formatMoney(item.price_paid_cents || 0)}</td>
          <td>
            <span class="tag ${item.status === 'in_stock' ? 'success' : item.status === 'sold' ? 'info' : 'warning'}">
              ${item.status === 'in_stock' ? 'In Stock' : item.status === 'sold' ? 'Sold' : 'Transferred'}
            </span>
          </td>
          <td>
            <span class="tag ${item.location === 'store' ? 'info' : 'warning'}">
              ${item.location === 'store' ? 'Store' : 'Warehouse'}
            </span>
          </td>
          <td>${formatShortDate(item.created_at)}</td>
          <td>
            <button class="btn btn-secondary edit-item" data-id="${item.id}">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Pagination controls
      const pagination = document.getElementById('inventory-pagination');
      pagination.innerHTML = '';
      
      if (totalPages > 1) {
        const prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.innerHTML = '&laquo; Prev';
        if (state.currentPage === 1) {
          prevLink.classList.add('disabled');
        }
        
        prevLink.onclick = (e) => {
          e.preventDefault();
          if (state.currentPage > 1) {
            state.currentPage--;
            renderInventory();
          }
        };
        
        pagination.appendChild(prevLink);
        
        for (let i = 1; i <= totalPages; i++) {
          const pageLink = document.createElement('a');
          pageLink.href = '#';
          pageLink.innerText = i;
          if (i === state.currentPage) {
            pageLink.classList.add('active');
          }
          
          pageLink.onclick = (e) => {
            e.preventDefault();
            state.currentPage = i;
            renderInventory();
          };
          
          pagination.appendChild(pageLink);
        }
        
        const nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.innerHTML = 'Next &raquo;';
        if (state.currentPage === totalPages) {
          nextLink.classList.add('disabled');
        }
        
        nextLink.onclick = (e) => {
          e.preventDefault();
          if (end < filtered.length) {
            state.currentPage++;
            renderInventory();
          }
        };
        
        pagination.appendChild(nextLink);
      }
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('inventory-select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.inventory-select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
      
      // Edit buttons
      document.querySelectorAll('.edit-item').forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-id');
          showEditItemModal(itemId);
        });
      });
    }

    // Show edit item modal
    function showEditItemModal(itemId) {
      const item = state.inventory.find(i => i.id == itemId);
      if (!item) return;
      
      document.getElementById('edit-item-id').value = item.id;
      document.getElementById('edit-device').value = item.device_display || '';
      document.getElementById('edit-color').value = item.color || '';
      document.getElementById('edit-storage').value = item.storage || '';
      document.getElementById('edit-carrier').value = item.carrier || 'Unknown';
      document.getElementById('edit-condition').value = item.condition || 'B';
      document.getElementById('edit-price').value = item.price_paid_cents ? (item.price_paid_cents / 100).toFixed(2) : '';
      document.getElementById('edit-notes').value = item.notes || '';
      
      document.getElementById('edit-item-modal').classList.add('show');
    }

    // Save edited item
    function saveEditedItem() {
      const itemId = document.getElementById('edit-item-id').value;
      const item = state.inventory.find(i => i.id == itemId);
      if (!item) return;
      
      const oldValues = { ...item };
      
      // Update item
      item.device_display = document.getElementById('edit-device').value;
      item.color = document.getElementById('edit-color').value;
      item.storage = document.getElementById('edit-storage').value;
      item.carrier = document.getElementById('edit-carrier').value;
      item.condition = document.getElementById('edit-condition').value;
      
      const pricePaid = Number(document.getElementById('edit-price').value);
      item.price_paid_cents = isFinite(pricePaid) ? Math.round(pricePaid * 100) : 0;
      
      item.notes = document.getElementById('edit-notes').value;
      
      // Add system log
      addSystemLog('inventory_edit', `Edited item ${item.imei}: ${oldValues.device_display}  ${item.device_display}`);
      
      document.getElementById('edit-item-modal').classList.remove('show');
      showAlert('success', 'Item updated successfully.');
      
      // Re-render inventory
      renderInventory();
    }

    // Show transfer modal
    function showTransferModal() {
      const selectedItems = document.querySelectorAll('.inventory-select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to transfer.');
        return;
      }
      
      document.getElementById('transfer-modal').classList.add('show');
    }

    // Transfer to warehouse
    function transferToWarehouse() {
      const selectedItems = document.querySelectorAll('.inventory-select-item:checked');
      const itemIds = Array.from(selectedItems).map(checkbox => checkbox.value);
      const notes = document.getElementById('transfer-notes-input').value;
      
      document.getElementById('transfer-notes').value = notes;
      
      // Show loader
      showLoader();
      
      // Add system log
      addSystemLog('transfer', `Transferred ${itemIds.length} items to warehouse. Notes: ${notes}`);
      
      // Update items in local state
      itemIds.forEach(id => {
        const item = state.inventory.find(i => i.id == id);
        if (item) {
          item.location = 'warehouse';
          item.status = 'transferred';
        }
      });
      
      // Save data
      saveAllData()
        .then(() => {
          hideLoader();
          document.getElementById('transfer-modal').classList.remove('show');
          
          showAlert('success', `Transferred ${itemIds.length} items to warehouse.`);
          
          // Re-render inventory
          renderInventory();
        })
        .catch(error => {
          hideLoader();
          console.error('Error transferring items:', error);
          showAlert('error', 'Error transferring items: ' + error.message);
        });
    }
    
    // Invoice functions
    function renderInvoices() {
      const tbody = document.getElementById('invoices-body');
      tbody.innerHTML = '';
      
      // Filter invoices based on current filters
      const filtered = state.invoices.filter(invoice => {
        // Status filter
        if (state.invoiceFilters.status !== 'all') {
          // Calculate payments
          const payments = state.payments.filter(pay => pay.invoice_id === invoice.id);
          const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
          const balance = invoice.total_cents - totalPaid;
          
          // Determine status
          let status = 'pending';
          if (balance <= 0) {
            status = 'paid';
          } else if (totalPaid > 0) {
            status = 'partial';
          } else if (new Date(invoice.due_date) < new Date()) {
            status = 'overdue';
          }
          
          if (status !== state.invoiceFilters.status) {
            return false;
          }
        }
        
        // Search filter
        if (state.invoiceFilters.search) {
          const search = state.invoiceFilters.search.toLowerCase();
          const customer = state.customers.find(c => c.id === invoice.customer_id);
          
          return (
            (invoice.invoice_number && invoice.invoice_number.toLowerCase().includes(search)) ||
            (customer && customer.name && customer.name.toLowerCase().includes(search))
          );
        }
        
        return true;
      });
      
      // Sort by date (newest first)
      const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Pagination
      const totalPages = Math.ceil(sorted.length / state.itemsPerPage);
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const paginatedItems = sorted.slice(start, end);
      
      if (paginatedItems.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="7" class="center">No invoices found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      paginatedItems.forEach(invoice => {
        const row = document.createElement('tr');
        
        // Get customer
        const customer = state.customers.find(c => c.id === invoice.customer_id);
        const customerName = customer ? customer.name : 'Unknown';
        
        // Calculate payments
        const payments = state.payments.filter(pay => pay.invoice_id === invoice.id);
        const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
        const balance = invoice.total_cents - totalPaid;
        
        // Determine status
        let status = 'pending';
        if (balance <= 0) {
          status = 'paid';
        } else if (totalPaid > 0) {
          status = 'partial';
        } else if (new Date(invoice.due_date) < new Date()) {
          status = 'overdue';
        }
        
        row.innerHTML = `
          <td>${escapeHtml(invoice.invoice_number)}</td>
          <td>${escapeHtml(customerName)}</td>
          <td>${formatShortDate(invoice.date)}</td>
          <td>${formatShortDate(invoice.due_date)}</td>
          <td class="right">${formatMoney(invoice.total_cents)}</td>
          <td>
            <span class="tag ${status === 'paid' ? 'success' : status === 'partial' ? 'warning' : status === 'overdue' ? 'error' : 'info'}">
              ${status.charAt(0).toUpperCase() + status.slice(1)}
            </span>
          </td>
          <td>
            <button class="btn btn-secondary view-invoice" data-id="${invoice.id}">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-secondary edit-invoice" data-id="${invoice.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-secondary print-invoice" data-id="${invoice.id}">
              <i class="fas fa-print"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Pagination controls
      const pagination = document.getElementById('invoices-pagination');
      pagination.innerHTML = '';
      
      if (totalPages > 1) {
        const prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.innerHTML = '&laquo; Prev';
        if (state.currentPage === 1) {
          prevLink.classList.add('disabled');
        }
        
        prevLink.onclick = (e) => {
          e.preventDefault();
          if (state.currentPage > 1) {
            state.currentPage--;
            renderInvoices();
          }
        };
        
        pagination.appendChild(prevLink);
        
        for (let i = 1; i <= totalPages; i++) {
          const pageLink = document.createElement('a');
          pageLink.href = '#';
          pageLink.innerText = i;
          if (i === state.currentPage) {
            pageLink.classList.add('active');
          }
          
          pageLink.onclick = (e) => {
            e.preventDefault();
            state.currentPage = i;
            renderInvoices();
          };
          
          pagination.appendChild(pageLink);
        }
        
        const nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.innerHTML = 'Next &raquo;';
        if (state.currentPage === totalPages) {
          nextLink.classList.add('disabled');
        }
        
        nextLink.onclick = (e) => {
          e.preventDefault();
          if (end < sorted.length) {
            state.currentPage++;
            renderInvoices();
          }
        };
        
        pagination.appendChild(nextLink);
      }
      
      // Add event listeners to buttons
      document.querySelectorAll('.view-invoice').forEach(button => {
        button.addEventListener('click', function() {
          const invoiceId = this.getAttribute('data-id');
          viewInvoiceDetails(invoiceId);
        });
      });
      
      document.querySelectorAll('.edit-invoice').forEach(button => {
        button.addEventListener('click', function() {
          const invoiceId = this.getAttribute('data-id');
          showEditInvoiceModal(invoiceId);
        });
      });
      
      document.querySelectorAll('.print-invoice').forEach(button => {
        button.addEventListener('click', function() {
          const invoiceId = this.getAttribute('data-id');
          printInvoice(invoiceId);
        });
      });
    }
    
    function viewInvoiceDetails(invoiceId) {
      const invoice = state.invoices.find(inv => inv.id == invoiceId);
      if (!invoice) return;
      
      state.currentInvoice = invoice;
      
      // Get customer
      const customer = state.customers.find(c => c.id === invoice.customer_id);
      const customerName = customer ? customer.name : 'Unknown';
      
      // Update invoice details
      document.getElementById('invoice-detail-number').textContent = invoice.invoice_number;
      document.getElementById('invoice-detail-customer').textContent = customerName;
      document.getElementById('invoice-detail-date').textContent = formatShortDate(invoice.date);
      document.getElementById('invoice-detail-due-date').textContent = formatShortDate(invoice.due_date);
      
      // Calculate payments
      const payments = state.payments.filter(pay => pay.invoice_id === invoice.id);
      const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
      const balance = invoice.total_cents - totalPaid;
      
      // Determine status
      let status = 'pending';
      if (balance <= 0) {
        status = 'paid';
      } else if (totalPaid > 0) {
        status = 'partial';
      } else if (new Date(invoice.due_date) < new Date()) {
        status = 'overdue';
      }
      
      document.getElementById('invoice-detail-status').innerHTML = `
        <span class="tag ${status === 'paid' ? 'success' : status === 'partial' ? 'warning' : status === 'overdue' ? 'error' : 'info'}">
          ${status.charAt(0).toUpperCase() + status.slice(1)}
        </span>
      `;
      
      // Update financial information
      document.getElementById('invoice-detail-subtotal').textContent = formatMoney(invoice.subtotal_cents);
      document.getElementById('invoice-detail-tax').textContent = formatMoney(invoice.tax_cents);
      document.getElementById('invoice-detail-total').textContent = formatMoney(invoice.total_cents);
      document.getElementById('invoice-detail-paid').textContent = formatMoney(totalPaid);
      document.getElementById('invoice-detail-balance').textContent = formatMoney(balance);
      
      // Update notes
      document.getElementById('invoice-detail-notes').textContent = invoice.notes || '';
      
      // Render invoice items
      renderInvoiceItems(invoice);
      
      // Render invoice payments
      renderInvoicePayments(invoice.id);
      
      // Show invoice detail panel
      document.getElementById('invoice-detail').style.display = 'block';
    }
    
    function renderInvoiceItems(invoice) {
      const tbody = document.getElementById('invoice-items-body');
      tbody.innerHTML = '';
      
      if (!invoice.items || invoice.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="5" class="center">No items found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      invoice.items.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${escapeHtml(item.name || '')}</td>
          <td>${escapeHtml(item.description || '')}</td>
          <td class="right">${item.quantity}</td>
          <td class="right">${formatMoney(item.unit_price_cents)}</td>
          <td class="right">${formatMoney(item.total_cents)}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    function renderInvoicePayments(invoiceId) {
      const tbody = document.getElementById('invoice-payments-body');
      tbody.innerHTML = '';
      
      const payments = state.payments
        .filter(pay => pay.invoice_id === invoiceId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (payments.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="center">No payments found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      payments.forEach(payment => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${formatShortDate(payment.date)}</td>
          <td class="right">${formatMoney(payment.amount_cents)}</td>
          <td>${escapeHtml(payment.method || '')}</td>
          <td>${escapeHtml(payment.notes || '')}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    function showCreateInvoiceFromItemsModal() {
      // Get selected items
      const selectedCheckboxes = document.querySelectorAll('.warehouse-select-item:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
      
      if (selectedIds.length === 0) {
        showAlert('error', 'Please select at least one item to create an invoice.');
        return;
      }
      
      // Get selected items
      const selectedItems = state.inventory.filter(item => selectedIds.includes(item.id.toString()));
      
      // Create modal HTML
      const modalHTML = `
        <div class="modal" id="create-invoice-modal">
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h3>Create Invoice</h3>
              <button class="modal-close" id="create-invoice-modal-close">&times;</button>
            </div>
            
            <div class="form-group">
              <label>Customer</label>
              <select id="invoice-customer" required>
                <option value="">Select Customer</option>
                ${state.customers.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('')}
              </select>
            </div>
            
            <div class="form-row">
              <div>
                <label>Invoice Date</label>
                <input type="date" id="invoice-date" value="${new Date().toISOString().slice(0, 10)}" required>
              </div>
              <div>
                <label>Due Date</label>
                <input type="date" id="invoice-due-date" value="${new Date(Date.now() + state.settings.invoiceDueDays * 86400000).toISOString().slice(0, 10)}" required>
              </div>
            </div>
            
            <div class="form-group">
              <label>Selected Items (${selectedItems.length})</label>
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Description</th>
                      <th>Quantity</th>
                      <th>Unit Price</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody id="invoice-items-preview">
                    ${selectedItems.map((item, idx) => `
                      <tr>
                        <td>${escapeHtml(item.device_display || '')}</td>
                        <td>
                          <input type="text" id="item-description-${idx}" value="${escapeHtml(item.color || '')} ${escapeHtml(item.storage || '')} ${escapeHtml(item.condition || 'B')} ${escapeHtml(item.carrier || 'Unknown')}">
                        </td>
                        <td>
                          <input type="number" id="item-quantity-${idx}" value="1" min="1" style="width: 60px;" data-idx="${idx}">
                        </td>
                        <td>
                          <input type="number" id="item-price-${idx}" value="${(item.price_paid_cents / 100).toFixed(2)}" step="0.01" min="0" style="width: 100px;" data-idx="${idx}">
                        </td>
                        <td class="right item-total" data-idx="${idx}">${formatMoney(item.price_paid_cents)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="4" class="right">Subtotal:</td>
                      <td class="right" id="invoice-subtotal">${formatMoney(selectedItems.reduce((sum, item) => sum + (item.price_paid_cents || 0), 0))}</td>
                    </tr>
                    <tr>
                      <td colspan="3" class="right">Tax Rate:</td>
                      <td>
                        <input type="number" id="invoice-tax-rate" value="${state.settings.taxRate}" step="0.01" min="0" style="width: 100px;">%
                      </td>
                      <td class="right" id="invoice-tax">${formatMoney(selectedItems.reduce((sum, item) => sum + (item.price_paid_cents || 0), 0) * state.settings.taxRate / 100)}</td>
                    </tr>
                    <tr>
                      <td colspan="4" class="right"><strong>Total:</strong></td>
                      <td class="right" id="invoice-total"><strong>${formatMoney(selectedItems.reduce((sum, item) => sum + (item.price_paid_cents || 0), 0) * (1 + state.settings.taxRate / 100))}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
            <div class="form-group">
              <label>Notes</label>
              <textarea id="invoice-notes" rows="3" placeholder="Invoice notes..."></textarea>
            </div>
            
            <div class="modal-footer">
              <button class="btn btn-secondary" id="create-invoice-modal-cancel">Cancel</button>
              <button class="btn" id="create-invoice-confirm">Create Invoice</button>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to body
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHTML;
      document.body.appendChild(modalContainer.firstChild);
      
      // Show modal
      document.getElementById('create-invoice-modal').classList.add('show');
      
      // Add event listeners
      document.getElementById('create-invoice-modal-close').addEventListener('click', () => {
        document.getElementById('create-invoice-modal').remove();
      });
      
      document.getElementById('create-invoice-modal-cancel').addEventListener('click', () => {
        document.getElementById('create-invoice-modal').remove();
      });
      
      document.getElementById('create-invoice-confirm').addEventListener('click', () => {
        createInvoiceFromItems(selectedIds);
      });
      
      // Add event listeners to quantity and price inputs
      selectedItems.forEach((item, idx) => {
        document.getElementById(`item-quantity-${idx}`).addEventListener('input', updateInvoiceTotals);
        document.getElementById(`item-price-${idx}`).addEventListener('input', updateInvoiceTotals);
      });
      
      // Add event listener to tax rate input
      document.getElementById('invoice-tax-rate').addEventListener('input', updateInvoiceTotals);
    }
    
    function updateInvoiceTotals() {
      // Calculate item totals
      const itemRows = document.querySelectorAll('#invoice-items-preview tr');
      let subtotal = 0;
      
      itemRows.forEach((row, idx) => {
        const quantity = parseInt(document.getElementById(`item-quantity-${idx}`).value) || 1;
        const price = parseFloat(document.getElementById(`item-price-${idx}`).value) || 0;
        const total = quantity * price * 100; // Convert to cents
        
        document.querySelector(`.item-total[data-idx="${idx}"]`).textContent = formatMoney(total);
        subtotal += total;
      });
      
      // Update subtotal
      document.getElementById('invoice-subtotal').textContent = formatMoney(subtotal);
      
      // Calculate tax
      const taxRate = parseFloat(document.getElementById('invoice-tax-rate').value) || 0;
      const tax = subtotal * taxRate / 100;
      document.getElementById('invoice-tax').textContent = formatMoney(tax);
      
      // Update total
      document.getElementById('invoice-total').textContent = formatMoney(subtotal + tax);
    }
    
    function createInvoiceFromItems(selectedIds) {
      const customerId = document.getElementById('invoice-customer').value;
      const invoiceDate = document.getElementById('invoice-date').value;
      const invoiceDueDate = document.getElementById('invoice-due-date').value;
      const notes = document.getElementById('invoice-notes').value;
      
      if (!customerId) {
        showAlert('error', 'Please select a customer.');
        return;
      }
      
      if (!invoiceDate) {
        showAlert('error', 'Please enter an invoice date.');
        return;
      }
      
      if (!invoiceDueDate) {
        showAlert('error', 'Please enter a due date.');
        return;
      }
      
      // Get selected items
      const selectedItems = state.inventory.filter(item => selectedIds.includes(item.id.toString()));
      
      // Create invoice items
      const invoiceItems = [];
      let subtotalCents = 0;
      
      selectedItems.forEach((item, idx) => {
        const quantity = parseInt(document.getElementById(`item-quantity-${idx}`).value) || 1;
        const unitPrice = parseFloat(document.getElementById(`item-price-${idx}`).value) || 0;
        const description = document.getElementById(`item-description-${idx}`).value;
        const totalCents = Math.round(quantity * unitPrice * 100);
        
        invoiceItems.push({
          id: Date.now() + idx,
          inventory_id: item.id,
          name: item.device_display || '',
          description: description,
          quantity: quantity,
          unit_price_cents: Math.round(unitPrice * 100),
          total_cents: totalCents
        });
        
        subtotalCents += totalCents;
      });
      
      // Calculate tax
      const taxRate = parseFloat(document.getElementById('invoice-tax-rate').value) || 0;
      const taxCents = Math.round(subtotalCents * taxRate / 100);
      const totalCents = subtotalCents + taxCents;
      
      // Create invoice number
      const invoiceNumber = `INV-${Date.now().toString().slice(-6)}`;
      
      // Create invoice
      const invoice = {
        id: Date.now(),
        invoice_number: invoiceNumber,
        customer_id: customerId,
        date: invoiceDate,
        due_date: invoiceDueDate,
        subtotal_cents: subtotalCents,
        tax_cents: taxCents,
        total_cents: totalCents,
        notes: notes,
        items: invoiceItems,
        created_at: new Date().toISOString()
      };
      
      // Show loader
      showLoader();
      
      // Add invoice to state
      state.invoices.push(invoice);
      
      // Update inventory items status
      selectedIds.forEach(id => {
        const item = state.inventory.find(i => i.id == id);
        if (item) {
          item.status = 'sold';
        }
      });
      
      // Add system log
      addSystemLog('invoice', `Created invoice ${invoiceNumber} for ${selectedItems.length} items. Total: ${formatMoney(totalCents)}`);
      
      // Save data
      saveAllData()
        .then(() => {
          hideLoader();
          document.getElementById('create-invoice-modal').remove();
          
          showAlert('success', `Invoice ${invoiceNumber} created successfully.`);
          
          // Navigate to invoices tab
          document.querySelector('.tab[data-tab="invoices"]').click();
        })
        .catch(error => {
          hideLoader();
          console.error('Error creating invoice:', error);
          showAlert('error', 'Error creating invoice: ' + error.message);
        });
    }
    
    function printInvoice(invoiceId) {
      const invoice = state.invoices.find(inv => inv.id == invoiceId);
      if (!invoice) return;
      
      // Get customer
      const customer = state.customers.find(c => c.id === invoice.customer_id);
      
      // Calculate payments
      const payments = state.payments.filter(pay => pay.invoice_id === invoice.id);
      const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
      const balance = invoice.total_cents - totalPaid;
      
      // Determine status
      let status = 'pending';
      if (balance <= 0) {
        status = 'paid';
      } else if (totalPaid > 0) {
        status = 'partial';
      } else if (new Date(invoice.due_date) < new Date()) {
        status = 'overdue';
      }
      
      // Create printable invoice
      const printWindow = window.open('', '_blank');
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice ${invoice.invoice_number}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              color: #333;
            }
            .invoice-header {
              display: flex;
              justify-content: space-between;
              margin-bottom: 30px;
            }
            .company-info {
              flex: 1;
            }
            .invoice-info {
              text-align: right;
            }
            .invoice-title {
              font-size: 24px;
              font-weight: bold;
              margin-bottom: 10px;
              color: #18344a;
            }
            .customer-info {
              margin-bottom: 30px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 30px;
            }
            th, td {
              padding: 10px;
              text-align: left;
              border-bottom: 1px solid #ddd;
            }
            th {
              background-color: #f2f2f2;
            }
            .text-right {
              text-align: right;
            }
            .totals {
              width: 300px;
              margin-left: auto;
            }
            .totals table {
              margin-bottom: 0;
            }
            .total-row {
              font-weight: bold;
            }
            .notes {
              margin-top: 30px;
              padding-top: 10px;
              border-top: 1px solid #ddd;
            }
            .status {
              display: inline-block;
              padding: 5px 10px;
              border-radius: 4px;
              font-weight: bold;
              text-transform: uppercase;
              font-size: 12px;
            }
            .status-paid {
              background-color: #d4edda;
              color: #155724;
            }
            .status-partial {
              background-color: #fff3cd;
              color: #856404;
            }
            .status-pending {
              background-color: #d1ecf1;
              color: #0c5460;
            }
            .status-overdue {
              background-color: #f8d7da;
              color: #721c24;
            }
            .footer {
              margin-top: 50px;
              text-align: center;
              font-size: 12px;
              color: #777;
            }
            @media print {
              body {
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
              }
              @page {
                margin: 20mm;
              }
            }
          </style>
        </head>
        <body>
          <div class="invoice-header">
            <div class="company-info">
              <div class="invoice-title">${escapeHtml(state.settings.companyName || 'Your Company Name')}</div>
              <div>${escapeHtml(state.settings.companyAddress || 'Your Company Address')}</div>
              <div>Phone: ${escapeHtml(state.settings.companyPhone || '')}</div>
              <div>Email: ${escapeHtml(state.settings.companyEmail || '')}</div>
            </div>
            <div class="invoice-info">
              <div class="invoice-title">INVOICE</div>
              <div><strong>Invoice #:</strong> ${escapeHtml(invoice.invoice_number)}</div>
              <div><strong>Date:</strong> ${formatShortDate(invoice.date)}</div>
              <div><strong>Due Date:</strong> ${formatShortDate(invoice.due_date)}</div>
              <div><strong>Status:</strong> <span class="status status-${status}">${status}</span></div>
            </div>
          </div>
          
          <div class="customer-info">
            <div><strong>Bill To:</strong></div>
            <div>${escapeHtml(customer ? customer.name : 'Unknown')}</div>
            <div>${escapeHtml(customer ? customer.address : '')}</div>
            <div>Phone: ${escapeHtml(customer ? customer.contact : '')}</div>
            <div>Email: ${escapeHtml(customer ? customer.email : '')}</div>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Description</th>
                <th class="text-right">Quantity</th>
                <th class="text-right">Unit Price</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              ${invoice.items.map(item => `
                <tr>
                  <td>${escapeHtml(item.name || '')}</td>
                  <td>${escapeHtml(item.description || '')}</td>
                  <td class="text-right">${item.quantity}</td>
                  <td class="text-right">${formatMoney(item.unit_price_cents)}</td>
                  <td class="text-right">${formatMoney(item.total_cents)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div class="totals">
            <table>
              <tr>
                <td>Subtotal:</td>
                <td class="text-right">${formatMoney(invoice.subtotal_cents)}</td>
              </tr>
              <tr>
                <td>Tax:</td>
                <td class="text-right">${formatMoney(invoice.tax_cents)}</td>
              </tr>
              <tr class="total-row">
                <td>Total:</td>
                <td class="text-right">${formatMoney(invoice.total_cents)}</td>
              </tr>
              <tr>
                <td>Amount Paid:</td>
                <td class="text-right">${formatMoney(totalPaid)}</td>
              </tr>
              <tr class="total-row">
                <td>Balance Due:</td>
                <td class="text-right">${formatMoney(balance)}</td>
              </tr>
            </table>
          </div>
          
          ${invoice.notes ? `
            <div class="notes">
              <div><strong>Notes:</strong></div>
              <div>${escapeHtml(invoice.notes)}</div>
            </div>
          ` : ''}
          
          <div class="footer">
            Thank you for your business!
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // Wait for content to load then print
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    // Load cash drawer
    function loadCashDrawer() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderCashDrawer();
      }, 500);
    }

    // Render cash drawer
    function renderCashDrawer() {
      const container = document.getElementById('cash-drawer-content');
      
      if (!state.cashDrawer) {
        // No cash drawer open
        container.innerHTML = `
          <div style="text-align: center; padding: 50px 20px;">
            <i class="fas fa-cash-register" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
            <h3>No Cash Drawer Open</h3>
            <p class="muted">Open a cash drawer to start tracking transactions</p>
          </div>
        `;
        
        document.getElementById('open-drawer-btn').style.display = 'block';
        document.getElementById('add-transaction-btn').disabled = true;
        return;
      }
      
      // Cash drawer is open
      document.getElementById('open-drawer-btn').style.display = 'none';
      document.getElementById('add-transaction-btn').disabled = false;
      
      // Calculate total transactions
      const deposits = state.transactions
        .filter(t => t.type === 'deposit')
        .reduce((sum, t) => sum + t.amount_cents, 0);
      
      const withdrawals = state.transactions
        .filter(t => t.type === 'withdrawal')
        .reduce((sum, t) => sum + t.amount_cents, 0);
      
      const netTransactions = deposits - withdrawals;
      
      // Current balance
      const currentBalance = state.cashDrawer.opening_amount_cents + netTransactions;
      
      // Difference from expected
      const difference = currentBalance - state.cashDrawer.expected_amount_cents;
      
      container.innerHTML = `
        <div class="cash-drawer-summary">
          <div class="cash-stat">
            <div class="cash-stat-label">Opening Balance</div>
            <div class="cash-stat-value">${formatMoney(state.cashDrawer.opening_amount_cents)}</div>
          </div>
          <div class="cash-stat">
            <div class="cash-stat-label">Expected Balance</div>
            <div class="cash-stat-value">${formatMoney(state.cashDrawer.expected_amount_cents)}</div>
          </div>
          <div class="cash-stat">
            <div class="cash-stat-label">Current Balance</div>
            <div class="cash-stat-value">${formatMoney(currentBalance)}</div>
          </div>
          <div class="cash-stat">
            <div class="cash-stat-label">Difference</div>
            <div class="cash-stat-value ${difference !== 0 ? 'error' : ''}">${formatMoney(difference)}</div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="muted">
            <i class="fas fa-info-circle"></i> 
            Cash drawer opened on ${formatDate(state.cashDrawer.opened_at)}
            ${state.cashDrawer.notes ? `<br>Notes: ${escapeHtml(state.cashDrawer.notes)}` : ''}
          </div>
        </div>
      `;
      
      // Render transactions
      renderTransactions();
    }

    // Render transactions
    function renderTransactions() {
      const tbody = document.getElementById('transactions-body');
      tbody.innerHTML = '';
      
      if (!state.transactions.length) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="center">No transactions yet</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      // Sort transactions by date (newest first)
      const sortedTransactions = [...state.transactions].sort((a, b) => {
        return new Date(b.created_at) - new Date(a.created_at);
      });
      
      sortedTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${formatDate(transaction.created_at)}</td>
          <td>
            <span class="tag ${transaction.type === 'deposit' ? 'success' : 'warning'}">
              ${transaction.type === 'deposit' ? 'Deposit' : 'Withdrawal'}
            </span>
          </td>
          <td class="right">${formatMoney(transaction.amount_cents)}</td>
          <td>${escapeHtml(transaction.description || '')}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Open cash drawer
    function openCashDrawer() {
      const amount = document.getElementById('opening-amount').value;
      const notes = document.getElementById('open-drawer-notes').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid opening amount.');
        return;
      }
      
      // Convert dollars to cents
      const amountCents = Math.round(parseFloat(amount) * 100);
      
      // Show loader
      showLoader();
      
      // Simulate open drawer request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('open-drawer-modal').classList.remove('show');
        
        // Create cash drawer
        state.cashDrawer = {
          id: Date.now(),
          opening_amount_cents: amountCents,
          expected_amount_cents: amountCents,
          status: 'open',
          opened_at: new Date().toISOString(),
          notes: notes
        };
        
        // Add system log
        addSystemLog('cash_drawer', `Opened cash drawer with ${formatMoney(amountCents)}`);
        
        showAlert('success', 'Cash drawer successfully opened.');
        renderCashDrawer();
      }, 1000);
    }

    // Add transaction
    function addTransaction() {
      const type = document.getElementById('transaction-type').value;
      const amount = document.getElementById('transaction-amount').value;
      const description = document.getElementById('transaction-description').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid amount.');
        return;
      }
      
      // Convert dollars to cents
      const amountCents = Math.round(parseFloat(amount) * 100);
      
      // Show loader
      showLoader();
      
      // Simulate transaction request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('add-transaction-modal').classList.remove('show');
        
        // Create transaction
        const transaction = {
          id: Date.now(),
          type: type,
          amount_cents: amountCents,
          description: description,
          created_at: new Date().toISOString()
        };
        
        state.transactions.push(transaction);
        
        // Update expected amount in cash drawer
        if (type === 'deposit') {
          state.cashDrawer.expected_amount_cents += amountCents;
        } else {
          state.cashDrawer.expected_amount_cents -= amountCents;
        }
        
        // Add system log
        addSystemLog('transaction', `${type === 'deposit' ? 'Added' : 'Removed'} ${formatMoney(amountCents)} from cash drawer. Description: ${description}`);
        
        showAlert('success', 'Transaction added successfully.');
        renderCashDrawer();
      }, 1000);
    }

    // Unlock warehouse
    function unlockWarehouse() {
      const passcode = document.getElementById('warehouse-passcode').value;
      
      if (passcode !== '2468') {
        showAlert('error', 'Invalid warehouse passcode.');
        return;
      }
      
      state.warehouseUnlocked = true;
      document.getElementById('warehouse-locked').style.display = 'none';
      document.getElementById('warehouse-content').style.display = 'block';
      
      // Add system log
      addSystemLog('access', 'Warehouse access granted');
      
      // Load warehouse data
      loadWarehouse();
    }

    // Load warehouse
    function loadWarehouse() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderWarehouse();
      }, 500);
    }

    // Render warehouse
    function renderWarehouse() {
      const tbody = document.getElementById('warehouse-body');
      tbody.innerHTML = '';
      
      // Filter inventory based on current filters
      const filtered = state.inventory.filter(item => {
        // Only show warehouse items
        if (item.location !== 'warehouse') {
          return false;
        }
        
        // Status filter
        if (state.warehouseFilters.status !== 'all' && item.status !== state.warehouseFilters.status) {
          return false;
        }
        
        // Carrier filter
        if (state.warehouseFilters.carrier !== 'all' && item.carrier !== state.warehouseFilters.carrier) {
          return false;
        }
        
        // Condition filter
        if (state.warehouseFilters.condition !== 'all' && item.condition !== state.warehouseFilters.condition) {
          return false;
        }
        
        // Device type filter
        if (state.warehouseFilters.deviceType !== 'all' && item.device_type !== state.warehouseFilters.deviceType) {
          return false;
        }
        
        // Search filter
        if (state.warehouseFilters.search) {
          const search = state.warehouseFilters.search.toLowerCase();
          return (
            (item.imei && item.imei.toLowerCase().includes(search)) ||
            (item.device_display && item.device_display.toLowerCase().includes(search))
          );
        }
        
        return true;
      });
      
      // Pagination
      const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const paginatedItems = filtered.slice(start, end);
      
      // Reset selected items
      state.selectedItems = [];
      
      // Update selected count
      updateSelectedCount();
      
      if (paginatedItems.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="9" class="center">No items found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      // Render items
      paginatedItems.forEach(item => {
        const row = document.createElement('tr');
        
        // Determine if item is new or used
        const isNew = item.condition === 'NIB';
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="warehouse-select-item" value="${item.id}">
          </td>
          <td><code>${escapeHtml(item.imei || '')}</code></td>
          <td>${escapeHtml(item.device_display || '')}
            <div class="muted">${escapeHtml(item.device_type || 'Phone')}</div>
          </td>
          <td><span class="tag ${isNew ? 'success' : ''}">${escapeHtml(item.condition || 'B')}</span></td>
          <td><span class="tag">${escapeHtml(item.carrier || 'Unknown')}</span></td>
          <td class="right">${formatMoney(item.price_paid_cents || 0)}</td>
          <td>
            <span class="tag ${item.status === 'in_stock' ? 'success' : item.status === 'sold' ? 'info' : 'warning'}">
              ${item.status === 'in_stock' ? 'In Stock' : item.status === 'sold' ? 'Sold' : 'Transferred'}
            </span>
          </td>
          <td>${formatShortDate(item.created_at)}</td>
          <td>
            <button class="btn btn-secondary edit-warehouse-item" data-id="${item.id}">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Pagination controls
      const pagination = document.getElementById('warehouse-pagination');
      pagination.innerHTML = '';
      
      if (totalPages > 1) {
        const prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.innerHTML = '&laquo; Prev';
        if (state.currentPage === 1) {
          prevLink.classList.add('disabled');
        }
        
        prevLink.onclick = (e) => {
          e.preventDefault();
          if (state.currentPage > 1) {
            state.currentPage--;
            renderWarehouse();
          }
        };
        
        pagination.appendChild(prevLink);
        
        for (let i = 1; i <= totalPages; i++) {
          const pageLink = document.createElement('a');
          pageLink.href = '#';
          pageLink.innerText = i;
          if (i === state.currentPage) {
            pageLink.classList.add('active');
          }
          
          pageLink.onclick = (e) => {
            e.preventDefault();
            state.currentPage = i;
            renderWarehouse();
          };
          
          pagination.appendChild(pageLink);
        }
        
        const nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.innerHTML = 'Next &raquo;';
        if (state.currentPage === totalPages) {
          nextLink.classList.add('disabled');
        }
        
        nextLink.onclick = (e) => {
          e.preventDefault();
          if (end < filtered.length) {
            state.currentPage++;
            renderWarehouse();
          }
        };
        
        pagination.appendChild(nextLink);
      }
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('warehouse-select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.warehouse-select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateSelectedCount();
      });
      
      // Edit buttons
      document.querySelectorAll('.edit-warehouse-item').forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-id');
          showEditItemModal(itemId);
        });
      });
      
      // Checkbox change events
      document.querySelectorAll('.warehouse-select-item').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateSelectedCount();
          
          // Update selected items array
          const itemId = this.value;
          if (this.checked) {
            if (!state.selectedItems.includes(itemId)) {
              state.selectedItems.push(itemId);
            }
          } else {
            const index = state.selectedItems.indexOf(itemId);
            if (index !== -1) {
              state.selectedItems.splice(index, 1);
            }
          }
        });
      });
    }
    
    // Export selected items
    function exportSelectedItems() {
      const selectedCheckboxes = document.querySelectorAll('.warehouse-select-item:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
      
      if (selectedIds.length === 0) {
        showAlert('error', 'Please select at least one item to export.');
        return;
      }
      
      // Get selected items
      const selectedItems = state.inventory.filter(item => selectedIds.includes(item.id.toString()));
      
      // Create CSV
      const header = ['IMEI', 'Device', 'Color', 'Storage', 'Carrier', 'Condition', 'Price Paid', 'Status', 'Location', 'Date Added', 'Notes'];
      const lines = [header.join(',')];
      
      selectedItems.forEach(item => {
        const row = [
          item.imei || '',
          item.device_display || '',
          item.color || '',
          item.storage || '',
          item.carrier || 'Unknown',
          item.condition || 'B',
          (item.price_paid_cents / 100).toFixed(2),
          item.status || 'in_stock',
          item.location || 'warehouse',
          item.created_at ? new Date(item.created_at).toLocaleDateString() : '',
          item.notes || ''
        ].map(v => JSON.stringify(String(v)).replace(/^\uFEFF/, ''));
        
        lines.push(row.join(','));
      });
      
      const csv = lines.join('\n');
      
      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `warehouse_export_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      
      showAlert('success', `Exported ${selectedItems.length} items to CSV.`);
    }

    // Add device to warehouse
    function addDeviceToWarehouse() {
      const device = document.getElementById('w_device').value.trim();
      const color = document.getElementById('w_color').value.trim();
      const storage = document.getElementById('w_storage').value.trim();
      const imei = document.getElementById('w_imei').value.trim();
      const carrier = document.getElementById('w_carrier').value;
      const condition = document.getElementById('w_condition').value;
      const price = document.getElementById('w_price').value;
      const notes = document.getElementById('w_notes').value;
      
      if (!device) {
        showAlert('error', 'Please enter a device name.');
        return;
      }
      
      if (!imei) {
        showAlert('error', 'Please enter an IMEI or serial number.');
        return;
      }
      
      // Convert dollars to cents
      const priceCents = price ? Math.round(parseFloat(price) * 100) : 0;
      
      // Show loader
      showLoader();
      
      // Add system log
      addSystemLog('inventory_add', `Added ${device} directly to warehouse. Price: ${formatMoney(priceCents)}`);
      
      // Simulate add request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        
        // Add to local inventory
        state.inventory.push({
          id: Date.now() + Math.floor(Math.random() * 1000),
          imei: imei,
          device_display: device,
          color: color,
          storage: storage,
          condition: condition,
          carrier: carrier,
          price_paid_cents: priceCents,
          status: 'in_stock',
          location: 'warehouse',
          created_at: new Date().toISOString(),
          notes: notes
        });
        
        showAlert('success', 'Device added to warehouse successfully.');
        
        // Clear form
        document.getElementById('w_device').value = '';
        document.getElementById('w_color').value = '';
        document.getElementById('w_storage').value = '';
        document.getElementById('w_imei').value = '';
        document.getElementById('w_carrier').value = 'Unknown';
        document.getElementById('w_condition').value = 'B';
        document.getElementById('w_price').value = '';
        document.getElementById('w_notes').value = '';
        
        // Re-render warehouse
        renderWarehouse();
      }, 1000);
    }

    // Unlock admin panel
    function unlockAdmin() {
      const passcode = document.getElementById('admin-passcode').value;
      
      if (passcode !== '1337') {
        showAlert('error', 'Invalid admin passcode.');
        return;
      }
      
      state.adminUnlocked = true;
      document.getElementById('admin-locked').style.display = 'none';
      document.getElementById('admin-content').style.display = 'block';
      
      // Add system log
      addSystemLog('access', 'Admin access granted');
      
      // Load admin data
      renderSystemLogs();
    }

    // Render system logs
    function renderSystemLogs() {
      const logsContainer = document.getElementById('system-logs');
      logsContainer.innerHTML = '';
      
      const logFilter = document.getElementById('log-filter').value;
      
      // Filter logs
      const filteredLogs = logFilter === 'all' ? 
        state.logs : 
        state.logs.filter(log => log.action.includes(logFilter));
      
      if (!filteredLogs.length) {
        logsContainer.innerHTML = '<div class="log-entry">No logs found.</div>';
        return;
      }
      
      filteredLogs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        let actionText = '';
        switch(log.action) {
          case 'inventory_add':
            actionText = 'Inventory Added';
            break;
          case 'inventory_edit':
            actionText = 'Inventory Edited';
            break;
          case 'inventory_delete':
            actionText = 'Inventory Deleted';
            break;
          case 'transfer':
            actionText = 'Transfer';
            break;
          case 'cash_drawer':
            actionText = 'Cash Drawer';
            break;
          case 'transaction':
            actionText = 'Transaction';
            break;
          case 'access':
            actionText = 'Access';
            break;
          default:
            actionText = log.action;
        }
        
        logEntry.innerHTML = `
          <div class="log-timestamp">${formatDate(log.timestamp)}</div>
          <div class="log-action">${actionText}</div>
          <div class="log-details">${escapeHtml(log.details)}</div>
        `;
        
        logsContainer.appendChild(logEntry);
      });
    }

    // Save admin settings
    function saveAdminSettings() {
      const conditionAgeDays = parseInt(document.getElementById('condition-age-setting').value);
      
      if (isNaN(conditionAgeDays) || conditionAgeDays < 1) {
        showAlert('error', 'Please enter a valid number of days.');
        return;
      }
      
      state.settings.conditionAgeDays = conditionAgeDays;
      
      // Add system log
      addSystemLog('settings', `Updated condition age setting to ${conditionAgeDays} days`);
      
      showAlert('success', 'Settings saved successfully.');
    }

    // Setup device typeahead
    function setupDeviceTypeahead() {
      const deviceInput = document.getElementById('m_device');
      const deviceResults = document.getElementById('device-results');
      
      // Sample device list (in a real app, this would come from the server)
      const devices = [
        'iPhone 13 Pro Max',
        'iPhone 13 Pro',
        'iPhone 13',
        'iPhone 13 Mini',
        'iPhone 12 Pro Max',
        'iPhone 12 Pro',
        'iPhone 12',
        'iPhone 12 Mini',
        'iPhone SE (2nd gen)',
        'iPhone 11 Pro Max',
        'iPhone 11 Pro',
        'iPhone 11',
        'Samsung Galaxy S21 Ultra',
        'Samsung Galaxy S21+',
        'Samsung Galaxy S21',
        'Samsung Galaxy Note 20 Ultra',
        'Samsung Galaxy Note 20',
        'Google Pixel 6 Pro',
        'Google Pixel 6',
        'Google Pixel 5',
        'OnePlus 9 Pro',
        'OnePlus 9'
      ];
      
      deviceInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        
        if (!value) {
          deviceResults.classList.remove('show');
          return;
        }
        
        const filtered = devices.filter(device => 
          device.toLowerCase().includes(value)
        );
        
        if (filtered.length) {
          deviceResults.innerHTML = '';
          filtered.forEach(device => {
            const item = document.createElement('div');
            item.className = 'typeahead-item';
            item.innerText = device;
            item.addEventListener('click', function() {
              deviceInput.value = device;
              deviceResults.classList.remove('show');
            });
            deviceResults.appendChild(item);
          });
          deviceResults.classList.add('show');
        } else {
          deviceResults.classList.remove('show');
        }
      });
      
      deviceInput.addEventListener('focus', function() {
        if (this.value && deviceResults.children.length) {
          deviceResults.classList.add('show');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (e.target !== deviceInput && e.target !== deviceResults) {
          deviceResults.classList.remove('show');
        }
      });
    }

    // Setup color typeahead
    function setupColorTypeahead() {
      const colorInput = document.getElementById('m_color');
      const colorResults = document.getElementById('color-results');
      
      // Sample color list (in a real app, this would come from the server)
      const colors = [
        'Black',
        'White',
        'Silver',
        'Gold',
        'Rose Gold',
        'Space Gray',
        'Midnight Green',
        'Pacific Blue',
        'Graphite',
        'Sierra Blue',
        'Alpine Green',
        'Midnight',
        'Starlight',
        'Product RED',
        'Purple',
        'Yellow',
        'Green',
        'Blue',
        'Coral',
        'Pink'
      ];
      
      colorInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        
        if (!value) {
          colorResults.classList.remove('show');
          return;
        }
        
        const filtered = colors.filter(color => 
          color.toLowerCase().includes(value)
        );
        
        if (filtered.length) {
          colorResults.innerHTML = '';
          filtered.forEach(color => {
            const item = document.createElement('div');
            item.className = 'typeahead-item';
            item.innerText = color;
            item.addEventListener('click', function() {
              colorInput.value = color;
              colorResults.classList.remove('show');
            });
            colorResults.appendChild(item);
          });
          colorResults.classList.add('show');
        } else {
          colorResults.classList.remove('show');
        }
      });
      
      colorInput.addEventListener('focus', function() {
        if (this.value && colorResults.children.length) {
          colorResults.classList.add('show');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (e.target !== colorInput && e.target !== colorResults) {
          colorResults.classList.remove('show');
        }
      });
    }

    // Customer management functions
    function renderCustomers() {
      const tbody = document.getElementById('customers-body');
      tbody.innerHTML = '';
      
      // Filter customers based on search
      const filtered = state.customers.filter(customer => {
        if (!state.customerFilters.search) return true;
        
        const search = state.customerFilters.search.toLowerCase();
        return (
          (customer.name && customer.name.toLowerCase().includes(search)) ||
          (customer.email && customer.email.toLowerCase().includes(search)) ||
          (customer.contact && customer.contact.toLowerCase().includes(search))
        );
      });
      
      if (filtered.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" class="center">No customers found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      filtered.forEach(customer => {
        const row = document.createElement('tr');
        
        // Calculate balance
        const invoices = state.invoices.filter(inv => inv.customer_id === customer.id);
        const totalInvoiced = invoices.reduce((sum, inv) => sum + inv.total_cents, 0);
        
        const payments = state.payments.filter(pay => pay.customer_id === customer.id);
        const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
        
        const balance = totalInvoiced - totalPaid;
        
        // Find last purchase
        const lastInvoice = invoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        const lastPurchaseDate = lastInvoice ? formatShortDate(lastInvoice.date) : 'N/A';
        
        row.innerHTML = `
          <td>${escapeHtml(customer.name || '')}</td>
          <td>${escapeHtml(customer.contact || '')}</td>
          <td>${escapeHtml(customer.email || '')}</td>
          <td class="right ${balance > 0 ? 'error' : ''}">${formatMoney(balance)}</td>
          <td>${lastPurchaseDate}</td>
          <td>
            <button class="btn btn-secondary view-customer" data-id="${customer.id}">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-secondary edit-customer" data-id="${customer.id}">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.view-customer').forEach(button => {
        button.addEventListener('click', function() {
          const customerId = this.getAttribute('data-id');
          viewCustomerDetails(customerId);
        });
      });
      
      document.querySelectorAll('.edit-customer').forEach(button => {
        button.addEventListener('click', function() {
          const customerId = this.getAttribute('data-id');
          showEditCustomerModal(customerId);
        });
      });
    }
    
    function viewCustomerDetails(customerId) {
      const customer = state.customers.find(c => c.id == customerId);
      if (!customer) return;
      
      state.currentCustomer = customer;
      
      // Update customer details
      document.getElementById('customer-detail-name').textContent = customer.name || '';
      document.getElementById('customer-detail-contact').textContent = customer.contact || '';
      document.getElementById('customer-detail-email').textContent = customer.email || '';
      document.getElementById('customer-detail-address').textContent = customer.address || '';
      document.getElementById('customer-detail-notes').textContent = customer.notes || '';
      
      // Calculate financial information
      const invoices = state.invoices.filter(inv => inv.customer_id === customer.id);
      const totalInvoiced = invoices.reduce((sum, inv) => sum + inv.total_cents, 0);
      
      const payments = state.payments.filter(pay => pay.customer_id === customer.id);
      const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
      
      const balance = totalInvoiced - totalPaid;
      
      document.getElementById('customer-detail-balance').textContent = formatMoney(balance);
      document.getElementById('customer-detail-purchases').textContent = formatMoney(totalInvoiced);
      document.getElementById('customer-detail-payments').textContent = formatMoney(totalPaid);
      
      // Show customer detail panel
      document.getElementById('customer-detail').style.display = 'block';
      
      // Render customer invoices
      renderCustomerInvoices(customer.id);
    }
    
    function renderCustomerInvoices(customerId) {
      const tbody = document.getElementById('customer-invoices-body');
      tbody.innerHTML = '';
      
      const invoices = state.invoices
        .filter(inv => inv.customer_id === customerId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (invoices.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="5" class="center">No invoices found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      invoices.forEach(invoice => {
        const row = document.createElement('tr');
        
        // Calculate payments
        const payments = state.payments.filter(pay => pay.invoice_id === invoice.id);
        const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
        const balance = invoice.total_cents - totalPaid;
        
        // Determine status
        let status = 'pending';
        if (balance <= 0) {
          status = 'paid';
        } else if (totalPaid > 0) {
          status = 'partial';
        } else if (new Date(invoice.due_date) < new Date()) {
          status = 'overdue';
        }
        
        row.innerHTML = `
          <td>${invoice.invoice_number}</td>
          <td>${formatShortDate(invoice.date)}</td>
          <td class="right">${formatMoney(invoice.total_cents)}</td>
          <td>
            <span class="tag ${status === 'paid' ? 'success' : status === 'partial' ? 'warning' : status === 'overdue' ? 'error' : 'info'}">
              ${status.charAt(0).toUpperCase() + status.slice(1)}
            </span>
          </td>
          <td>
            <button class="btn btn-secondary view-invoice" data-id="${invoice.id}">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-secondary print-invoice" data-id="${invoice.id}">
              <i class="fas fa-print"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.view-invoice').forEach(button => {
        button.addEventListener('click', function() {
          const invoiceId = this.getAttribute('data-id');
          viewInvoiceDetails(invoiceId);
        });
      });
      
      document.querySelectorAll('.print-invoice').forEach(button => {
        button.addEventListener('click', function() {
          const invoiceId = this.getAttribute('data-id');
          printInvoice(invoiceId);
        });
      });
    }
    
    function renderCustomerPayments(customerId) {
      const tbody = document.getElementById('customer-payments-body');
      tbody.innerHTML = '';
      
      const payments = state.payments
        .filter(pay => pay.customer_id === customerId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (payments.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="5" class="center">No payments found</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      payments.forEach(payment => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${payment.payment_number}</td>
          <td>${formatShortDate(payment.date)}</td>
          <td class="right">${formatMoney(payment.amount_cents)}</td>
          <td>${escapeHtml(payment.method || '')}</td>
          <td>${escapeHtml(payment.notes || '')}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    function generateCustomerStatement(customerId, startDate, endDate) {
      const customer = state.customers.find(c => c.id == customerId);
      if (!customer) return;
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      // Get invoices and payments within date range
      const invoices = state.invoices
        .filter(inv => inv.customer_id === customerId && new Date(inv.date) >= start && new Date(inv.date) <= end)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const payments = state.payments
        .filter(pay => pay.customer_id === customerId && new Date(pay.date) >= start && new Date(pay.date) <= end)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Calculate opening balance (all transactions before start date)
      const openingInvoices = state.invoices
        .filter(inv => inv.customer_id === customerId && new Date(inv.date) < start);
      
      const openingPayments = state.payments
        .filter(pay => pay.customer_id === customerId && new Date(pay.date) < start);
      
      const openingBalance = openingInvoices.reduce((sum, inv) => sum + inv.total_cents, 0) - 
                            openingPayments.reduce((sum, pay) => sum + pay.amount_cents, 0);
      
      // Calculate closing balance
      const closingBalance = openingBalance + 
                            invoices.reduce((sum, inv) => sum + inv.total_cents, 0) - 
                            payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
      
      // Generate statement HTML
      const statementContent = document.getElementById('statement-content');
      
      statementContent.innerHTML = `
        <div class="statement-header">
          <div class="statement-company">
            <h2>${escapeHtml(state.settings.companyName || 'Your Company Name')}</h2>
            <p>${escapeHtml(state.settings.companyAddress || 'Your Company Address')}</p>
            <p>Phone: ${escapeHtml(state.settings.companyPhone || '')}</p>
            <p>Email: ${escapeHtml(state.settings.companyEmail || '')}</p>
          </div>
          <div class="statement-info">
            <h2>STATEMENT</h2>
            <p><strong>Date:</strong> ${formatShortDate(new Date())}</p>
            <p><strong>Period:</strong> ${formatShortDate(start)} - ${formatShortDate(end)}</p>
          </div>
        </div>
        
        <div class="statement-customer">
          <h3>STATEMENT FOR:</h3>
          <p><strong>${escapeHtml(customer.name || '')}</strong></p>
          <p>${escapeHtml(customer.address || '')}</p>
          <p>Contact: ${escapeHtml(customer.contact || '')}</p>
          <p>Email: ${escapeHtml(customer.email || '')}</p>
        </div>
        
        <div class="statement-summary">
          <div class="summary-row">
            <div class="summary-label">Opening Balance:</div>
            <div class="summary-value">${formatMoney(openingBalance)}</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Total Invoices:</div>
            <div class="summary-value">${formatMoney(invoices.reduce((sum, inv) => sum + inv.total_cents, 0))}</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Total Payments:</div>
            <div class="summary-value">${formatMoney(payments.reduce((sum, pay) => sum + pay.amount_cents, 0))}</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Closing Balance:</div>
            <div class="summary-value ${closingBalance > 0 ? 'error' : ''}">${formatMoney(closingBalance)}</div>
          </div>
        </div>
        
        <div class="statement-transactions">
          <h3>TRANSACTION HISTORY</h3>
          <table class="statement-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Reference</th>
                <th>Charges</th>
                <th>Payments</th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${formatShortDate(start)}</td>
                <td>Opening Balance</td>
                <td></td>
                <td></td>
                <td></td>
                <td class="right ${openingBalance > 0 ? 'error' : ''}">${formatMoney(openingBalance)}</td>
              </tr>
      `;
      
      // Combine invoices and payments for chronological listing
      const transactions = [
        ...invoices.map(inv => ({
          date: new Date(inv.date),
          type: 'invoice',
          description: `Invoice #${inv.invoice_number}`,
          reference: inv.invoice_number,
          amount: inv.total_cents
        })),
        ...payments.map(pay => ({
          date: new Date(pay.date),
          type: 'payment',
          description: `Payment - ${pay.method || ''}`,
          reference: pay.payment_number,
          amount: pay.amount_cents
        }))
      ].sort((a, b) => a.date - b.date);
      
      // Running balance
      let runningBalance = openingBalance;
      
      // Add transaction rows
      transactions.forEach(transaction => {
        if (transaction.type === 'invoice') {
          runningBalance += transaction.amount;
        } else {
          runningBalance -= transaction.amount;
        }
        
        statementContent.innerHTML += `
          <tr>
            <td>${formatShortDate(transaction.date)}</td>
            <td>${escapeHtml(transaction.description)}</td>
            <td>${escapeHtml(transaction.reference)}</td>
            <td class="right">${transaction.type === 'invoice' ? formatMoney(transaction.amount) : ''}</td>
            <td class="right">${transaction.type === 'payment' ? formatMoney(transaction.amount) : ''}</td>
            <td class="right ${runningBalance > 0 ? 'error' : ''}">${formatMoney(runningBalance)}</td>
          </tr>
        `;
      });
      
      statementContent.innerHTML += `
            </tbody>
          </table>
        </div>
        
        <div class="statement-footer">
          <p>Please contact us if you have any questions about this statement.</p>
          <p>Thank you for your business!</p>
        </div>
      `;
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Refresh balance button
      document.getElementById('refresh-balance').addEventListener('click', checkBalance);
      
      // IMEI lookup
      document.getElementById('lookup-btn').addEventListener('click', lookupIMEIs);
      
      // Reset button
      document.getElementById('reset-btn').addEventListener('click', resetLookup);
      
      // Add manual item
      document.getElementById('addManual').addEventListener('click', addManualItem);
      
      // Import to inventory button
      document.getElementById('import-to-inventory-btn').addEventListener('click', showImportModal);
      
      // Import to warehouse button
      document.getElementById('import-to-warehouse-btn').addEventListener('click', showImportWarehouseModal);
      
      // Import modal close
      document.getElementById('import-modal-close').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('show');
      });
      
      document.getElementById('import-modal-cancel').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('show');
      });
      
      // Import confirm
      document.getElementById('import-confirm').addEventListener('click', importToInventory);
      
      // Import to warehouse modal close
      document.getElementById('import-warehouse-modal-close').addEventListener('click', () => {
        document.getElementById('import-warehouse-modal').classList.remove('show');
      });
      
      document.getElementById('import-warehouse-modal-cancel').addEventListener('click', () => {
        document.getElementById('import-warehouse-modal').classList.remove('show');
      });
      
      // Import to warehouse confirm
      document.getElementById('import-warehouse-confirm').addEventListener('click', importToWarehouse);
      
      // Transfer to warehouse button
      document.getElementById('transfer-to-warehouse-btn').addEventListener('click', showTransferModal);
      
      // Transfer modal close
      document.getElementById('transfer-modal-close').addEventListener('click', () => {
        document.getElementById('transfer-modal').classList.remove('show');
      });
      
      document.getElementById('transfer-modal-cancel').addEventListener('click', () => {
        document.getElementById('transfer-modal').classList.remove('show');
      });
      
      // Transfer confirm
      document.getElementById('transfer-confirm').addEventListener('click', transferToWarehouse);
      
      // Inventory search
      document.getElementById('inventory-search-btn').addEventListener('click', () => {
        state.filters.search = document.getElementById('inventory-search').value;
        loadInventory();
      });
      
      // Status filter
      document.getElementById('status-filter').addEventListener('change', () => {
        state.filters.status = document.getElementById('status-filter').value;
        loadInventory();
      });
      
      // Location filter
      document.getElementById('location-filter').addEventListener('change', () => {
        state.filters.location = document.getElementById('location-filter').value;
        loadInventory();
      });
      
      // Open cash drawer button
      document.getElementById('open-drawer-btn').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.add('show');
      });
      
      // Open drawer modal close
      document.getElementById('open-drawer-modal-close').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.remove('show');
      });
      
      document.getElementById('open-drawer-modal-cancel').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.remove('show');
      });
      
      // Open drawer form
      document.getElementById('open-drawer-form').addEventListener('submit', (e) => {
        e.preventDefault();
        openCashDrawer();
      });
      
      // Add transaction button
      document.getElementById('add-transaction-btn').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.add('show');
      });
      
      // Add transaction modal close
      document.getElementById('add-transaction-modal-close').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.remove('show');
      });
      
      document.getElementById('add-transaction-modal-cancel').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.remove('show');
      });
      
      // Add transaction form
      document.getElementById('add-transaction-confirm').addEventListener('click', addTransaction);
      
      // Edit item modal close
      document.getElementById('edit-item-modal-close').addEventListener('click', () => {
        document.getElementById('edit-item-modal').classList.remove('show');
      });
      
      document.getElementById('edit-item-modal-cancel').addEventListener('click', () => {
        document.getElementById('edit-item-modal').classList.remove('show');
      });
      
      // Edit item confirm
      document.getElementById('edit-item-confirm').addEventListener('click', saveEditedItem);
      
      // Warehouse unlock button
      document.getElementById('warehouse-unlock-btn').addEventListener('click', unlockWarehouse);
      
      // Warehouse search
      document.getElementById('warehouse-search-btn').addEventListener('click', () => {
        state.warehouseFilters.search = document.getElementById('warehouse-search').value;
        loadWarehouse();
      });
      
      // Warehouse status filter
      document.getElementById('warehouse-status-filter').addEventListener('change', () => {
        state.warehouseFilters.status = document.getElementById('warehouse-status-filter').value;
        loadWarehouse();
      });
      
      // Add warehouse device button
      document.getElementById('add-warehouse-device-btn').addEventListener('click', addDeviceToWarehouse);
      
      // Admin unlock button
      document.getElementById('admin-unlock-btn').addEventListener('click', unlockAdmin);
      
      // Filter logs button
      document.getElementById('filter-logs-btn').addEventListener('click', renderSystemLogs);
      
      // Save settings button
      document.getElementById('save-settings-btn').addEventListener('click', saveAdminSettings);
      
      // Tab switching
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
          
          // Load tab-specific data
          if (tabId === 'manual-entry') {
            renderRecentItems();
          } else if (tabId === 'inventory') {
            loadInventory();
          } else if (tabId === 'cash-drawer') {
            loadCashDrawer();
          } else if (tabId === 'warehouse' && state.warehouseUnlocked) {
            loadWarehouse();
          } else if (tabId === 'customers') {
            renderCustomers();
          } else if (tabId === 'invoices') {
            renderInvoices();
          } else if (tabId === 'admin' && state.adminUnlocked) {
            renderAdminDashboard();
          }
        });
      });
    }

    // Setup sub-tab event listeners
    function setupSubTabEventListeners() {
      // Customer sub-tabs
      const customerSubTabs = document.querySelectorAll('.sub-tab');
      const customerSubTabContents = document.querySelectorAll('.sub-tab-content');
      
      customerSubTabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Get parent tab ID to determine which set of sub-tabs to update
          const parentTabId = this.closest('.tab-content').id;
          const subTabGroup = parentTabId.replace('-tab', '');
          
          // Remove active class from all sub-tabs and contents in this group
          document.querySelectorAll(`.sub-tab[data-subtab^="${subTabGroup}"]`).forEach(t => t.classList.remove('active'));
          document.querySelectorAll(`[id^="${subTabGroup}-"][id$="-tab"].sub-tab-content`).forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked sub-tab and corresponding content
          this.classList.add('active');
          const subTabId = this.getAttribute('data-subtab');
          document.getElementById(`${subTabId}-tab`).classList.add('active');
          
          // Load sub-tab specific data
          if (subTabId === 'customer-invoices' && state.currentCustomer) {
            renderCustomerInvoices(state.currentCustomer.id);
          } else if (subTabId === 'customer-payments' && state.currentCustomer) {
            renderCustomerPayments(state.currentCustomer.id);
          } else if (subTabId === 'admin-dashboard') {
            renderAdminDashboard();
          } else if (subTabId === 'admin-logs') {
            renderSystemLogs();
          }
        });
      });
      
      // Manual entry tab buttons
      document.getElementById('add-to-store-btn').addEventListener('click', function() {
        addItemFromManualEntry('store');
      });
      
      document.getElementById('add-to-warehouse-btn').addEventListener('click', function() {
        addItemFromManualEntry('warehouse');
      });
      
      document.getElementById('manual-add-item-btn').addEventListener('click', function() {
        const location = document.getElementById('warehouse-unlock-btn').disabled ? 'store' : 'warehouse';
        addItemFromManualEntry(location);
      });
      
      document.getElementById('manual-clear-btn').addEventListener('click', function() {
        document.getElementById('manual_device').value = '';
        document.getElementById('manual_color').value = '';
        document.getElementById('manual_storage').value = '';
        document.getElementById('manual_imei').value = '';
        document.getElementById('manual_carrier').value = 'Unknown';
        document.getElementById('manual_condition').value = 'B';
        document.getElementById('manual_type').value = 'Phone';
        document.getElementById('manual_price').value = '';
        document.getElementById('manual_quantity').value = '1';
        document.getElementById('manual_purchase_date').value = '';
        document.getElementById('manual_notes').value = '';
      });
      
      // Customer tab buttons
      document.getElementById('add-customer-btn').addEventListener('click', function() {
        showAddCustomerModal();
      });
      
      document.getElementById('customer-search-btn').addEventListener('click', function() {
        state.customerFilters.search = document.getElementById('customer-search').value;
        renderCustomers();
      });
      
      document.getElementById('create-invoice-btn').addEventListener('click', function() {
        if (state.currentCustomer) {
          showCreateInvoiceModal(state.currentCustomer.id);
        }
      });
      
      document.getElementById('record-payment-btn').addEventListener('click', function() {
        if (state.currentCustomer) {
          showRecordPaymentModal(state.currentCustomer.id);
        }
      });
      
      document.getElementById('generate-statement-btn').addEventListener('click', function() {
        if (state.currentCustomer) {
          const startDate = document.getElementById('statement-start-date').value;
          const endDate = document.getElementById('statement-end-date').value;
          
          if (!startDate || !endDate) {
            showAlert('error', 'Please select start and end dates.');
            return;
          }
          
          generateCustomerStatement(state.currentCustomer.id, startDate, endDate);
        }
      });
      
      document.getElementById('print-statement-btn').addEventListener('click', function() {
        window.print();
      });
      
      // Warehouse mass selection buttons
      document.getElementById('mass-select-all-btn').addEventListener('click', function() {
        document.querySelectorAll('.warehouse-select-item').forEach(checkbox => {
          checkbox.checked = true;
        });
        updateSelectedCount();
      });
      
      document.getElementById('mass-deselect-all-btn').addEventListener('click', function() {
        document.querySelectorAll('.warehouse-select-item').forEach(checkbox => {
          checkbox.checked = false;
        });
        updateSelectedCount();
      });
      
      document.getElementById('create-invoice-from-selected-btn').addEventListener('click', function() {
        const selectedItems = document.querySelectorAll('.warehouse-select-item:checked');
        if (selectedItems.length === 0) {
          showAlert('error', 'Please select at least one item.');
          return;
        }
        
        showCreateInvoiceFromItemsModal();
      });
      
      document.getElementById('export-selected-btn').addEventListener('click', function() {
        const selectedItems = document.querySelectorAll('.warehouse-select-item:checked');
        if (selectedItems.length === 0) {
          showAlert('error', 'Please select at least one item.');
          return;
        }
        
        exportSelectedItems();
      });
      
      // Admin panel buttons
      document.getElementById('create-backup-btn').addEventListener('click', function() {
        createBackup();
      });
      
      document.getElementById('restore-backup-btn').addEventListener('click', function() {
        showRestoreBackupModal();
      });
      
      document.getElementById('save-backup-settings-btn').addEventListener('click', function() {
        saveBackupSettings();
      });
      
      document.getElementById('add-user-btn').addEventListener('click', function() {
        showAddUserModal();
      });
      
      document.getElementById('export-logs-btn').addEventListener('click', function() {
        exportLogs();
      });
    }
    
    // Update selected count for mass selection
    function updateSelectedCount() {
      const selectedItems = document.querySelectorAll('.warehouse-select-item:checked');
      const count = selectedItems.length;
      
      document.getElementById('selected-count').textContent = `${count} item${count === 1 ? '' : 's'} selected`;
      
      // Enable/disable buttons based on selection
      document.getElementById('create-invoice-from-selected-btn').disabled = count === 0;
      document.getElementById('export-selected-btn').disabled = count === 0;
    }
    
    // Render admin dashboard
    function renderAdminDashboard() {
      // Update summary cards
      document.getElementById('dashboard-total-inventory').textContent = state.inventory.filter(item => item.status === 'in_stock').length;
      
      const inventoryValue = state.inventory
        .filter(item => item.status === 'in_stock')
        .reduce((sum, item) => sum + (item.price_paid_cents || 0), 0);
      document.getElementById('dashboard-inventory-value').textContent = formatMoney(inventoryValue);
      
      // Calculate outstanding invoices
      let outstandingInvoices = 0;
      state.invoices.forEach(invoice => {
        const payments = state.payments.filter(pay => pay.invoice_id === invoice.id);
        const totalPaid = payments.reduce((sum, pay) => sum + pay.amount_cents, 0);
        const balance = invoice.total_cents - totalPaid;
        
        if (balance > 0) {
          outstandingInvoices += balance;
        }
      });
      document.getElementById('dashboard-outstanding-invoices').textContent = formatMoney(outstandingInvoices);
      
      // Calculate monthly sales
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      const monthlySales = state.invoices
        .filter(invoice => new Date(invoice.date) >= firstDayOfMonth)
        .reduce((sum, invoice) => sum + invoice.total_cents, 0);
      document.getElementById('dashboard-monthly-sales').textContent = formatMoney(monthlySales);
      
      // Render charts
      renderTopDevicesChart();
      renderSalesChart();
      renderConditionChart();
      renderCarrierChart();
      
      // Render low stock alerts
      renderLowStockAlerts();
    }
    
    // Render charts for admin dashboard
    function renderTopDevicesChart() {
      // Group inventory by device name
      const deviceCounts = {};
      state.inventory.forEach(item => {
        const device = item.device_display || 'Unknown';
        deviceCounts[device] = (deviceCounts[device] || 0) + 1;
      });
      
      // Sort and get top 10
      const sortedDevices = Object.entries(deviceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      const labels = sortedDevices.map(d => d[0]);
      const data = sortedDevices.map(d => d[1]);
      
      // Create chart
      const ctx = document.getElementById('top-devices-chart').getContext('2d');
      
      // Check if chart already exists and destroy it
      if (window.topDevicesChart) {
        window.topDevicesChart.destroy();
      }
      
      window.topDevicesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Device Count',
            data: data,
            backgroundColor: 'rgba(0, 226, 155, 0.7)',
            borderColor: 'rgba(0, 226, 155, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
    
    function renderSalesChart() {
      // Group sales by month
      const salesByMonth = {};
      
      // Get last 12 months
      const today = new Date();
      for (let i = 0; i < 12; i++) {
        const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthKey = month.toISOString().substring(0, 7); // YYYY-MM format
        salesByMonth[monthKey] = 0;
      }
      
      // Add sales data
      state.invoices.forEach(invoice => {
        const monthKey = invoice.date.substring(0, 7); // YYYY-MM format
        if (salesByMonth[monthKey] !== undefined) {
          salesByMonth[monthKey] += invoice.total_cents;
        }
      });
      
      // Sort by month
      const sortedMonths = Object.entries(salesByMonth)
        .sort((a, b) => a[0].localeCompare(b[0]));
      
      const labels = sortedMonths.map(m => {
        const date = new Date(m[0] + '-01');
        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      });
      
      const data = sortedMonths.map(m => m[1] / 100); // Convert cents to dollars
      
      // Create chart
      const ctx = document.getElementById('sales-chart').getContext('2d');
      
      // Check if chart already exists and destroy it
      if (window.salesChart) {
        window.salesChart.destroy();
      }
      
      window.salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sales ($)',
            data: data,
            backgroundColor: 'rgba(72, 182, 255, 0.2)',
            borderColor: 'rgba(72, 182, 255, 1)',
            borderWidth: 2,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    function renderConditionChart() {
      // Group inventory by condition
      const conditionCounts = {
        'NIB': 0,
        'A': 0,
        'B': 0,
        'C': 0,
        'D': 0
      };
      
      state.inventory
        .filter(item => item.status === 'in_stock')
        .forEach(item => {
          const condition = item.condition || 'B';
          if (conditionCounts[condition] !== undefined) {
            conditionCounts[condition]++;
          }
        });
      
      const labels = Object.keys(conditionCounts);
      const data = Object.values(conditionCounts);
      
      // Create chart
      const ctx = document.getElementById('condition-chart').getContext('2d');
      
      // Check if chart already exists and destroy it
      if (window.conditionChart) {
        window.conditionChart.destroy();
      }
      
      window.conditionChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              'rgba(72, 255, 179, 0.7)',
              'rgba(72, 182, 255, 0.7)',
              'rgba(255, 182, 72, 0.7)',
              'rgba(255, 72, 72, 0.7)',
              'rgba(128, 128, 128, 0.7)'
            ],
            borderColor: [
              'rgba(72, 255, 179, 1)',
              'rgba(72, 182, 255, 1)',
              'rgba(255, 182, 72, 1)',
              'rgba(255, 72, 72, 1)',
              'rgba(128, 128, 128, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    function renderCarrierChart() {
      // Group inventory by carrier
      const carrierCounts = {};
      
      state.inventory
        .filter(item => item.status === 'in_stock')
        .forEach(item => {
          const carrier = item.carrier || 'Unknown';
          carrierCounts[carrier] = (carrierCounts[carrier] || 0) + 1;
        });
      
      const labels = Object.keys(carrierCounts);
      const data = Object.values(carrierCounts);
      
      // Create chart
      const ctx = document.getElementById('carrier-chart').getContext('2d');
      
      // Check if chart already exists and destroy it
      if (window.carrierChart) {
        window.carrierChart.destroy();
      }
      
      window.carrierChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              'rgba(72, 255, 179, 0.7)',
              'rgba(72, 182, 255, 0.7)',
              'rgba(255, 182, 72, 0.7)',
              'rgba(255, 72, 72, 0.7)',
              'rgba(128, 128, 128, 0.7)',
              'rgba(255, 72, 255, 0.7)'
            ],
            borderColor: [
              'rgba(72, 255, 179, 1)',
              'rgba(72, 182, 255, 1)',
              'rgba(255, 182, 72, 1)',
              'rgba(255, 72, 72, 1)',
              'rgba(128, 128, 128, 1)',
              'rgba(255, 72, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    function renderLowStockAlerts() {
      const tbody = document.getElementById('low-stock-body');
      tbody.innerHTML = '';
      
      // Group inventory by device
      const deviceCounts = {};
      state.inventory
        .filter(item => item.status === 'in_stock')
        .forEach(item => {
          const device = item.device_display || 'Unknown';
          deviceCounts[device] = (deviceCounts[device] || 0) + 1;
        });
      
      // Get devices below threshold
      const lowStockDevices = Object.entries(deviceCounts)
        .filter(([device, count]) => count <= state.settings.lowStockThreshold)
        .sort((a, b) => a[1] - b[1]); // Sort by count ascending
      
      if (lowStockDevices.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="center">No low stock alerts</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      lowStockDevices.forEach(([device, count]) => {
        // Find last received date for this device
        const lastReceived = state.inventory
          .filter(item => item.device_display === device)
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
        
        const lastReceivedDate = lastReceived ? formatShortDate(lastReceived.created_at) : 'N/A';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(device)}</td>
          <td class="${count <= state.settings.lowStockThreshold / 2 ? 'error' : 'warning'}">${count}</td>
          <td>${state.settings.lowStockThreshold}</td>
          <td>${lastReceivedDate}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // Check API balance
    function checkBalance() {
      fetch('/api/balance')
        .then(response => response.json())
        .then(data => {
          const balanceValue = document.getElementById('balance-value');
          if (data.balance) {
            balanceValue.textContent = '$' + data.balance;
          } else {
            balanceValue.textContent = 'Error';
            balanceValue.classList.add('error');
          }
        })
        .catch(error => {
          const balanceValue = document.getElementById('balance-value');
          balanceValue.textContent = 'Error';
          balanceValue.classList.add('error');
          console.error('Error checking balance:', error);
        });
    }

    // Data persistence functions
    function initializeData() {
      showLoader();
      
      // Check if data is already initialized
      db.collection('system').doc('status').get()
        .then(doc => {
          if (doc.exists && doc.data().initialized) {
            state.dataInitialized = true;
            loadAllData();
          } else {
            // First time initialization
            saveAllData()
              .then(() => {
                db.collection('system').doc('status').set({
                  initialized: true,
                  lastBackup: null,
                  version: '1.0.0'
                });
                state.dataInitialized = true;
                hideLoader();
                showAlert('success', 'System initialized successfully.');
              })
              .catch(error => {
                console.error('Error initializing data:', error);
                hideLoader();
                showAlert('error', 'Error initializing system: ' + error.message);
              });
          }
        })
        .catch(error => {
          console.error('Error checking initialization status:', error);
          hideLoader();
          showAlert('error', 'Error checking initialization status: ' + error.message);
        });
    }
    
    function loadAllData() {
      showLoader();
      
      Promise.all([
        // Load inventory
        db.collection('inventory').get().then(snapshot => {
          state.inventory = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        }),
        
        // Load cash drawer
        db.collection('cashDrawer').orderBy('opened_at', 'desc').limit(1).get().then(snapshot => {
          if (!snapshot.empty) {
            state.cashDrawer = {
              id: snapshot.docs[0].id,
              ...snapshot.docs[0].data()
            };
          }
        }),
        
        // Load transactions
        db.collection('transactions').get().then(snapshot => {
          state.transactions = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        }),
        
        // Load logs
        db.collection('logs').orderBy('timestamp', 'desc').limit(1000).get().then(snapshot => {
          state.logs = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        }),
        
        // Load customers
        db.collection('customers').get().then(snapshot => {
          state.customers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        }),
        
        // Load invoices
        db.collection('invoices').get().then(snapshot => {
          state.invoices = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        }),
        
        // Load payments
        db.collection('payments').get().then(snapshot => {
          state.payments = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        }),
        
        // Load settings
        db.collection('settings').doc('system').get().then(doc => {
          if (doc.exists) {
            state.settings = doc.data();
          }
        }),
        
        // Load users
        db.collection('users').get().then(snapshot => {
          if (!snapshot.empty) {
            state.users = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
          }
        }),
        
        // Load backup settings
        db.collection('settings').doc('backup').get().then(doc => {
          if (doc.exists) {
            state.backupSettings = doc.data();
          }
        }),
        
        // Load backups
        db.collection('backups').orderBy('created_at', 'desc').get().then(snapshot => {
          state.backups = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
        })
      ])
      .then(() => {
        hideLoader();
        
        // Render initial views
        if (document.getElementById('lookup-tab').classList.contains('active')) {
          // Nothing to render for lookup tab
        } else if (document.getElementById('manual-entry-tab').classList.contains('active')) {
          renderRecentItems();
        } else if (document.getElementById('inventory-tab').classList.contains('active')) {
          renderInventory();
        } else if (document.getElementById('cash-drawer-tab').classList.contains('active')) {
          renderCashDrawer();
        } else if (document.getElementById('warehouse-tab').classList.contains('active') && state.warehouseUnlocked) {
          renderWarehouse();
        } else if (document.getElementById('customers-tab').classList.contains('active')) {
          renderCustomers();
        } else if (document.getElementById('invoices-tab').classList.contains('active')) {
          renderInvoices();
        } else if (document.getElementById('admin-tab').classList.contains('active') && state.adminUnlocked) {
          renderAdminDashboard();
        }
        
        showAlert('success', 'Data loaded successfully.');
      })
      .catch(error => {
        console.error('Error loading data:', error);
        hideLoader();
        showAlert('error', 'Error loading data: ' + error.message);
      });
    }
    
    function saveAllData() {
      showLoader();
      
      const batch = db.batch();
      
      // Save inventory
      state.inventory.forEach(item => {
        const itemRef = db.collection('inventory').doc(item.id.toString());
        batch.set(itemRef, item);
      });
      
      // Save cash drawer
      if (state.cashDrawer) {
        const drawerRef = db.collection('cashDrawer').doc(state.cashDrawer.id.toString());
        batch.set(drawerRef, state.cashDrawer);
      }
      
      // Save transactions
      state.transactions.forEach(transaction => {
        const transactionRef = db.collection('transactions').doc(transaction.id.toString());
        batch.set(transactionRef, transaction);
      });
      
      // Save logs (only save the most recent 1000)
      const recentLogs = state.logs.slice(0, 1000);
      recentLogs.forEach(log => {
        const logRef = db.collection('logs').doc(log.id ? log.id.toString() : Date.now().toString());
        batch.set(logRef, log);
      });
      
      // Save customers
      state.customers.forEach(customer => {
        const customerRef = db.collection('customers').doc(customer.id.toString());
        batch.set(customerRef, customer);
      });
      
      // Save invoices
      state.invoices.forEach(invoice => {
        const invoiceRef = db.collection('invoices').doc(invoice.id.toString());
        batch.set(invoiceRef, invoice);
      });
      
      // Save payments
      state.payments.forEach(payment => {
        const paymentRef = db.collection('payments').doc(payment.id.toString());
        batch.set(paymentRef, payment);
      });
      
      // Save settings
      const settingsRef = db.collection('settings').doc('system');
      batch.set(settingsRef, state.settings);
      
      // Save users
      state.users.forEach(user => {
        const userRef = db.collection('users').doc(user.id.toString());
        batch.set(userRef, user);
      });
      
      // Save backup settings
      const backupSettingsRef = db.collection('settings').doc('backup');
      batch.set(backupSettingsRef, state.backupSettings);
      
      return batch.commit()
        .then(() => {
          hideLoader();
          console.log('All data saved successfully.');
          return true;
        })
        .catch(error => {
          hideLoader();
          console.error('Error saving data:', error);
          showAlert('error', 'Error saving data: ' + error.message);
          return false;
        });
    }
    
    // Create a backup
    function createBackup() {
      showLoader();
      
      const backup = {
        id: Date.now().toString(),
        created_at: new Date().toISOString(),
        created_by: 'admin',
        inventory: state.inventory,
        cashDrawer: state.cashDrawer,
        transactions: state.transactions,
        customers: state.customers,
        invoices: state.invoices,
        payments: state.payments,
        settings: state.settings,
        users: state.users
      };
      
      return db.collection('backups').doc(backup.id).set(backup)
        .then(() => {
          // Update system status
          return db.collection('system').doc('status').update({
            lastBackup: new Date().toISOString()
          });
        })
        .then(() => {
          // Add to backups list
          state.backups.unshift({
            id: backup.id,
            created_at: backup.created_at,
            created_by: backup.created_by,
            size: JSON.stringify(backup).length
          });
          
          hideLoader();
          showAlert('success', 'Backup created successfully.');
          
          // Render backups if on backup tab
          if (document.getElementById('admin-backup-tab').classList.contains('active')) {
            renderBackups();
          }
          
          return true;
        })
        .catch(error => {
          hideLoader();
          console.error('Error creating backup:', error);
          showAlert('error', 'Error creating backup: ' + error.message);
          return false;
        });
    }
    
    // Restore from backup
    function restoreFromBackup(backupId) {
      showLoader();
      
      return db.collection('backups').doc(backupId).get()
        .then(doc => {
          if (doc.exists) {
            const backup = doc.data();
            
            // Restore state from backup
            state.inventory = backup.inventory || [];
            state.cashDrawer = backup.cashDrawer || null;
            state.transactions = backup.transactions || [];
            state.customers = backup.customers || [];
            state.invoices = backup.invoices || [];
            state.payments = backup.payments || [];
            state.settings = backup.settings || {
              conditionAgeDays: 45,
              taxRate: 8.25,
              invoiceDueDays: 30,
              lowStockThreshold: 5
            };
            state.users = backup.users || [{
              id: 'admin',
              username: 'admin',
              role: 'admin',
              email: 'admin@example.com',
              lastLogin: new Date().toISOString(),
              status: 'active'
            }];
            
            // Save restored data
            return saveAllData();
          } else {
            throw new Error('Backup not found');
          }
        })
        .then(() => {
          hideLoader();
          showAlert('success', 'Backup restored successfully.');
          
          // Reload current view
          if (document.getElementById('lookup-tab').classList.contains('active')) {
            // Nothing to render for lookup tab
          } else if (document.getElementById('manual-entry-tab').classList.contains('active')) {
            renderRecentItems();
          } else if (document.getElementById('inventory-tab').classList.contains('active')) {
            renderInventory();
          } else if (document.getElementById('cash-drawer-tab').classList.contains('active')) {
            renderCashDrawer();
          } else if (document.getElementById('warehouse-tab').classList.contains('active') && state.warehouseUnlocked) {
            renderWarehouse();
          } else if (document.getElementById('customers-tab').classList.contains('active')) {
            renderCustomers();
          } else if (document.getElementById('invoices-tab').classList.contains('active')) {
            renderInvoices();
          } else if (document.getElementById('admin-tab').classList.contains('active') && state.adminUnlocked) {
            renderAdminDashboard();
          }
          
          return true;
        })
        .catch(error => {
          hideLoader();
          console.error('Error restoring backup:', error);
          showAlert('error', 'Error restoring backup: ' + error.message);
          return false;
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Setup device typeahead
      setupDeviceTypeahead();
      
      // Setup color typeahead
      setupColorTypeahead();
      
      // Setup event listeners
      setupEventListeners();
      
      // Setup sub-tab event listeners
      setupSubTabEventListeners();
      
      // Check API balance
      checkBalance();
      
      // Initialize data
      initializeData();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  
  <!-- Firebase for data persistence -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</body>
</html>