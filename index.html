<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Inventory Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #00e29b;
      --primary-dark: #00b37a;
      --secondary: #18344a;
      --secondary-light: #1f4060;
      --background: #0b0f14;
      --card-bg: #0f141a;
      --input-bg: #0d1218;
      --border: #213244;
      --text: #e6f1ff;
      --text-muted: #a0b8d0;
      --success: #48ffb3;
      --warning: #ffb648;
      --error: #ff4848;
      --info: #48b6ff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }
    
    h1, h2, h3, h4, h5, h6 {
      color: var(--text);
      margin-bottom: 15px;
    }
    
    a {
      color: var(--primary);
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
    }
    
    .header h1 i {
      margin-right: 10px;
      color: var(--primary);
    }
    
    .header-right {
      display: flex;
      align-items: center;
    }
    
    .api-balance {
      background: var(--secondary);
      padding: 8px 15px;
      border-radius: 8px;
      margin-right: 15px;
      display: flex;
      align-items: center;
    }
    
    .api-balance i {
      margin-right: 8px;
      color: var(--primary);
    }
    
    .refresh-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      margin-left: 8px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .tab {
      padding: 10px 20px;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }
    
    .tab i {
      margin-right: 8px;
    }
    
    .tab:hover {
      color: var(--text);
      text-decoration: none;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    textarea, input[type="text"], input[type="number"], input[type="password"], select {
      width: 100%;
      padding: 10px 15px;
      background-color: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 15px;
      transition: border-color 0.3s ease;
    }
    
    textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, select:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      background-color: var(--primary);
      color: var(--background);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn i {
      margin-right: 8px;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--text);
    }
    
    .btn-secondary:hover {
      background-color: var(--secondary-light);
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-muted);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-row > div {
      flex: 1;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .alert i {
      margin-right: 10px;
      font-size: 18px;
    }
    
    .success {
      background-color: rgba(72, 255, 179, 0.1);
      border-left: 4px solid var(--success);
      color: var(--success);
    }
    
    .error {
      background-color: rgba(255, 72, 72, 0.1);
      border-left: 4px solid var(--error);
      color: var(--error);
    }
    
    .warning {
      background-color: rgba(255, 182, 72, 0.1);
      border-left: 4px solid var(--warning);
      color: var(--warning);
    }
    
    .info {
      background-color: rgba(72, 182, 255, 0.1);
      border-left: 4px solid var(--info);
      color: var(--info);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      color: var(--text-muted);
      font-weight: 500;
    }
    
    tr:hover {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-right: 5px;
      margin-top: 5px;
    }
    
    .tag.success {
      background-color: rgba(72, 255, 179, 0.1);
      color: var(--success);
      border: 1px solid rgba(72, 255, 179, 0.3);
    }
    
    .tag.error {
      background-color: rgba(255, 72, 72, 0.1);
      color: var(--error);
      border: 1px solid rgba(255, 72, 72, 0.3);
    }
    
    .tag.warning {
      background-color: rgba(255, 182, 72, 0.1);
      color: var(--warning);
      border: 1px solid rgba(255, 182, 72, 0.3);
    }
    
    .tag.info {
      background-color: rgba(72, 182, 255, 0.1);
      color: var(--info);
      border: 1px solid rgba(72, 182, 255, 0.3);
    }
    
    .warning-tag {
      margin-left: 8px;
    }
    
    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .right {
      text-align: right;
    }
    
    .center {
      text-align: center;
    }
    
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(11, 15, 20, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .loader.show {
      visibility: visible;
      opacity: 1;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 226, 155, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(11, 15, 20, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .modal.show {
      visibility: visible;
      opacity: 1;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .modal.show .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }
    
    .compact-manual-entry {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }
    
    .compact-manual-entry input,
    .compact-manual-entry select {
      margin-bottom: 0;
    }
    
    .typeahead {
      position: relative;
    }
    
    .typeahead-results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .typeahead-results.show {
      display: block;
    }
    
    .typeahead-item {
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .typeahead-item:hover {
      background-color: var(--secondary);
    }
    
    .cash-drawer-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .cash-stat {
      background: var(--secondary);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .cash-stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-top: 5px;
    }
    
    .cash-stat-label {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .transaction-list {
      margin-top: 20px;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .pagination a {
      padding: 8px 12px;
      margin: 0 5px;
      border-radius: 4px;
      background-color: var(--secondary);
      color: var(--text);
      transition: all 0.3s ease;
    }
    
    .pagination a:hover {
      background-color: var(--secondary-light);
      text-decoration: none;
    }
    
    .pagination a.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .admin-panel {
      padding: 20px;
      background-color: var(--secondary);
      border-radius: 10px;
      margin-top: 20px;
    }
    
    .admin-panel h3 {
      margin-top: 0;
    }
    
    .log-entry {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-timestamp {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .log-action {
      font-weight: 500;
    }
    
    .log-details {
      margin-top: 5px;
      font-size: 13px;
    }
    
    .passcode-input {
      letter-spacing: 0.5em;
      text-align: center;
      font-size: 24px;
    }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-boxes"></i> Enhanced Inventory Management</h1>
      <div class="header-right">
        <div class="api-balance">
          <i class="fas fa-wallet"></i>
          <span>API Balance: <span id="balance-value">Loading...</span></span>
          <button class="refresh-btn" id="refresh-balance"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>
    </div>
    
    <div class="tabs">
      <a href="#lookup" class="tab active" data-tab="lookup">
        <i class="fas fa-search"></i> IMEI Lookup
      </a>
      <a href="#inventory" class="tab" data-tab="inventory">
        <i class="fas fa-boxes"></i> Inventory
      </a>
      <a href="#cash-drawer" class="tab" data-tab="cash-drawer">
        <i class="fas fa-cash-register"></i> Cash Drawer
      </a>
      <a href="#warehouse" class="tab" data-tab="warehouse">
        <i class="fas fa-warehouse"></i> Warehouse
      </a>
      <a href="#admin" class="tab" data-tab="admin">
        <i class="fas fa-shield-alt"></i> Admin
      </a>
    </div>
    
    <div id="alerts-container">
      <!-- Alerts will be dynamically inserted here -->
    </div>
    
    <!-- IMEI Lookup Tab -->
    <div id="lookup-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>Bulk IMEI Lookup</h2>
        </div>
        
        <div class="form-group">
          <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
          <textarea id="imeis" rows="5" placeholder="Enter IMEIs here..."></textarea>
          <p class="muted">We'll fetch details from Sickw and suggest a price by matching the device name to the site's CSV.</p>
        </div>
        
        <div class="form-group">
          <div class="btn-group">
            <button class="btn" id="lookup-btn">
              <i class="fas fa-search"></i> Lookup IMEIs
            </button>
            <button class="btn btn-secondary" id="reset-btn">
              <i class="fas fa-times"></i> Reset
            </button>
          </div>
        </div>
      </div>
      
      <div id="results-container" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2>Results</h2>
            <div class="btn-group">
              <button class="btn" id="import-to-inventory-btn">
                <i class="fas fa-file-import"></i> Import to Inventory
              </button>
              <button class="btn" id="import-to-warehouse-btn">
                <i class="fas fa-warehouse"></i> Import to Warehouse
              </button>
              <button class="btn btn-secondary" id="download">
                <i class="fas fa-download"></i> Download CSV
              </button>
            </div>
          </div>
          
          <div class="table-responsive">
            <table id="results-table">
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="select-all">
                  </th>
                  <th>IMEI</th>
                  <th>Device</th>
                  <th>Color</th>
                  <th>Storage</th>
                  <th>Carrier</th>
                  <th>Condition</th>
                  <th>Price Paid</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="results-body">
                <!-- Results will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <div class="form-row">
              <div>
                <h3 id="totals">Total: $0.00</h3>
              </div>
              <div>
                <h3 id="total-devices">Total Devices: 0</h3>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2>Add Manual Item</h2>
          </div>
          
          <div class="compact-manual-entry">
            <div class="typeahead">
              <input type="text" id="m_device" placeholder="Device Name">
              <div class="typeahead-results" id="device-results"></div>
            </div>
            <div class="typeahead">
              <input type="text" id="m_color" placeholder="Color">
              <div class="typeahead-results" id="color-results"></div>
            </div>
            <input type="text" id="m_storage" placeholder="Storage">
            <select id="m_carrier">
              <option value="Unknown">Carrier</option>
              <option value="Unlocked">Unlocked</option>
              <option value="AT&T">AT&T</option>
              <option value="Verizon">Verizon</option>
              <option value="T-Mobile">T-Mobile</option>
              <option value="Sprint">Sprint</option>
              <option value="Other">Other</option>
            </select>
            <div style="display: flex; gap: 10px;">
              <input type="number" id="m_price" placeholder="Price" style="flex: 1;">
              <button class="btn" id="addManual" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Inventory Tab -->
    <div id="inventory-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Inventory Management</h2>
          <button class="btn" id="transfer-to-warehouse-btn">
            <i class="fas fa-truck-loading"></i> Transfer to Warehouse
          </button>
        </div>
        
        <div class="form-row">
          <div>
            <input type="text" id="inventory-search" placeholder="Search by IMEI or device name">
          </div>
          <div style="flex: 0 0 auto;">
            <button class="btn" id="inventory-search-btn">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
          <div style="flex: 0 0 auto;">
            <select id="status-filter">
              <option value="all">All Status</option>
              <option value="in_stock" selected>In Stock</option>
              <option value="sold">Sold</option>
              <option value="transferred">Transferred</option>
            </select>
          </div>
          <div style="flex: 0 0 auto;">
            <select id="location-filter">
              <option value="all">All Locations</option>
              <option value="store" selected>Store</option>
              <option value="warehouse">Warehouse</option>
            </select>
          </div>
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th style="width: 30px;">
                  <input type="checkbox" id="inventory-select-all">
                </th>
                <th>IMEI</th>
                <th>Device</th>
                <th>Condition</th>
                <th>Carrier</th>
                <th>Price Paid</th>
                <th>Status</th>
                <th>Location</th>
                <th>Date Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-body">
              <!-- Inventory items will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
        
        <div class="pagination" id="inventory-pagination">
          <!-- Pagination will be dynamically inserted here -->
        </div>
      </div>
    </div>
    
    <!-- Cash Drawer Tab -->
    <div id="cash-drawer-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Cash Drawer Management</h2>
          <div id="cash-drawer-actions">
            <button class="btn" id="open-drawer-btn">
              <i class="fas fa-cash-register"></i> Open Drawer
            </button>
          </div>
        </div>
        
        <div id="cash-drawer-content">
          <!-- Cash drawer content will be dynamically inserted here -->
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3>Recent Transactions</h3>
            <button class="btn" id="add-transaction-btn">
              <i class="fas fa-plus"></i> Add Transaction
            </button>
          </div>
          
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="transactions-body">
                <!-- Transactions will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Warehouse Tab -->
    <div id="warehouse-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Warehouse Management</h2>
        </div>
        
        <div id="warehouse-locked">
          <div style="text-align: center; padding: 50px 20px;">
            <i class="fas fa-lock" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
            <h3>Warehouse Access Restricted</h3>
            <p class="muted">Enter passcode to access warehouse inventory</p>
            <div style="max-width: 200px; margin: 20px auto;">
              <input type="password" id="warehouse-passcode" class="passcode-input" placeholder="****" maxlength="4">
              <button class="btn" id="warehouse-unlock-btn" style="width: 100%; margin-top: 10px;">
                <i class="fas fa-unlock"></i> Unlock
              </button>
            </div>
          </div>
        </div>
        
        <div id="warehouse-content" style="display: none;">
          <div class="form-row">
            <div>
              <input type="text" id="warehouse-search" placeholder="Search by IMEI or device name">
            </div>
            <div style="flex: 0 0 auto;">
              <button class="btn" id="warehouse-search-btn">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
            <div style="flex: 0 0 auto;">
              <select id="warehouse-status-filter">
                <option value="all">All Status</option>
                <option value="in_stock" selected>In Stock</option>
                <option value="sold">Sold</option>
                <option value="transferred">Transferred</option>
              </select>
            </div>
          </div>
          
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="warehouse-select-all">
                  </th>
                  <th>IMEI</th>
                  <th>Device</th>
                  <th>Condition</th>
                  <th>Carrier</th>
                  <th>Price Paid</th>
                  <th>Status</th>
                  <th>Date Added</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="warehouse-body">
                <!-- Warehouse items will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
          
          <div class="pagination" id="warehouse-pagination">
            <!-- Pagination will be dynamically inserted here -->
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3>Add Device to Warehouse</h3>
            </div>
            
            <div class="form-row">
              <div>
                <label>Device</label>
                <div class="typeahead">
                  <input type="text" id="w_device" placeholder="Device Name">
                  <div class="typeahead-results" id="w-device-results"></div>
                </div>
              </div>
              <div>
                <label>Color</label>
                <div class="typeahead">
                  <input type="text" id="w_color" placeholder="Color">
                  <div class="typeahead-results" id="w-color-results"></div>
                </div>
              </div>
              <div>
                <label>Storage</label>
                <input type="text" id="w_storage" placeholder="Storage">
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>IMEI/Serial</label>
                <input type="text" id="w_imei" placeholder="IMEI or Serial Number">
              </div>
              <div>
                <label>Carrier</label>
                <select id="w_carrier">
                  <option value="Unknown">Select Carrier</option>
                  <option value="Unlocked">Unlocked</option>
                  <option value="AT&T">AT&T</option>
                  <option value="Verizon">Verizon</option>
                  <option value="T-Mobile">T-Mobile</option>
                  <option value="Sprint">Sprint</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label>Condition</label>
                <select id="w_condition">
                  <option value="A">A - Like New</option>
                  <option value="B" selected>B - Good</option>
                  <option value="C">C - Fair</option>
                  <option value="D">D - Poor</option>
                </select>
              </div>
              <div>
                <label>Price Paid</label>
                <input type="number" id="w_price" placeholder="Price" step="0.01">
              </div>
            </div>
            
            <div class="form-group">
              <label>Notes</label>
              <textarea id="w_notes" rows="2" placeholder="Additional notes..."></textarea>
            </div>
            
            <div class="form-group">
              <button class="btn" id="add-warehouse-device-btn">
                <i class="fas fa-plus"></i> Add to Warehouse
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Admin Tab -->
    <div id="admin-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Admin Panel</h2>
        </div>
        
        <div id="admin-locked">
          <div style="text-align: center; padding: 50px 20px;">
            <i class="fas fa-shield-alt" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
            <h3>Admin Access Restricted</h3>
            <p class="muted">Enter admin passcode to access admin panel</p>
            <div style="max-width: 200px; margin: 20px auto;">
              <input type="password" id="admin-passcode" class="passcode-input" placeholder="****" maxlength="4">
              <button class="btn" id="admin-unlock-btn" style="width: 100%; margin-top: 10px;">
                <i class="fas fa-unlock"></i> Unlock
              </button>
            </div>
          </div>
        </div>
        
        <div id="admin-content" style="display: none;">
          <div class="form-row">
            <div>
              <select id="log-filter">
                <option value="all">All Actions</option>
                <option value="inventory_add">Inventory Add</option>
                <option value="inventory_edit">Inventory Edit</option>
                <option value="inventory_delete">Inventory Delete</option>
                <option value="transfer">Transfer</option>
                <option value="cash_drawer">Cash Drawer</option>
                <option value="transaction">Transaction</option>
              </select>
            </div>
            <div style="flex: 0 0 auto;">
              <button class="btn" id="filter-logs-btn">
                <i class="fas fa-filter"></i> Filter
              </button>
            </div>
          </div>
          
          <div class="admin-panel">
            <h3>System Logs</h3>
            <div id="system-logs">
              <!-- Logs will be dynamically inserted here -->
            </div>
          </div>
          
          <div class="admin-panel" style="margin-top: 20px;">
            <h3>System Settings</h3>
            <div class="form-group">
              <label>Default Device Condition Age (days)</label>
              <input type="number" id="condition-age-setting" value="45" min="1">
              <p class="muted">Devices older than this will be automatically marked as B grade</p>
            </div>
            <div class="form-group">
              <button class="btn" id="save-settings-btn">
                <i class="fas fa-save"></i> Save Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal" id="import-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Import to Inventory</h3>
          <button class="modal-close" id="import-modal-close">&times;</button>
        </div>
        <p>Are you sure you want to import the selected items to inventory?</p>
        <p class="muted">This will deduct the total amount from the cash drawer.</p>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="import-modal-cancel">Cancel</button>
          <button class="btn" id="import-confirm">Import</button>
        </div>
      </div>
    </div>
    
    <!-- Import to Warehouse Modal -->
    <div class="modal" id="import-warehouse-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Import to Warehouse</h3>
          <button class="modal-close" id="import-warehouse-modal-close">&times;</button>
        </div>
        <p>Are you sure you want to import the selected items directly to warehouse?</p>
        <p class="muted">This will NOT deduct the amount from the cash drawer.</p>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="import-warehouse-modal-cancel">Cancel</button>
          <button class="btn" id="import-warehouse-confirm">Import</button>
        </div>
      </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal" id="transfer-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Transfer to Warehouse</h3>
          <button class="modal-close" id="transfer-modal-close">&times;</button>
        </div>
        <p>Are you sure you want to transfer the selected items to warehouse?</p>
        <div class="form-group">
          <label>Transfer Notes</label>
          <textarea id="transfer-notes-input" rows="3" placeholder="Add notes about this transfer..."></textarea>
          <input type="hidden" id="transfer-notes">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="transfer-modal-cancel">Cancel</button>
          <button class="btn" id="transfer-confirm">Transfer</button>
        </div>
      </div>
    </div>
    
    <!-- Edit Item Modal -->
    <div class="modal" id="edit-item-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Inventory Item</h3>
          <button class="modal-close" id="edit-item-modal-close">&times;</button>
        </div>
        <input type="hidden" id="edit-item-id">
        <div class="form-row">
          <div>
            <label>Device</label>
            <input type="text" id="edit-device" placeholder="Device Name">
          </div>
          <div>
            <label>Color</label>
            <input type="text" id="edit-color" placeholder="Color">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Storage</label>
            <input type="text" id="edit-storage" placeholder="Storage">
          </div>
          <div>
            <label>Carrier</label>
            <select id="edit-carrier">
              <option value="Unknown">Unknown</option>
              <option value="Unlocked">Unlocked</option>
              <option value="AT&T">AT&T</option>
              <option value="Verizon">Verizon</option>
              <option value="T-Mobile">T-Mobile</option>
              <option value="Sprint">Sprint</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Condition</label>
            <select id="edit-condition">
              <option value="A">A - Like New</option>
              <option value="B">B - Good</option>
              <option value="C">C - Fair</option>
              <option value="D">D - Poor</option>
            </select>
          </div>
          <div>
            <label>Price Paid</label>
            <input type="number" id="edit-price" placeholder="Price" step="0.01">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="edit-notes" rows="3" placeholder="Additional notes..."></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="edit-item-modal-cancel">Cancel</button>
          <button class="btn" id="edit-item-confirm">Save Changes</button>
        </div>
      </div>
    </div>
    
    <!-- Add Transaction Modal -->
    <div class="modal" id="add-transaction-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Transaction</h3>
          <button class="modal-close" id="add-transaction-modal-close">&times;</button>
        </div>
        <div class="form-group">
          <label>Transaction Type</label>
          <select id="transaction-type">
            <option value="deposit">Deposit (Add Cash)</option>
            <option value="withdrawal">Withdrawal (Remove Cash)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="transaction-amount" placeholder="Amount" step="0.01">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="transaction-description" rows="3" placeholder="Transaction description..."></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="add-transaction-modal-cancel">Cancel</button>
          <button class="btn" id="add-transaction-confirm">Add Transaction</button>
        </div>
      </div>
    </div>
    
    <!-- Open Cash Drawer Modal -->
    <div class="modal" id="open-drawer-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Open Cash Drawer</h3>
          <button class="modal-close" id="open-drawer-modal-close">&times;</button>
        </div>
        <form id="open-drawer-form">
          <div class="form-group">
            <label>Opening Amount</label>
            <input type="number" id="opening-amount" placeholder="Amount" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="open-drawer-notes" rows="3" placeholder="Additional notes..."></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="open-drawer-modal-cancel">Cancel</button>
            <button type="submit" class="btn">Open Drawer</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Loader -->
    <div class="loader" id="loader">
      <div class="spinner"></div>
    </div>
  </div>
  
  <script>
    // State management
    const state = {
      rows: [],
      manual: [],
      inventory: [],
      cashDrawer: null,
      transactions: [],
      logs: [],
      currentPage: 1,
      itemsPerPage: 10,
      filters: {
        status: 'in_stock',
        location: 'store',
        search: ''
      },
      warehouseFilters: {
        status: 'in_stock',
        search: ''
      },
      settings: {
        conditionAgeDays: 45
      },
      adminUnlocked: false,
      warehouseUnlocked: false
    };
    
    // Helper functions
    function formatMoney(cents) {
      return '$' + (cents / 100).toFixed(2);
    }

    function escapeHtml(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function showLoader() {
      document.getElementById('loader').classList.add('show');
    }

    function hideLoader() {
      document.getElementById('loader').classList.remove('show');
    }

    function showAlert(type, message) {
      const alertsContainer = document.getElementById('alerts-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${type}`;
      
      let icon = '';
      if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
      else if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
      else if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';
      else if (type === 'info') icon = '<i class="fas fa-info-circle"></i>';
      
      alertDiv.innerHTML = `${icon} ${message}`;
      alertsContainer.appendChild(alertDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => {
          alertsContainer.removeChild(alertDiv);
        }, 300);
      }, 5000);
    }

    function getDaysSincePurchase(dateStr) {
      if (!dateStr) return null;
      
      const purchaseDate = new Date(dateStr);
      if (isNaN(purchaseDate.getTime())) return null;
      
      const today = new Date();
      const diffTime = Math.abs(today - purchaseDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }

    function checkDeviceCondition(purchaseDate) {
      const days = getDaysSincePurchase(purchaseDate);
      
      if (days === null) return { condition: 'NIB', warning: null };
      
      if (days > state.settings.conditionAgeDays) {
        return { 
          condition: "B", 
          warning: '<span class="tag error warning-tag">B Grade (45+ days)</span>' 
        };
      }
      
      return { condition: 'NIB', warning: null };
    }

    function addSystemLog(action, details) {
      const log = {
        timestamp: new Date().toISOString(),
        action: action,
        details: details
      };
      
      state.logs.unshift(log);
      
      // Keep logs to a reasonable size
      if (state.logs.length > 1000) {
        state.logs = state.logs.slice(0, 1000);
      }
      
      // If admin panel is open, update the logs display
      if (state.adminUnlocked) {
        renderSystemLogs();
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    function formatShortDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // IMEI lookup function
    function lookupIMEIs() {
      const imeisText = document.getElementById('imeis').value;
      if (!imeisText.trim()) {
        showAlert('error', 'Please enter at least one IMEI.');
        return;
      }
      
      const imeis = imeisText.split(/[\s,;]+/).map(s => s.trim()).filter(Boolean);
      if (!imeis.length) {
        showAlert('error', 'Please enter valid IMEIs.');
        return;
      }
      
      showLoader();
      
      fetch('/api/intake', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imeis: imeis })
      })
      .then(response => response.json())
      .then(data => {
        hideLoader();
        
        if (data.items && data.items.length) {
          state.rows = data.items;
          renderResults();
          document.getElementById('results-container').style.display = 'block';
        } else {
          showAlert('error', 'No results returned.');
        }
      })
      .catch(error => {
        hideLoader();
        showAlert('error', 'Error looking up IMEIs: ' + error.message);
        console.error('Error:', error);
      });
    }

    // Render results table
    function renderResults() {
      const tbody = document.getElementById('results-body');
      tbody.innerHTML = '';
      
      state.rows.forEach((r, idx) => {
        if (!r.ok) {
          const errorRow = document.createElement('tr');
          errorRow.innerHTML = `
            <td></td>
            <td colspan="9" class="error">
              <i class="fas fa-exclamation-circle"></i>
              IMEI ${escapeHtml(r.imei)} → ${escapeHtml(r.error || 'error')}
            </td>
          `;
          tbody.appendChild(errorRow);
          return;
        }
        
        // Check device condition based on purchase date
        const conditionCheck = checkDeviceCondition(r.estimated_purchase_date);
        
        // Add warning for iCloud lock
        const iCloudWarning = r.icloud_lock_on ? 
          '<span class="tag error warning-tag">iCloud Lock: ON</span>' : '';
        
        // Combine all warnings
        const warnings = (conditionCheck.warning || '') + iCloudWarning;
        
        // Convert cents to dollars for display
        const suggestedPriceDollars = r.suggested_price_cents ? 
          (r.suggested_price_cents / 100).toFixed(2) : '';
        
        const row = document.createElement('tr');
        row.className = 'result-row';
        row.setAttribute('data-idx', idx);
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="select-item" data-idx="${idx}">
          </td>
          <td><code>${escapeHtml(r.imei)}</code></td>
          <td>
            ${escapeHtml(r.device_display || ((r.manufacturer || '') + ' ' + (r.model_name || '')))}
            ${warnings}
            ${r.estimated_purchase_date ? 
              `<div class="muted">Est. Purchase: ${r.estimated_purchase_date} 
               ${typeof r.estimated_purchase_age_days === 'number' ? 
                 `(${r.estimated_purchase_age_days}d ago)` : ''}
               </div>` : ''}
          </td>
          <td>${escapeHtml(r.color || '')}</td>
          <td>${escapeHtml(r.storage || '')}</td>
          <td>
            <select class="carrier-select" data-idx="${idx}">
              <option value="Unknown" ${r.carrier === 'Unknown' ? 'selected' : ''}>Unknown</option>
              <option value="Unlocked" ${r.carrier === 'Unlocked' ? 'selected' : ''}>Unlocked</option>
              <option value="AT&T" ${r.carrier === 'AT&T' ? 'selected' : ''}>AT&T</option>
              <option value="Verizon" ${r.carrier === 'Verizon' ? 'selected' : ''}>Verizon</option>
              <option value="T-Mobile" ${r.carrier === 'T-Mobile' ? 'selected' : ''}>T-Mobile</option>
              <option value="Sprint" ${r.carrier === 'Sprint' ? 'selected' : ''}>Sprint</option>
              <option value="Other" ${r.carrier === 'Other' ? 'selected' : ''}>Other</option>
            </select>
          </td>
          <td>
            <select class="condition-select" data-idx="${idx}">
              <option value="NIB" ${conditionCheck.condition === 'NIB' ? 'selected' : ''}>NIB</option>
              <option value="A" ${conditionCheck.condition === 'A' ? 'selected' : ''}>A</option>
              <option value="B" ${conditionCheck.condition === 'B' ? 'selected' : ''}>B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </td>
          <td class="right">
            <input type="number" class="price-paid" data-idx="${idx}" value="${suggestedPriceDollars}" step="0.01" min="0">
          </td>
          <td>
            <input type="text" class="notes" data-idx="${idx}" placeholder="Notes...">
          </td>
        `;
        
        tbody.appendChild(row);
        
        // Hidden fields for data storage
        const hiddenFields = document.createElement('div');
        hiddenFields.style.display = 'none';
        hiddenFields.innerHTML = `
          <input type="hidden" class="imei" data-idx="${idx}" value="${escapeHtml(r.imei)}">
          <input type="hidden" class="manufacturer" data-idx="${idx}" value="${escapeHtml(r.manufacturer || '')}">
          <input type="hidden" class="model-name" data-idx="${idx}" value="${escapeHtml(r.model_name || '')}">
          <input type="hidden" class="model-code" data-idx="${idx}" value="${escapeHtml(r.model_code || '')}">
          <input type="hidden" class="device-display" data-idx="${idx}" value="${escapeHtml(r.device_display || '')}">
          <input type="hidden" class="suggested-price" data-idx="${idx}" value="${escapeHtml(String(r.suggested_price_cents || ''))}">
          <input type="hidden" class="condition-hint" data-idx="${idx}" value="${escapeHtml(String(conditionCheck.condition || ''))}">
          <input type="hidden" class="icloud-lock" data-idx="${idx}" value="${r.icloud_lock_on ? 'ON' : 'OFF'}">
        `;
        tbody.appendChild(hiddenFields);
      });
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
      
      // Update price paid when condition changes
      document.querySelectorAll('.condition-select').forEach(select => {
        select.addEventListener('change', function() {
          const idx = this.getAttribute('data-idx');
          const pricePaidInput = document.querySelector(`.price-paid[data-idx="${idx}"]`);
          
          // If condition is changed, we might want to adjust the price
          // For now, we'll keep the price the same
        });
      });
      
      // Manual rows
      state.manual.forEach((r, idx) => {
        const row = document.createElement('tr');
        row.className = 'manual-row';
        row.setAttribute('data-idx', idx);
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="select-item manual" data-idx="m${idx}" checked>
          </td>
          <td><input type="text" class="mident" data-idx="${idx}" placeholder="IMEI/Serial"></td>
          <td>${escapeHtml(r.device || '')}</td>
          <td>${escapeHtml(r.color || '')}</td>
          <td>${escapeHtml(r.storage || '')}</td>
          <td><span class="tag">${escapeHtml(r.carrier || 'Unknown')}</span></td>
          <td><div class="muted">—</div></td>
          <td class="right"><input type="number" class="mpaid" data-idx="${idx}" value="${escapeHtml(String(r.unitPrice || ''))}" step="0.01" min="0" /></td>
          <td><input type="text" class="mnote" data-idx="${idx}" value="${escapeHtml(r.notes || '')}" /></td>
        </tr>`;
        
        tbody.appendChild(row);
      });
      
      // Update totals
      computeTotals();
      updateTotalDevices();
      
      // Identifier validation
      function refreshIdentifierValidation() {
        const inputs = Array.from(document.querySelectorAll('.mident'));
        const seen = new Map();
        inputs.forEach(inp => {
          const v = inp.value.trim();
          if (!v) return;
          
          if (seen.has(v)) {
            inp.classList.add('error');
            seen.get(v).classList.add('error');
          } else {
            inp.classList.remove('error');
            seen.set(v, inp);
          }
        });
      }
      
      // Update validation when identifiers change
      document.querySelectorAll('.mident').forEach(inp => {
        inp.addEventListener('input', refreshIdentifierValidation);
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].identifier = this.value.trim();
          }
        });
      });
      
      // Update state when prices change
      document.querySelectorAll('.price-paid').forEach(inp => {
        inp.addEventListener('input', computeTotals);
      });
      
      document.querySelectorAll('.mpaid').forEach(inp => {
        inp.addEventListener('input', computeTotals);
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].unitPrice = Number(this.value || 0);
          }
        });
      });
      
      // Update state when notes change
      document.querySelectorAll('.mnote').forEach(inp => {
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].notes = this.value.trim();
          }
        });
      });
      
      // Enter → focus next identifier
      const idents = Array.from(document.querySelectorAll('.mident'));
      idents.forEach((inp, i) => {
        inp.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const next = idents[i + 1];
            if (next) next.focus();
          }
        });
      });
      
      // Download CSV
      document.getElementById('download').addEventListener('click', downloadCSV);
      
      computeTotals();
      
      // Focus first empty identifier
      setTimeout(function() {
        const firstEmpty = Array.from(document.querySelectorAll('.mident')).find(inp => !inp.value);
        if (firstEmpty) firstEmpty.focus();
      }, 0);
    }

    // Compute totals
    function computeTotals() {
      let totalDollars = 0;
      
      // Add API rows
      document.querySelectorAll('.price-paid').forEach(inp => {
        const v = Number(inp.value || '');
        if (isFinite(v)) totalDollars += v;
      });
      
      // Add manual rows
      document.querySelectorAll('.mpaid').forEach(inp => {
        const v = Number(inp.value || '');
        if (isFinite(v)) totalDollars += v;
      });
      
      document.getElementById('totals').innerText = 'Total: $' + totalDollars.toFixed(2);
    }

    // Update total devices count
    function updateTotalDevices() {
      let count = 0;
      
      // Count API rows
      count += state.rows.filter(r => r.ok).length;
      
      // Count manual rows
      count += state.manual.length;
      
      document.getElementById('total-devices').innerText = `Total Devices: ${count}`;
    }

    // Download CSV
    function downloadCSV() {
      const payload = [];
      
      // API rows
      state.rows.forEach((r, idx) => {
        if (!r.ok) return;
        
        const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
        const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
        const carrierEl = document.querySelector(`.carrier-select[data-idx="${idx}"]`);
        const conditionEl = document.querySelector(`.condition-select[data-idx="${idx}"]`);
        
        const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
        const cents = isFinite(dollars) ? Math.round(dollars * 100) : ''; // Convert to cents
        const carrier = carrierEl ? carrierEl.value : (r.carrier || 'Unknown');
        const condition = conditionEl ? conditionEl.value : 'B';
        
        payload.push({
          manual: 'no',
          used: r.used ? 'yes' : 'no',
          used_source: r.used_source || '',
          identifier: r.imei,
          manufacturer: r.manufacturer || '',
          model_name: r.model_name || '',
          model_code: r.model_code || '',
          device: r.device_display || '',
          color: r.color || '',
          storage: r.storage || '',
          carrier: carrier,
          icloud_lock: r.icloud_lock_on ? 'ON' : 'OFF',
          condition: condition,
          condition_hint: r.condition_hint || '',
          estimated_purchase_date: r.estimated_purchase_date || '',
          quantity: 1,
          unit_price_cents: cents,
          line_total_cents: cents,
          suggested_price_cents: (typeof r.suggested_price_cents !== 'undefined' ? r.suggested_price_cents : ''),
          notes: (noteEl ? noteEl.value : '')
        });
      });
      
      // Manual rows
      state.manual.forEach((r, idx) => {
        const paidEl = document.querySelector(`.mpaid[data-idx="${idx}"]`);
        const noteEl = document.querySelector(`.mnote[data-idx="${idx}"]`);
        const identEl = document.querySelector(`.mident[data-idx="${idx}"]`);
        const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
        const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0; // Convert to cents
        
        payload.push({
          manual: 'yes',
          used: '',
          used_source: '',
          identifier: identEl ? identEl.value.trim() : '',
          manufacturer: '',
          model_name: '',
          model_code: '',
          device: r.device || '',
          color: r.color || '',
          storage: r.storage || '',
          carrier: r.carrier || 'Unknown',
          icloud_lock: '',
          condition: 'B',
          condition_hint: '',
          estimated_purchase_date: '',
          quantity: 1,
          unit_price_cents: cents,
          line_total_cents: cents,
          suggested_price_cents: '',
          notes: noteEl ? noteEl.value : ''
        });
      });
      
      const header = ['manual','used','used_source','identifier','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','condition','condition_hint','estimated_purchase_date','quantity','unit_price_cents','line_total_cents','suggested_price_cents','notes'];
      const lines = [header.join(',')];
      
      payload.forEach(o => {
        const row = header.map(k => {
          const v = (o[k] != null) ? String(o[k]) : '';
          return JSON.stringify(v).replace(/^\uFEFF/, '');
        }).join(',');
        lines.push(row);
      });
      
      const csv = lines.join('\n');
      
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'intake_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Show import modal
    function showImportModal() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to import.');
        return;
      }
      
      document.getElementById('import-modal').classList.add('show');
    }

    // Show import to warehouse modal
    function showImportWarehouseModal() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to import.');
        return;
      }
      
      document.getElementById('import-warehouse-modal').classList.add('show');
    }

    // Import to inventory
    function importToInventory() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      const payload = [];
      
      // Calculate total amount to deduct from cash drawer
      let totalCents = 0;
      
      selectedItems.forEach(checkbox => {
        const idx = checkbox.dataset.idx;
        let isManual = false;
        
        // Check if this is a manual item
        if (idx.startsWith('m')) {
          isManual = true;
          const manualIdx = parseInt(idx.substring(1), 10);
          
          const paidEl = document.querySelector(`.mpaid[data-idx="${manualIdx}"]`);
          const noteEl = document.querySelector(`.mnote[data-idx="${manualIdx}"]`);
          const identEl = document.querySelector(`.mident[data-idx="${manualIdx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          totalCents += cents;
          
          const manualItem = state.manual[manualIdx];
          
          payload.push({
            imei: identEl ? identEl.value.trim() : '',
            device_display: manualItem.device || '',
            color: manualItem.color || '',
            storage: manualItem.storage || '',
            condition: 'B',
            carrier: manualItem.carrier || 'Unknown',
            price_paid_cents: cents,
            notes: noteEl ? noteEl.value : ''
          });
        } else {
          const numIdx = parseInt(idx, 10);
          
          const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
          const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
          const carrierEl = document.querySelector(`.carrier-select[data-idx="${idx}"]`);
          const conditionEl = document.querySelector(`.condition-select[data-idx="${idx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          totalCents += cents;
          
          const carrier = carrierEl ? carrierEl.value : 'Unknown';
          const condition = conditionEl ? conditionEl.value : 'B';
          
          payload.push({
            imei: document.querySelector(`.imei[data-idx="${idx}"]`).value,
            manufacturer: document.querySelector(`.manufacturer[data-idx="${idx}"]`).value,
            model_name: document.querySelector(`.model-name[data-idx="${idx}"]`).value,
            model_code: document.querySelector(`.model-code[data-idx="${idx}"]`).value,
            device_display: document.querySelector(`.device-display[data-idx="${idx}"]`).value,
            color: state.rows[numIdx].color || '',
            storage: state.rows[numIdx].storage || '',
            condition: condition,
            carrier: carrier,
            price_paid_cents: cents,
            suggested_price_cents: document.querySelector(`.suggested-price[data-idx="${idx}"]`).value,
            notes: noteEl ? noteEl.value : '',
            icloud_lock_on: document.querySelector(`.icloud-lock[data-idx="${idx}"]`).value === 'ON'
          });
        }
      });
      
      // Show loader
      showLoader();
      
      // Check if cash drawer is open
      if (!state.cashDrawer || state.cashDrawer.status !== 'open') {
        hideLoader();
        showAlert('error', 'Cash drawer must be open to import items.');
        document.getElementById('import-modal').classList.remove('show');
        return;
      }
      
      // Deduct from cash drawer
      state.cashDrawer.expected_amount_cents -= totalCents;
      
      // Add system log
      addSystemLog('inventory_add', `Added ${payload.length} items to inventory. Total: ${formatMoney(totalCents)}`);
      
      // Simulate import request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('import-modal').classList.remove('show');
        
        // Add to local inventory
        payload.forEach(item => {
          state.inventory.push({
            id: Date.now() + Math.floor(Math.random() * 1000),
            imei: item.imei,
            device_display: item.device_display,
            color: item.color,
            storage: item.storage,
            condition: item.condition,
            carrier: item.carrier,
            price_paid_cents: item.price_paid_cents,
            status: 'in_stock',
            location: 'store',
            created_at: new Date().toISOString(),
            notes: item.notes
          });
        });
        
        showAlert('success', `Imported ${payload.length} items to inventory. Cash drawer balance updated.`);
        
        // Update cash drawer display
        renderCashDrawer();
        
        // If on inventory tab, refresh the view
        if (document.getElementById('inventory-tab').classList.contains('active')) {
          renderInventory();
        }
      }, 1000);
    }

    // Import to warehouse
    function importToWarehouse() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      const payload = [];
      
      selectedItems.forEach(checkbox => {
        const idx = checkbox.dataset.idx;
        let isManual = false;
        
        // Check if this is a manual item
        if (idx.startsWith('m')) {
          isManual = true;
          const manualIdx = parseInt(idx.substring(1), 10);
          
          const paidEl = document.querySelector(`.mpaid[data-idx="${manualIdx}"]`);
          const noteEl = document.querySelector(`.mnote[data-idx="${manualIdx}"]`);
          const identEl = document.querySelector(`.mident[data-idx="${manualIdx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          
          const manualItem = state.manual[manualIdx];
          
          payload.push({
            imei: identEl ? identEl.value.trim() : '',
            device_display: manualItem.device || '',
            color: manualItem.color || '',
            storage: manualItem.storage || '',
            condition: 'B',
            carrier: manualItem.carrier || 'Unknown',
            price_paid_cents: cents,
            notes: noteEl ? noteEl.value : ''
          });
        } else {
          const numIdx = parseInt(idx, 10);
          
          const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
          const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
          const carrierEl = document.querySelector(`.carrier-select[data-idx="${idx}"]`);
          const conditionEl = document.querySelector(`.condition-select[data-idx="${idx}"]`);
          
          const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
          const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0;
          
          const carrier = carrierEl ? carrierEl.value : 'Unknown';
          const condition = conditionEl ? conditionEl.value : 'B';
          
          payload.push({
            imei: document.querySelector(`.imei[data-idx="${idx}"]`).value,
            manufacturer: document.querySelector(`.manufacturer[data-idx="${idx}"]`).value,
            model_name: document.querySelector(`.model-name[data-idx="${idx}"]`).value,
            model_code: document.querySelector(`.model-code[data-idx="${idx}"]`).value,
            device_display: document.querySelector(`.device-display[data-idx="${idx}"]`).value,
            color: state.rows[numIdx].color || '',
            storage: state.rows[numIdx].storage || '',
            condition: condition,
            carrier: carrier,
            price_paid_cents: cents,
            suggested_price_cents: document.querySelector(`.suggested-price[data-idx="${idx}"]`).value,
            notes: noteEl ? noteEl.value : '',
            icloud_lock_on: document.querySelector(`.icloud-lock[data-idx="${idx}"]`).value === 'ON'
          });
        }
      });
      
      // Show loader
      showLoader();
      
      // Add system log
      let totalCents = payload.reduce((sum, item) => sum + item.price_paid_cents, 0);
      addSystemLog('inventory_add', `Added ${payload.length} items directly to warehouse. Total: ${formatMoney(totalCents)}`);
      
      // Simulate import request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('import-warehouse-modal').classList.remove('show');
        
        // Add to local inventory with warehouse location
        payload.forEach(item => {
          state.inventory.push({
            id: Date.now() + Math.floor(Math.random() * 1000),
            imei: item.imei,
            device_display: item.device_display,
            color: item.color,
            storage: item.storage,
            condition: item.condition,
            carrier: item.carrier,
            price_paid_cents: item.price_paid_cents,
            status: 'in_stock',
            location: 'warehouse',
            created_at: new Date().toISOString(),
            notes: item.notes
          });
        });
        
        showAlert('success', `Imported ${payload.length} items directly to warehouse.`);
        
        // If on warehouse tab, refresh the view
        if (document.getElementById('warehouse-tab').classList.contains('active') && state.warehouseUnlocked) {
          renderWarehouse();
        }
      }, 1000);
    }

    // Reset lookup
    function resetLookup() {
      document.getElementById('imeis').value = '';
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('results-body').innerHTML = '';
      state.rows = [];
      state.manual = [];
    }

    // Add manual item
    function addManualItem(e) {
      e.preventDefault();
      const device = document.getElementById('m_device').value.trim();
      const color = document.getElementById('m_color').value.trim();
      const storage = document.getElementById('m_storage').value.trim();
      const carrier = document.getElementById('m_carrier').value || 'Unknown';
      const unitPrice = Number(document.getElementById('m_price').value || '');
      
      if (!device) {
        showAlert('error', 'Please enter a device name.');
        return;
      }
      
      state.manual.push({
        device,
        color,
        storage,
        carrier,
        unitPrice,
        notes: ''
      });
      
      // Clear inputs
      document.getElementById('m_device').value = '';
      document.getElementById('m_color').value = '';
      document.getElementById('m_storage').value = '';
      document.getElementById('m_carrier').value = 'Unknown';
      document.getElementById('m_price').value = '';
      
      // Re-render results
      renderResults();
      
      // Focus device input for next entry
      document.getElementById('m_device').focus();
    }

    // Load inventory
    function loadInventory() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderInventory();
      }, 500);
    }

    // Render inventory
    function renderInventory() {
      const tbody = document.getElementById('inventory-body');
      tbody.innerHTML = '';
      
      // Filter inventory based on current filters
      const filtered = state.inventory.filter(item => {
        // Status filter
        if (state.filters.status !== 'all' && item.status !== state.filters.status) {
          return false;
        }
        
        // Location filter
        if (state.filters.location !== 'all' && item.location !== state.filters.location) {
          return false;
        }
        
        // Search filter
        if (state.filters.search) {
          const search = state.filters.search.toLowerCase();
          return (
            (item.imei && item.imei.toLowerCase().includes(search)) ||
            (item.device_display && item.device_display.toLowerCase().includes(search))
          );
        }
        
        return true;
      });
      
      // Pagination
      const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const paginatedItems = filtered.slice(start, end);
      
      // Render items
      paginatedItems.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="inventory-select-item" value="${item.id}">
          </td>
          <td><code>${escapeHtml(item.imei || '')}</code></td>
          <td>${escapeHtml(item.device_display || '')}</td>
          <td><span class="tag">${escapeHtml(item.condition || 'B')}</span></td>
          <td><span class="tag">${escapeHtml(item.carrier || 'Unknown')}</span></td>
          <td class="right">${formatMoney(item.price_paid_cents || 0)}</td>
          <td>
            <span class="tag ${item.status === 'in_stock' ? 'success' : item.status === 'sold' ? 'info' : 'warning'}">
              ${item.status === 'in_stock' ? 'In Stock' : item.status === 'sold' ? 'Sold' : 'Transferred'}
            </span>
          </td>
          <td>
            <span class="tag ${item.location === 'store' ? 'info' : 'warning'}">
              ${item.location === 'store' ? 'Store' : 'Warehouse'}
            </span>
          </td>
          <td>${formatShortDate(item.created_at)}</td>
          <td>
            <button class="btn btn-secondary edit-item" data-id="${item.id}">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Pagination controls
      const pagination = document.getElementById('inventory-pagination');
      pagination.innerHTML = '';
      
      if (totalPages > 1) {
        const prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.innerHTML = '&laquo; Prev';
        if (state.currentPage === 1) {
          prevLink.classList.add('disabled');
        }
        
        prevLink.onclick = (e) => {
          e.preventDefault();
          if (state.currentPage > 1) {
            state.currentPage--;
            renderInventory();
          }
        };
        
        pagination.appendChild(prevLink);
        
        for (let i = 1; i <= totalPages; i++) {
          const pageLink = document.createElement('a');
          pageLink.href = '#';
          pageLink.innerText = i;
          if (i === state.currentPage) {
            pageLink.classList.add('active');
          }
          
          pageLink.onclick = (e) => {
            e.preventDefault();
            state.currentPage = i;
            renderInventory();
          };
          
          pagination.appendChild(pageLink);
        }
        
        const nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.innerHTML = 'Next &raquo;';
        if (state.currentPage === totalPages) {
          nextLink.classList.add('disabled');
        }
        
        nextLink.onclick = (e) => {
          e.preventDefault();
          if (end < filtered.length) {
            state.currentPage++;
            renderInventory();
          }
        };
        
        pagination.appendChild(nextLink);
      }
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('inventory-select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.inventory-select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
      
      // Edit buttons
      document.querySelectorAll('.edit-item').forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-id');
          showEditItemModal(itemId);
        });
      });
    }

    // Show edit item modal
    function showEditItemModal(itemId) {
      const item = state.inventory.find(i => i.id == itemId);
      if (!item) return;
      
      document.getElementById('edit-item-id').value = item.id;
      document.getElementById('edit-device').value = item.device_display || '';
      document.getElementById('edit-color').value = item.color || '';
      document.getElementById('edit-storage').value = item.storage || '';
      document.getElementById('edit-carrier').value = item.carrier || 'Unknown';
      document.getElementById('edit-condition').value = item.condition || 'B';
      document.getElementById('edit-price').value = item.price_paid_cents ? (item.price_paid_cents / 100).toFixed(2) : '';
      document.getElementById('edit-notes').value = item.notes || '';
      
      document.getElementById('edit-item-modal').classList.add('show');
    }

    // Save edited item
    function saveEditedItem() {
      const itemId = document.getElementById('edit-item-id').value;
      const item = state.inventory.find(i => i.id == itemId);
      if (!item) return;
      
      const oldValues = { ...item };
      
      // Update item
      item.device_display = document.getElementById('edit-device').value;
      item.color = document.getElementById('edit-color').value;
      item.storage = document.getElementById('edit-storage').value;
      item.carrier = document.getElementById('edit-carrier').value;
      item.condition = document.getElementById('edit-condition').value;
      
      const pricePaid = Number(document.getElementById('edit-price').value);
      item.price_paid_cents = isFinite(pricePaid) ? Math.round(pricePaid * 100) : 0;
      
      item.notes = document.getElementById('edit-notes').value;
      
      // Add system log
      addSystemLog('inventory_edit', `Edited item ${item.imei}: ${oldValues.device_display} → ${item.device_display}`);
      
      document.getElementById('edit-item-modal').classList.remove('show');
      showAlert('success', 'Item updated successfully.');
      
      // Re-render inventory
      renderInventory();
    }

    // Show transfer modal
    function showTransferModal() {
      const selectedItems = document.querySelectorAll('.inventory-select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to transfer.');
        return;
      }
      
      document.getElementById('transfer-modal').classList.add('show');
    }

    // Transfer to warehouse
    function transferToWarehouse() {
      const selectedItems = document.querySelectorAll('.inventory-select-item:checked');
      const itemIds = Array.from(selectedItems).map(checkbox => checkbox.value);
      const notes = document.getElementById('transfer-notes-input').value;
      
      document.getElementById('transfer-notes').value = notes;
      
      // Show loader
      showLoader();
      
      // Add system log
      addSystemLog('transfer', `Transferred ${itemIds.length} items to warehouse. Notes: ${notes}`);
      
      // Simulate transfer request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('transfer-modal').classList.remove('show');
        
        // Update items in local state
        itemIds.forEach(id => {
          const item = state.inventory.find(i => i.id == id);
          if (item) {
            item.location = 'warehouse';
            item.status = 'transferred';
          }
        });
        
        showAlert('success', `Transferred ${itemIds.length} items to warehouse.`);
        
        // Re-render inventory
        renderInventory();
      }, 1000);
    }

    // Load cash drawer
    function loadCashDrawer() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderCashDrawer();
      }, 500);
    }

    // Render cash drawer
    function renderCashDrawer() {
      const container = document.getElementById('cash-drawer-content');
      
      if (!state.cashDrawer) {
        // No cash drawer open
        container.innerHTML = `
          <div style="text-align: center; padding: 50px 20px;">
            <i class="fas fa-cash-register" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
            <h3>No Cash Drawer Open</h3>
            <p class="muted">Open a cash drawer to start tracking transactions</p>
          </div>
        `;
        
        document.getElementById('open-drawer-btn').style.display = 'block';
        document.getElementById('add-transaction-btn').disabled = true;
        return;
      }
      
      // Cash drawer is open
      document.getElementById('open-drawer-btn').style.display = 'none';
      document.getElementById('add-transaction-btn').disabled = false;
      
      // Calculate total transactions
      const deposits = state.transactions
        .filter(t => t.type === 'deposit')
        .reduce((sum, t) => sum + t.amount_cents, 0);
      
      const withdrawals = state.transactions
        .filter(t => t.type === 'withdrawal')
        .reduce((sum, t) => sum + t.amount_cents, 0);
      
      const netTransactions = deposits - withdrawals;
      
      // Current balance
      const currentBalance = state.cashDrawer.opening_amount_cents + netTransactions;
      
      // Difference from expected
      const difference = currentBalance - state.cashDrawer.expected_amount_cents;
      
      container.innerHTML = `
        <div class="cash-drawer-summary">
          <div class="cash-stat">
            <div class="cash-stat-label">Opening Balance</div>
            <div class="cash-stat-value">${formatMoney(state.cashDrawer.opening_amount_cents)}</div>
          </div>
          <div class="cash-stat">
            <div class="cash-stat-label">Expected Balance</div>
            <div class="cash-stat-value">${formatMoney(state.cashDrawer.expected_amount_cents)}</div>
          </div>
          <div class="cash-stat">
            <div class="cash-stat-label">Current Balance</div>
            <div class="cash-stat-value">${formatMoney(currentBalance)}</div>
          </div>
          <div class="cash-stat">
            <div class="cash-stat-label">Difference</div>
            <div class="cash-stat-value ${difference !== 0 ? 'error' : ''}">${formatMoney(difference)}</div>
          </div>
        </div>
        
        <div class="form-group">
          <div class="muted">
            <i class="fas fa-info-circle"></i> 
            Cash drawer opened on ${formatDate(state.cashDrawer.opened_at)}
            ${state.cashDrawer.notes ? `<br>Notes: ${escapeHtml(state.cashDrawer.notes)}` : ''}
          </div>
        </div>
      `;
      
      // Render transactions
      renderTransactions();
    }

    // Render transactions
    function renderTransactions() {
      const tbody = document.getElementById('transactions-body');
      tbody.innerHTML = '';
      
      if (!state.transactions.length) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="4" class="center">No transactions yet</td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      // Sort transactions by date (newest first)
      const sortedTransactions = [...state.transactions].sort((a, b) => {
        return new Date(b.created_at) - new Date(a.created_at);
      });
      
      sortedTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${formatDate(transaction.created_at)}</td>
          <td>
            <span class="tag ${transaction.type === 'deposit' ? 'success' : 'warning'}">
              ${transaction.type === 'deposit' ? 'Deposit' : 'Withdrawal'}
            </span>
          </td>
          <td class="right">${formatMoney(transaction.amount_cents)}</td>
          <td>${escapeHtml(transaction.description || '')}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Open cash drawer
    function openCashDrawer() {
      const amount = document.getElementById('opening-amount').value;
      const notes = document.getElementById('open-drawer-notes').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid opening amount.');
        return;
      }
      
      // Convert dollars to cents
      const amountCents = Math.round(parseFloat(amount) * 100);
      
      // Show loader
      showLoader();
      
      // Simulate open drawer request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('open-drawer-modal').classList.remove('show');
        
        // Create cash drawer
        state.cashDrawer = {
          id: Date.now(),
          opening_amount_cents: amountCents,
          expected_amount_cents: amountCents,
          status: 'open',
          opened_at: new Date().toISOString(),
          notes: notes
        };
        
        // Add system log
        addSystemLog('cash_drawer', `Opened cash drawer with ${formatMoney(amountCents)}`);
        
        showAlert('success', 'Cash drawer successfully opened.');
        renderCashDrawer();
      }, 1000);
    }

    // Add transaction
    function addTransaction() {
      const type = document.getElementById('transaction-type').value;
      const amount = document.getElementById('transaction-amount').value;
      const description = document.getElementById('transaction-description').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid amount.');
        return;
      }
      
      // Convert dollars to cents
      const amountCents = Math.round(parseFloat(amount) * 100);
      
      // Show loader
      showLoader();
      
      // Simulate transaction request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('add-transaction-modal').classList.remove('show');
        
        // Create transaction
        const transaction = {
          id: Date.now(),
          type: type,
          amount_cents: amountCents,
          description: description,
          created_at: new Date().toISOString()
        };
        
        state.transactions.push(transaction);
        
        // Update expected amount in cash drawer
        if (type === 'deposit') {
          state.cashDrawer.expected_amount_cents += amountCents;
        } else {
          state.cashDrawer.expected_amount_cents -= amountCents;
        }
        
        // Add system log
        addSystemLog('transaction', `${type === 'deposit' ? 'Added' : 'Removed'} ${formatMoney(amountCents)} from cash drawer. Description: ${description}`);
        
        showAlert('success', 'Transaction added successfully.');
        renderCashDrawer();
      }, 1000);
    }

    // Unlock warehouse
    function unlockWarehouse() {
      const passcode = document.getElementById('warehouse-passcode').value;
      
      if (passcode !== '2468') {
        showAlert('error', 'Invalid warehouse passcode.');
        return;
      }
      
      state.warehouseUnlocked = true;
      document.getElementById('warehouse-locked').style.display = 'none';
      document.getElementById('warehouse-content').style.display = 'block';
      
      // Add system log
      addSystemLog('access', 'Warehouse access granted');
      
      // Load warehouse data
      loadWarehouse();
    }

    // Load warehouse
    function loadWarehouse() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderWarehouse();
      }, 500);
    }

    // Render warehouse
    function renderWarehouse() {
      const tbody = document.getElementById('warehouse-body');
      tbody.innerHTML = '';
      
      // Filter inventory based on current filters
      const filtered = state.inventory.filter(item => {
        // Only show warehouse items
        if (item.location !== 'warehouse') {
          return false;
        }
        
        // Status filter
        if (state.warehouseFilters.status !== 'all' && item.status !== state.warehouseFilters.status) {
          return false;
        }
        
        // Search filter
        if (state.warehouseFilters.search) {
          const search = state.warehouseFilters.search.toLowerCase();
          return (
            (item.imei && item.imei.toLowerCase().includes(search)) ||
            (item.device_display && item.device_display.toLowerCase().includes(search))
          );
        }
        
        return true;
      });
      
      // Pagination
      const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const paginatedItems = filtered.slice(start, end);
      
      // Render items
      paginatedItems.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="warehouse-select-item" value="${item.id}">
          </td>
          <td><code>${escapeHtml(item.imei || '')}</code></td>
          <td>${escapeHtml(item.device_display || '')}</td>
          <td><span class="tag">${escapeHtml(item.condition || 'B')}</span></td>
          <td><span class="tag">${escapeHtml(item.carrier || 'Unknown')}</span></td>
          <td class="right">${formatMoney(item.price_paid_cents || 0)}</td>
          <td>
            <span class="tag ${item.status === 'in_stock' ? 'success' : item.status === 'sold' ? 'info' : 'warning'}">
              ${item.status === 'in_stock' ? 'In Stock' : item.status === 'sold' ? 'Sold' : 'Transferred'}
            </span>
          </td>
          <td>${formatShortDate(item.created_at)}</td>
          <td>
            <button class="btn btn-secondary edit-warehouse-item" data-id="${item.id}">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Pagination controls
      const pagination = document.getElementById('warehouse-pagination');
      pagination.innerHTML = '';
      
      if (totalPages > 1) {
        const prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.innerHTML = '&laquo; Prev';
        if (state.currentPage === 1) {
          prevLink.classList.add('disabled');
        }
        
        prevLink.onclick = (e) => {
          e.preventDefault();
          if (state.currentPage > 1) {
            state.currentPage--;
            renderWarehouse();
          }
        };
        
        pagination.appendChild(prevLink);
        
        for (let i = 1; i <= totalPages; i++) {
          const pageLink = document.createElement('a');
          pageLink.href = '#';
          pageLink.innerText = i;
          if (i === state.currentPage) {
            pageLink.classList.add('active');
          }
          
          pageLink.onclick = (e) => {
            e.preventDefault();
            state.currentPage = i;
            renderWarehouse();
          };
          
          pagination.appendChild(pageLink);
        }
        
        const nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.innerHTML = 'Next &raquo;';
        if (state.currentPage === totalPages) {
          nextLink.classList.add('disabled');
        }
        
        nextLink.onclick = (e) => {
          e.preventDefault();
          if (end < filtered.length) {
            state.currentPage++;
            renderWarehouse();
          }
        };
        
        pagination.appendChild(nextLink);
      }
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('warehouse-select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.warehouse-select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
      
      // Edit buttons
      document.querySelectorAll('.edit-warehouse-item').forEach(button => {
        button.addEventListener('click', function() {
          const itemId = this.getAttribute('data-id');
          showEditItemModal(itemId);
        });
      });
    }

    // Add device to warehouse
    function addDeviceToWarehouse() {
      const device = document.getElementById('w_device').value.trim();
      const color = document.getElementById('w_color').value.trim();
      const storage = document.getElementById('w_storage').value.trim();
      const imei = document.getElementById('w_imei').value.trim();
      const carrier = document.getElementById('w_carrier').value;
      const condition = document.getElementById('w_condition').value;
      const price = document.getElementById('w_price').value;
      const notes = document.getElementById('w_notes').value;
      
      if (!device) {
        showAlert('error', 'Please enter a device name.');
        return;
      }
      
      if (!imei) {
        showAlert('error', 'Please enter an IMEI or serial number.');
        return;
      }
      
      // Convert dollars to cents
      const priceCents = price ? Math.round(parseFloat(price) * 100) : 0;
      
      // Show loader
      showLoader();
      
      // Add system log
      addSystemLog('inventory_add', `Added ${device} directly to warehouse. Price: ${formatMoney(priceCents)}`);
      
      // Simulate add request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        
        // Add to local inventory
        state.inventory.push({
          id: Date.now() + Math.floor(Math.random() * 1000),
          imei: imei,
          device_display: device,
          color: color,
          storage: storage,
          condition: condition,
          carrier: carrier,
          price_paid_cents: priceCents,
          status: 'in_stock',
          location: 'warehouse',
          created_at: new Date().toISOString(),
          notes: notes
        });
        
        showAlert('success', 'Device added to warehouse successfully.');
        
        // Clear form
        document.getElementById('w_device').value = '';
        document.getElementById('w_color').value = '';
        document.getElementById('w_storage').value = '';
        document.getElementById('w_imei').value = '';
        document.getElementById('w_carrier').value = 'Unknown';
        document.getElementById('w_condition').value = 'B';
        document.getElementById('w_price').value = '';
        document.getElementById('w_notes').value = '';
        
        // Re-render warehouse
        renderWarehouse();
      }, 1000);
    }

    // Unlock admin panel
    function unlockAdmin() {
      const passcode = document.getElementById('admin-passcode').value;
      
      if (passcode !== '1337') {
        showAlert('error', 'Invalid admin passcode.');
        return;
      }
      
      state.adminUnlocked = true;
      document.getElementById('admin-locked').style.display = 'none';
      document.getElementById('admin-content').style.display = 'block';
      
      // Add system log
      addSystemLog('access', 'Admin access granted');
      
      // Load admin data
      renderSystemLogs();
    }

    // Render system logs
    function renderSystemLogs() {
      const logsContainer = document.getElementById('system-logs');
      logsContainer.innerHTML = '';
      
      const logFilter = document.getElementById('log-filter').value;
      
      // Filter logs
      const filteredLogs = logFilter === 'all' ? 
        state.logs : 
        state.logs.filter(log => log.action.includes(logFilter));
      
      if (!filteredLogs.length) {
        logsContainer.innerHTML = '<div class="log-entry">No logs found.</div>';
        return;
      }
      
      filteredLogs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        let actionText = '';
        switch(log.action) {
          case 'inventory_add':
            actionText = 'Inventory Added';
            break;
          case 'inventory_edit':
            actionText = 'Inventory Edited';
            break;
          case 'inventory_delete':
            actionText = 'Inventory Deleted';
            break;
          case 'transfer':
            actionText = 'Transfer';
            break;
          case 'cash_drawer':
            actionText = 'Cash Drawer';
            break;
          case 'transaction':
            actionText = 'Transaction';
            break;
          case 'access':
            actionText = 'Access';
            break;
          default:
            actionText = log.action;
        }
        
        logEntry.innerHTML = `
          <div class="log-timestamp">${formatDate(log.timestamp)}</div>
          <div class="log-action">${actionText}</div>
          <div class="log-details">${escapeHtml(log.details)}</div>
        `;
        
        logsContainer.appendChild(logEntry);
      });
    }

    // Save admin settings
    function saveAdminSettings() {
      const conditionAgeDays = parseInt(document.getElementById('condition-age-setting').value);
      
      if (isNaN(conditionAgeDays) || conditionAgeDays < 1) {
        showAlert('error', 'Please enter a valid number of days.');
        return;
      }
      
      state.settings.conditionAgeDays = conditionAgeDays;
      
      // Add system log
      addSystemLog('settings', `Updated condition age setting to ${conditionAgeDays} days`);
      
      showAlert('success', 'Settings saved successfully.');
    }

    // Setup device typeahead
    function setupDeviceTypeahead() {
      const deviceInput = document.getElementById('m_device');
      const deviceResults = document.getElementById('device-results');
      
      // Sample device list (in a real app, this would come from the server)
      const devices = [
        'iPhone 13 Pro Max',
        'iPhone 13 Pro',
        'iPhone 13',
        'iPhone 13 Mini',
        'iPhone 12 Pro Max',
        'iPhone 12 Pro',
        'iPhone 12',
        'iPhone 12 Mini',
        'iPhone SE (2nd gen)',
        'iPhone 11 Pro Max',
        'iPhone 11 Pro',
        'iPhone 11',
        'Samsung Galaxy S21 Ultra',
        'Samsung Galaxy S21+',
        'Samsung Galaxy S21',
        'Samsung Galaxy Note 20 Ultra',
        'Samsung Galaxy Note 20',
        'Google Pixel 6 Pro',
        'Google Pixel 6',
        'Google Pixel 5',
        'OnePlus 9 Pro',
        'OnePlus 9'
      ];
      
      deviceInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        
        if (!value) {
          deviceResults.classList.remove('show');
          return;
        }
        
        const filtered = devices.filter(device => 
          device.toLowerCase().includes(value)
        );
        
        if (filtered.length) {
          deviceResults.innerHTML = '';
          filtered.forEach(device => {
            const item = document.createElement('div');
            item.className = 'typeahead-item';
            item.innerText = device;
            item.addEventListener('click', function() {
              deviceInput.value = device;
              deviceResults.classList.remove('show');
            });
            deviceResults.appendChild(item);
          });
          deviceResults.classList.add('show');
        } else {
          deviceResults.classList.remove('show');
        }
      });
      
      deviceInput.addEventListener('focus', function() {
        if (this.value && deviceResults.children.length) {
          deviceResults.classList.add('show');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (e.target !== deviceInput && e.target !== deviceResults) {
          deviceResults.classList.remove('show');
        }
      });
    }

    // Setup color typeahead
    function setupColorTypeahead() {
      const colorInput = document.getElementById('m_color');
      const colorResults = document.getElementById('color-results');
      
      // Sample color list (in a real app, this would come from the server)
      const colors = [
        'Black',
        'White',
        'Silver',
        'Gold',
        'Rose Gold',
        'Space Gray',
        'Midnight Green',
        'Pacific Blue',
        'Graphite',
        'Sierra Blue',
        'Alpine Green',
        'Midnight',
        'Starlight',
        'Product RED',
        'Purple',
        'Yellow',
        'Green',
        'Blue',
        'Coral',
        'Pink'
      ];
      
      colorInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        
        if (!value) {
          colorResults.classList.remove('show');
          return;
        }
        
        const filtered = colors.filter(color => 
          color.toLowerCase().includes(value)
        );
        
        if (filtered.length) {
          colorResults.innerHTML = '';
          filtered.forEach(color => {
            const item = document.createElement('div');
            item.className = 'typeahead-item';
            item.innerText = color;
            item.addEventListener('click', function() {
              colorInput.value = color;
              colorResults.classList.remove('show');
            });
            colorResults.appendChild(item);
          });
          colorResults.classList.add('show');
        } else {
          colorResults.classList.remove('show');
        }
      });
      
      colorInput.addEventListener('focus', function() {
        if (this.value && colorResults.children.length) {
          colorResults.classList.add('show');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (e.target !== colorInput && e.target !== colorResults) {
          colorResults.classList.remove('show');
        }
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Refresh balance button
      document.getElementById('refresh-balance').addEventListener('click', checkBalance);
      
      // IMEI lookup
      document.getElementById('lookup-btn').addEventListener('click', lookupIMEIs);
      
      // Reset button
      document.getElementById('reset-btn').addEventListener('click', resetLookup);
      
      // Add manual item
      document.getElementById('addManual').addEventListener('click', addManualItem);
      
      // Import to inventory button
      document.getElementById('import-to-inventory-btn').addEventListener('click', showImportModal);
      
      // Import to warehouse button
      document.getElementById('import-to-warehouse-btn').addEventListener('click', showImportWarehouseModal);
      
      // Import modal close
      document.getElementById('import-modal-close').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('show');
      });
      
      document.getElementById('import-modal-cancel').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('show');
      });
      
      // Import confirm
      document.getElementById('import-confirm').addEventListener('click', importToInventory);
      
      // Import to warehouse modal close
      document.getElementById('import-warehouse-modal-close').addEventListener('click', () => {
        document.getElementById('import-warehouse-modal').classList.remove('show');
      });
      
      document.getElementById('import-warehouse-modal-cancel').addEventListener('click', () => {
        document.getElementById('import-warehouse-modal').classList.remove('show');
      });
      
      // Import to warehouse confirm
      document.getElementById('import-warehouse-confirm').addEventListener('click', importToWarehouse);
      
      // Transfer to warehouse button
      document.getElementById('transfer-to-warehouse-btn').addEventListener('click', showTransferModal);
      
      // Transfer modal close
      document.getElementById('transfer-modal-close').addEventListener('click', () => {
        document.getElementById('transfer-modal').classList.remove('show');
      });
      
      document.getElementById('transfer-modal-cancel').addEventListener('click', () => {
        document.getElementById('transfer-modal').classList.remove('show');
      });
      
      // Transfer confirm
      document.getElementById('transfer-confirm').addEventListener('click', transferToWarehouse);
      
      // Inventory search
      document.getElementById('inventory-search-btn').addEventListener('click', () => {
        state.filters.search = document.getElementById('inventory-search').value;
        loadInventory();
      });
      
      // Status filter
      document.getElementById('status-filter').addEventListener('change', () => {
        state.filters.status = document.getElementById('status-filter').value;
        loadInventory();
      });
      
      // Location filter
      document.getElementById('location-filter').addEventListener('change', () => {
        state.filters.location = document.getElementById('location-filter').value;
        loadInventory();
      });
      
      // Open cash drawer button
      document.getElementById('open-drawer-btn').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.add('show');
      });
      
      // Open drawer modal close
      document.getElementById('open-drawer-modal-close').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.remove('show');
      });
      
      document.getElementById('open-drawer-modal-cancel').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.remove('show');
      });
      
      // Open drawer form
      document.getElementById('open-drawer-form').addEventListener('submit', (e) => {
        e.preventDefault();
        openCashDrawer();
      });
      
      // Add transaction button
      document.getElementById('add-transaction-btn').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.add('show');
      });
      
      // Add transaction modal close
      document.getElementById('add-transaction-modal-close').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.remove('show');
      });
      
      document.getElementById('add-transaction-modal-cancel').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.remove('show');
      });
      
      // Add transaction form
      document.getElementById('add-transaction-confirm').addEventListener('click', addTransaction);
      
      // Edit item modal close
      document.getElementById('edit-item-modal-close').addEventListener('click', () => {
        document.getElementById('edit-item-modal').classList.remove('show');
      });
      
      document.getElementById('edit-item-modal-cancel').addEventListener('click', () => {
        document.getElementById('edit-item-modal').classList.remove('show');
      });
      
      // Edit item confirm
      document.getElementById('edit-item-confirm').addEventListener('click', saveEditedItem);
      
      // Warehouse unlock button
      document.getElementById('warehouse-unlock-btn').addEventListener('click', unlockWarehouse);
      
      // Warehouse search
      document.getElementById('warehouse-search-btn').addEventListener('click', () => {
        state.warehouseFilters.search = document.getElementById('warehouse-search').value;
        loadWarehouse();
      });
      
      // Warehouse status filter
      document.getElementById('warehouse-status-filter').addEventListener('change', () => {
        state.warehouseFilters.status = document.getElementById('warehouse-status-filter').value;
        loadWarehouse();
      });
      
      // Add warehouse device button
      document.getElementById('add-warehouse-device-btn').addEventListener('click', addDeviceToWarehouse);
      
      // Admin unlock button
      document.getElementById('admin-unlock-btn').addEventListener('click', unlockAdmin);
      
      // Filter logs button
      document.getElementById('filter-logs-btn').addEventListener('click', renderSystemLogs);
      
      // Save settings button
      document.getElementById('save-settings-btn').addEventListener('click', saveAdminSettings);
      
      // Tab switching
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
          
          // Load tab-specific data
          if (tabId === 'inventory') {
            loadInventory();
          } else if (tabId === 'cash-drawer') {
            loadCashDrawer();
          } else if (tabId === 'warehouse' && state.warehouseUnlocked) {
            loadWarehouse();
          }
        });
      });
    }

    // Check API balance
    function checkBalance() {
      fetch('/api/balance')
        .then(response => response.json())
        .then(data => {
          const balanceValue = document.getElementById('balance-value');
          if (data.balance) {
            balanceValue.textContent = '$' + data.balance;
          } else {
            balanceValue.textContent = 'Error';
            balanceValue.classList.add('error');
          }
        })
        .catch(error => {
          const balanceValue = document.getElementById('balance-value');
          balanceValue.textContent = 'Error';
          balanceValue.classList.add('error');
          console.error('Error checking balance:', error);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Setup device typeahead
      setupDeviceTypeahead();
      
      // Setup color typeahead
      setupColorTypeahead();
      
      // Setup event listeners
      setupEventListeners();
      
      // Check API balance
      checkBalance();
    });
  </script>
</body>
</html>