<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Inventory Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #00e29b;
      --primary-dark: #00b37a;
      --secondary: #18344a;
      --secondary-light: #1f4060;
      --background: #0b0f14;
      --card-bg: #0f141a;
      --input-bg: #0d1218;
      --border: #213244;
      --text: #e6f1ff;
      --text-muted: #a0b8d0;
      --success: #48ffb3;
      --error: #ff7782;
      --warning: #ffbe0b;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; 
      background: var(--background); 
      color: var(--text); 
      margin: 0;
      line-height: 1.5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .balance-display {
      background: var(--secondary);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .balance-display i {
      color: var(--primary);
    }
    
    .tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 20px;
      background: var(--secondary);
      border-radius: 10px;
      padding: 5px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      flex: 1;
      transition: all 0.2s ease;
      color: var(--text-muted);
    }
    
    .tab.active {
      background: var(--card-bg);
      color: var(--text);
    }
    
    .tab:hover:not(.active) {
      background: var(--secondary-light);
      color: var(--text);
    }
    
    .tab i {
      margin-right: 8px;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    textarea, input[type="text"], input[type="number"], input[type="password"], select {
      width: 100%;
      padding: 12px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }
    
    textarea {
      min-height: 140px;
      resize: vertical;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .btn {
      background: var(--primary);
      color: #062612;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      background: var(--primary-dark);
    }
    
    .btn.secondary {
      background: var(--secondary);
      color: var(--text);
    }
    
    .btn.secondary:hover {
      background: var(--secondary-light);
    }
    
    .btn.danger {
      background: var(--error);
      color: #fff;
    }
    
    .btn.sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .col {
      flex: 1;
      min-width: 200px;
    }
    
    .muted {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    
    th {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
    }
    
    tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }
    
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--secondary);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
    }
    
    .tag.success {
      background: rgba(72, 255, 179, 0.15);
      color: var(--success);
    }
    
    .tag.error {
      background: rgba(255, 119, 130, 0.15);
      color: var(--error);
    }
    
    .tag.warning {
      background: rgba(255, 190, 11, 0.15);
      color: var(--warning);
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert.success {
      background: rgba(72, 255, 179, 0.1);
      border: 1px solid rgba(72, 255, 179, 0.2);
      color: var(--success);
    }
    
    .alert.error {
      background: rgba(255, 119, 130, 0.1);
      border: 1px solid rgba(255, 119, 130, 0.2);
      color: var(--error);
    }
    
    .alert.warning {
      background: rgba(255, 190, 11, 0.1);
      border: 1px solid rgba(255, 190, 11, 0.2);
      color: var(--warning);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 20px;
    }
    
    .pagination a {
      padding: 8px 12px;
      background: var(--secondary);
      color: var(--text);
      border-radius: 6px;
      text-decoration: none;
    }
    
    .pagination a.active {
      background: var(--primary);
      color: #062612;
    }
    
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-bar input {
      flex: 1;
    }
    
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-item label {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .filter-item select {
      width: auto;
      padding: 8px 12px;
    }
    
    .cash-drawer-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .cash-stat {
      background: var(--secondary);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .cash-stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-top: 5px;
    }
    
    .cash-stat-label {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .transaction-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .transaction-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .transaction-info {
      display: flex;
      flex-direction: column;
    }
    
    .transaction-amount {
      font-weight: 600;
      font-size: 16px;
    }
    
    .transaction-amount.positive {
      color: var(--success);
    }
    
    .transaction-amount.negative {
      color: var(--error);
    }
    
    .transaction-meta {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .loader {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loader.show {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 20px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }
    
    /* Hide the 'Matched (Sheet)' column by default */
    th:nth-child(6), td:nth-child(6) { display: none; }
    
    /* typeahead */
    .typeahead { position: relative; flex: 2 1 260px; }
    .suggestions {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #0d1218; border: 1px solid #213244; border-radius: 10px;
      margin-top: 6px; max-height: 320px; overflow-y: auto; z-index: 50;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .sug-item { padding: 10px; cursor: pointer; display:flex; align-items: center; justify-content: space-between; gap: 10px; }
    .sug-item:hover, .sug-item.active { background: #13202d; }
    .sug-left { display:flex; flex-direction: column; }
    .sug-device { font-weight: 600; color:#dff3ff; }
    .sug-sheet { font-size: 12px; color:#9ac7ff; opacity:.8; }
    .sug-price { font-weight: 700; }
    
    /* Tab content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Enhanced Inventory Management</h1>
      <div class="header-right">
        <div class="balance-display">
          <i class="fas fa-wallet"></i>
          <span id="balance-display">API Balance: <span class="tag" id="balance-value">Loading...</span></span>
        </div>
        <button class="btn secondary" id="refresh-balance">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>
    
    <div class="tabs">
      <a href="#lookup" class="tab active" data-tab="lookup">
        <i class="fas fa-search"></i> Lookup
      </a>
      <a href="#inventory" class="tab" data-tab="inventory">
        <i class="fas fa-boxes"></i> Inventory
      </a>
      <a href="#cash-drawer" class="tab" data-tab="cash-drawer">
        <i class="fas fa-cash-register"></i> Cash Drawer
      </a>
      <a href="#warehouse" class="tab" data-tab="warehouse">
        <i class="fas fa-warehouse"></i> Warehouse
      </a>
    </div>
    
    <div id="alerts-container">
      <!-- Alerts will be dynamically inserted here -->
    </div>
    
    <!-- IMEI Lookup Tab -->
    <div id="lookup-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>Bulk IMEI Lookup</h2>
        </div>
        
        <div class="form-group">
          <label><b>Enter IMEIs (one per line, comma or space separated):</b></label>
          <textarea id="imeis" placeholder="354442067957452&#10;353052118765432&#10;..."></textarea>
        </div>
        
        <div class="row">
          <button class="btn" id="lookup-btn">
            <i class="fas fa-search"></i> Lookup & Price
          </button>
          <button class="btn secondary" id="reset-btn">
            <i class="fas fa-redo"></i> Reset
          </button>
          <p class="muted">We'll fetch details from Sickw and suggest a price by matching the device name to the site's CSV.</p>
        </div>
      </div>
      
      <div id="results-container" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2>Results</h2>
            <button class="btn" id="import-to-inventory-btn">
              <i class="fas fa-file-import"></i> Import to Inventory
            </button>
          </div>
          
          <div class="table-responsive">
            <table id="results-table">
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="select-all">
                  </th>
                  <th>IMEI</th>
                  <th>Device</th>
                  <th>Color</th>
                  <th>Storage</th>
                  <th>Carrier</th>
                  <th>Base (¢)</th>
                  <th>Suggested (¢)</th>
                  <th>Confidence</th>
                  <th>Condition</th>
                  <th>Price Paid (¢)</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="results-body">
                <!-- Results will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Manual Item Entry -->
      <div class="card">
        <div class="card-header">
          <h2>Add Manual Item</h2>
        </div>
        
        <div class="row">
          <div class="typeahead" style="flex: 3 1 320px;">
            <input type="text" id="m_device" placeholder="Start typing (e.g., AirPods Pro 2, iPhone 13 Mini 128GB)" autocomplete="off" />
            <div id="m_suggest" class="suggestions" style="display:none;"></div>
          </div>

          <!-- Color dynamic search -->
          <div class="typeahead" style="flex: 2 1 220px;">
            <input type="text" id="m_color" placeholder="Color (type to search)" autocomplete="off" />
            <div id="m_color_suggest" class="suggestions" style="display:none;"></div>
          </div>

          <!-- Storage dropdown (narrow) -->
          <select id="m_storage" style="width: 120px;">
            <option value="">Storage</option>
            <option>64GB</option>
            <option>128GB</option>
            <option>256GB</option>
            <option>512GB</option>
            <option>1TB</option>
            <option>2TB</option>
          </select>

          <select id="m_carrier">
            <option value="Unknown">Carrier</option>
            <option>Unlocked</option><option>Verizon</option><option>T-Mobile</option><option>AT&T</option>
            <option>Xfinity</option><option>Spectrum</option><option>US Cellular</option><option>Cricket</option>
          </select>
          <input type="number" id="m_qty" placeholder="Qty" min="1" step="1" value="1" style="width:90px" />
          <input type="number" id="m_price" placeholder="Unit Price ($)" min="0" step="1" style="width:140px" />
          <button class="btn" id="addManual">Add</button>
        </div>
      </div>
      
      <div id="out"></div>
      <div class="totals" id="totals"></div>
    </div>
    
    <!-- Inventory Tab -->
    <div id="inventory-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Inventory Management</h2>
          <button class="btn" id="transfer-to-warehouse-btn">
            <i class="fas fa-truck-loading"></i> Transfer to Warehouse
          </button>
        </div>
        
        <div class="search-bar">
          <div style="display: flex; gap: 10px; width: 100%;">
            <input type="text" id="inventory-search" placeholder="Search by IMEI, device name...">
            <button type="button" class="btn" id="inventory-search-btn">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>
        
        <div class="filters">
          <div class="filter-item">
            <label>Status:</label>
            <select id="status-filter">
              <option value="in_stock" selected>In Stock</option>
              <option value="sold">Sold</option>
              <option value="transferred_to_warehouse">Transferred to Warehouse</option>
              <option value="all">All</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Location:</label>
            <select id="location-filter">
              <option value="store" selected>Store</option>
              <option value="warehouse">Warehouse</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>
        
        <div class="table-responsive">
          <form id="transfer-form">
            <table id="inventory-table">
              <thead>
                <tr>
                  <th style="width: 30px;">
                    <input type="checkbox" id="select-all-inventory">
                  </th>
                  <th>IMEI</th>
                  <th>Device</th>
                  <th>Condition</th>
                  <th>Price Paid</th>
                  <th>Status</th>
                  <th>Added</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventory-body">
                <!-- Inventory items will be dynamically inserted here -->
                <tr>
                  <td colspan="8" style="text-align: center; padding: 30px;">
                    <i class="fas fa-box-open" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                    No inventory items found.
                  </td>
                </tr>
              </tbody>
            </table>
            
            <input type="hidden" id="transfer-notes" value="">
          </form>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="inventory-pagination">
          <a href="#" class="prev-page" style="opacity: 0.5; pointer-events: none;">
            <i class="fas fa-chevron-left"></i> Previous
          </a>
          
          <a href="#" class="active">1</a>
          
          <a href="#" class="next-page" style="opacity: 0.5; pointer-events: none;">
            Next <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
    </div>
    
    <!-- Cash Drawer Tab -->
    <div id="cash-drawer-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Cash Drawer Management</h2>
          <div id="cash-drawer-actions">
            <button class="btn" id="open-drawer-btn">
              <i class="fas fa-cash-register"></i> Open Drawer
            </button>
          </div>
        </div>
        
        <div id="active-cash-drawer" style="display: none;">
          <!-- Active Cash Drawer -->
          <div class="cash-drawer-summary">
            <div class="cash-stat">
              <div class="cash-stat-label">Opening Amount</div>
              <div class="cash-stat-value" id="opening-amount-display">$0.00</div>
            </div>
            
            <div class="cash-stat">
              <div class="cash-stat-label">Current Balance</div>
              <div class="cash-stat-value" id="current-balance-display">$0.00</div>
            </div>
            
            <div class="cash-stat">
              <div class="cash-stat-label">Opened At</div>
              <div class="cash-stat-value" id="opened-at-display" style="font-size: 16px;">
                --
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col">
              <div class="card-header">
                <h3>Recent Transactions</h3>
                <button class="btn" id="add-transaction-btn">
                  <i class="fas fa-plus"></i> Add Transaction
                </button>
              </div>
              
              <div class="transaction-list" id="transaction-list">
                <!-- Transactions will be dynamically inserted here -->
                <div style="text-align: center; padding: 30px;">
                  <i class="fas fa-receipt" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                  No transactions yet.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="no-active-drawer" style="text-align: center; padding: 50px 20px;">
          <i class="fas fa-cash-register" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
          <h3 style="margin-bottom: 10px;">No Active Cash Drawer</h3>
          <p class="muted">Open a cash drawer to start recording transactions.</p>
          <button class="btn" id="open-drawer-btn-center" style="margin-top: 20px;">
            <i class="fas fa-cash-register"></i> Open Cash Drawer
          </button>
        </div>
      </div>
    </div>
    
    <!-- Warehouse Tab -->
    <div id="warehouse-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Warehouse Management</h2>
        </div>
        
        <div style="text-align: center; padding: 50px 20px;">
          <i class="fas fa-warehouse" style="font-size: 48px; margin-bottom: 20px; display: block; opacity: 0.5;"></i>
          <h3 style="margin-bottom: 10px;">Warehouse Portal</h3>
          <p class="muted">The warehouse portal is currently under development.</p>
          <p class="muted">Coming soon: Inventory management, receiving transfers, and more.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>
  
  <!-- Modals -->
  <!-- Import to Inventory Modal -->
  <div class="modal" id="import-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import to Inventory</h3>
        <button class="modal-close" id="import-modal-close">&times;</button>
      </div>
      
      <p>Are you sure you want to import the selected items to inventory?</p>
      
      <div class="form-group">
        <label>Additional Notes (Optional):</label>
        <textarea id="import-notes" placeholder="Enter any additional notes..."></textarea>
      </div>
      
      <div class="modal-footer">
        <button class="btn secondary" id="import-modal-cancel">Cancel</button>
        <button class="btn" id="import-confirm">Import Items</button>
      </div>
    </div>
  </div>
  
  <!-- Transfer to Warehouse Modal -->
  <div class="modal" id="transfer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Transfer to Warehouse</h3>
        <button class="modal-close" id="transfer-modal-close">&times;</button>
      </div>
      
      <p>Are you sure you want to transfer the selected items to the warehouse?</p>
      <p class="muted">Selected items: <span id="transfer-count">0</span></p>
      
      <div class="form-group">
        <label>Transfer Notes (Optional):</label>
        <textarea id="transfer-notes-input" placeholder="Enter any transfer notes..."></textarea>
      </div>
      
      <div class="modal-footer">
        <button class="btn secondary" id="transfer-modal-cancel">Cancel</button>
        <button class="btn" id="transfer-confirm">Transfer Items</button>
      </div>
    </div>
  </div>
  
  <!-- Open Cash Drawer Modal -->
  <div class="modal" id="open-drawer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Open Cash Drawer</h3>
        <button class="modal-close" id="open-drawer-modal-close">&times;</button>
      </div>
      
      <form id="open-drawer-form">
        <div class="form-group">
          <label>Opening Amount ($):</label>
          <input type="number" id="opening-amount" step="0.01" min="0" required>
        </div>
        
        <div class="form-group">
          <label>Notes (Optional):</label>
          <textarea id="open-drawer-notes" placeholder="Enter any notes..."></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="open-drawer-modal-cancel">Cancel</button>
          <button type="submit" class="btn">Open Drawer</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Close Cash Drawer Modal -->
  <div class="modal" id="close-drawer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Close Cash Drawer</h3>
        <button class="modal-close" id="close-drawer-modal-close">&times;</button>
      </div>
      
      <form id="close-drawer-form">
        <div class="form-group">
          <label>Closing Amount ($):</label>
          <input type="number" id="closing-amount" step="0.01" min="0" required>
        </div>
        
        <div class="form-group">
          <label>Notes (Optional):</label>
          <textarea id="close-drawer-notes" placeholder="Enter any notes..."></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="close-drawer-modal-cancel">Cancel</button>
          <button type="submit" class="btn danger">Close Drawer</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Add Transaction Modal -->
  <div class="modal" id="add-transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Transaction</h3>
        <button class="modal-close" id="add-transaction-modal-close">&times;</button>
      </div>
      
      <form id="add-transaction-form">
        <div class="form-group">
          <label>Transaction Type:</label>
          <select id="transaction-type" required>
            <option value="purchase">Purchase (Money Out)</option>
            <option value="sale">Sale (Money In)</option>
            <option value="adjustment">Adjustment</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Amount ($):</label>
          <input type="number" id="transaction-amount" step="0.01" required>
          <p class="muted">Enter a positive amount. The system will automatically adjust the sign based on transaction type.</p>
        </div>
        
        <div class="form-group">
          <label>Notes (Optional):</label>
          <textarea id="transaction-notes" placeholder="Enter any notes..."></textarea>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="add-transaction-modal-cancel">Cancel</button>
          <button type="submit" class="btn">Add Transaction</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // Global state
    const state = {
      rows: [],
      manual: [],
      inventory: [],
      cashDrawer: null,
      transactions: [],
      currentPage: 1,
      itemsPerPage: 50,
      filters: {
        status: 'in_stock',
        location: 'store',
        search: ''
      }
    };

    // Color list (Apple + Samsung, 2022+)
    const COLOR_LIST = Array.from(new Set([
      // Apple 2022+: iPhone 14/14 Plus
      "Midnight","Starlight","Blue","Purple","Yellow","(PRODUCT)RED","Red",
      // iPhone 14 Pro/Max
      "Deep Purple","Space Black","Silver","Gold",
      // iPhone 15/15 Plus
      "Black","Light Blue","Light Green","Light Yellow","Light Pink","Pink","Green","Yellow",
      // iPhone 15 Pro/Max
      "Natural Titanium","Blue Titanium","White Titanium","Black Titanium","Titanium",
      // iPhone 16/Pro (as used in your data)
      "Desert","Desert Titanium","Natural",
      // Samsung S22 family
      "Phantom Black","Phantom White","Green","Pink Gold","Burgundy","Graphite","Sky Blue","Red",
      // Samsung S23 family
      "Cream","Lavender","Lime",
      // Samsung S24 family
      "Onyx Black","Marble Gray","Cobalt Violet","Amber Yellow",
      "Titanium Black","Titanium Gray","Titanium Violet","Titanium Yellow","Titanium Blue","Titanium Green","Titanium Orange"
    ])).sort((a,b)=>a.localeCompare(b));

    // Helper functions
    function formatMoney(cents) {
      return '$' + (cents / 100).toFixed(2);
    }

    function escapeHtml(s) {
      return String(s == null ? '' : s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function showLoader() {
      document.getElementById('loader').classList.add('show');
    }

    function hideLoader() {
      document.getElementById('loader').classList.remove('show');
    }

    function showAlert(type, message) {
      const alertsContainer = document.getElementById('alerts-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${type}`;
      
      let icon = '';
      if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
      else if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
      else if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';
      
      alertDiv.innerHTML = `${icon} ${message}`;
      alertsContainer.appendChild(alertDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true,
        timeZone: 'America/New_York' // Eastern Time
      });
    }

    // Tab switching
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
          
          // Load tab-specific data
          if (tabId === 'inventory') {
            loadInventory();
          } else if (tabId === 'cash-drawer') {
            loadCashDrawer();
          }
        });
      });
      
      // Check API balance
      checkBalance();
      
      // Setup device typeahead
      setupDeviceTypeahead();
      
      // Setup color typeahead
      setupColorTypeahead();
      
      // Setup event listeners
      setupEventListeners();
    });

    // Check API balance
    function checkBalance() {
      fetch('/api/balance')
        .then(response => response.json())
        .then(data => {
          const balanceValue = document.getElementById('balance-value');
          if (data.balance) {
            balanceValue.textContent = '$' + data.balance;
          } else {
            balanceValue.textContent = 'Error';
            balanceValue.classList.add('error');
          }
        })
        .catch(error => {
          console.error('Error checking balance:', error);
          document.getElementById('balance-value').textContent = 'Error';
          document.getElementById('balance-value').classList.add('error');
        });
    }

    // Device typeahead setup
    function setupDeviceTypeahead() {
      var input = document.getElementById('m_device');
      var box   = document.getElementById('m_suggest');
      var activeIdx = -1;
      var lastQ = ""; var inflight = 0;

      function hide() { box.style.display = 'none'; box.innerHTML = ''; activeIdx = -1; }
      function show() { box.style.display = 'block'; }

      function setStorageFromText(storageText) {
        if (!storageText) return;
        var val = storageText.toUpperCase().replace(/\s+/g,'').replace(/B$/, 'B'); // e.g., 256GB
        var select = document.getElementById('m_storage');
        for (var i=0;i<select.options.length;i++) {
          if (select.options[i].text.toUpperCase() === val) { select.selectedIndex = i; return; }
        }
      }

      function parseColorAndStorage(deviceText) {
        var upper = (deviceText || '').toUpperCase();
        // Storage
        var storage = null;
        var m = upper.match(/(64|128|256|512|1024|2048)\s*GB\b|\b(1|2)\s*TB\b/);
        if (m) {
          if (m[1]) storage = m[1] + "GB";
          else if (m[2]) storage = m[2] + "TB";
        }
        // Color: pick first match from COLOR_LIST
        var color = null;
        for (var i=0;i<COLOR_LIST.length;i++) {
          var c = COLOR_LIST[i];
          var re = new RegExp('(^|\\s)'+c.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')+'(\\s|$)', 'i');
          if (re.test(deviceText)) { color = c; break; }
        }
        return { color: color, storage: storage };
      }

      function selectItem(obj) {
        input.value = obj.device;
        var parsed = parseColorAndStorage(obj.device);
        if (parsed.color && !document.getElementById('m_color').value) document.getElementById('m_color').value = parsed.color;
        if (parsed.storage) setStorageFromText(parsed.storage);
        document.getElementById('m_price').value = obj.price_dollars || 0;
        hide();
      }

      function renderList(arr) {
        if (!arr.length) { hide(); return; }
        var html = arr.map(function(r, i) {
          return '<div class="sug-item" data-idx="'+i+'">'
            + '<div class="sug-left"><div class="sug-device">'+ r.device +'</div><div class="sug-sheet">'+ (r.sheet || '') +'</div></div>'
            + '<div class="sug-price">$'+ (r.price_dollars || 0) +'</div></div>';
        }).join('');
        box.innerHTML = html;
        Array.prototype.forEach.call(box.querySelectorAll('.sug-item'), function(el) {
          el.addEventListener('mousedown', function(e) {
            e.preventDefault();
            var idx = parseInt(el.getAttribute('data-idx'), 10);
            selectItem(arr[idx]);
          });
        });
        show();
      }

      function debounce(fn, ms) { var t; return function(){ clearTimeout(t); var args=arguments; t=setTimeout(function(){ fn.apply(null,args); }, ms); }; }

      var doFetch = debounce(async function(q) {
        if (!q || q.length < 2) { hide(); return; }
        if (q === lastQ) return;
        lastQ = q;
        var myTicket = ++inflight;
        try {
          const res = await fetch('/api/search?q=' + encodeURIComponent(q) + '&limit=20');
          const data = await res.json();
          if (inflight !== myTicket) return;
          renderList((data && data.results) ? data.results : []);
        } catch (e) { hide(); }
      }, 180);

      input.addEventListener('input', function() { doFetch(input.value.trim()); });

      input.addEventListener('keydown', function(e) {
        var items = box.querySelectorAll('.sug-item');
        if (box.style.display === 'none' || !items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = (activeIdx + 1) % items.length; }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = (activeIdx - 1 + items.length) % items.length; }
        else if (e.key === 'Enter') {
          e.preventDefault();
          if (activeIdx >= 0 && activeIdx < items.length) {
            var idx = parseInt(items[activeIdx].getAttribute('data-idx'), 10);
            var it = items[activeIdx];
            selectItem({
              device: it.querySelector('.sug-device').textContent,
              sheet:  it.querySelector('.sug-sheet').textContent,
              price_dollars: Number(it.querySelector('.sug-price').textContent.replace(/^\D+/, '')) || 0
            });
          }
        } else if (e.key === 'Escape') { hide(); }
        Array.prototype.forEach.call(items, function(el, i){ if (i === activeIdx) el.classList.add('active'); else el.classList.remove('active'); });
      });

      input.addEventListener('blur', function() { setTimeout(hide, 120); });
    }

    // Color typeahead setup
    function setupColorTypeahead() {
      var input = document.getElementById('m_color');
      var box   = document.getElementById('m_color_suggest');
      var activeIdx = -1;
      function hide() { box.style.display = 'none'; box.innerHTML = ''; activeIdx = -1; }
      function show() { box.style.display = 'block'; }

      function filterColors(q) {
        if (!q) return COLOR_LIST.slice(0, 20);
        q = q.toLowerCase();
        return COLOR_LIST
          .map(c => ({ c, score: (c.toLowerCase().startsWith(q) ? 2 : (c.toLowerCase().includes(q) ? 1 : 0)) }))
          .filter(x => x.score > 0)
          .sort((a,b) => b.score - a.score || a.c.localeCompare(b.c))
          .slice(0, 20)
          .map(x => x.c);
      }

      function renderList(arr) {
        if (!arr.length) { hide(); return; }
        var html = arr.map((name, i) => '<div class="sug-item" data-idx="'+i+'"><div>'+name+'</div></div>').join('');
        box.innerHTML = html;
        Array.prototype.forEach.call(box.querySelectorAll('.sug-item'), function(el) {
          el.addEventListener('mousedown', function(e) {
            e.preventDefault();
            var idx = parseInt(el.getAttribute('data-idx'), 10);
            input.value = arr[idx];
            hide();
          });
        });
        show();
      }

      input.addEventListener('input', function() {
        var q = input.value.trim();
        renderList(filterColors(q));
      });

      input.addEventListener('keydown', function(e) {
        var items = box.querySelectorAll('.sug-item');
        if (box.style.display === 'none' || !items.length) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = (activeIdx + 1) % items.length; }
        else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = (activeIdx - 1 + items.length) % items.length; }
        else if (e.key === 'Enter') {
          e.preventDefault();
          if (activeIdx >= 0 && activeIdx < items.length) {
            var idx = parseInt(items[activeIdx].getAttribute('data-idx'), 10);
            input.value = items[idx].innerText.trim();
            hide();
          }
        } else if (e.key === 'Escape') { hide(); }
        Array.prototype.forEach.call(items, function(el, i){ if (i === activeIdx) el.classList.add('active'); else el.classList.remove('active'); });
      });

      input.addEventListener('focus', function() {
        if (!input.value.trim()) renderList(filterColors(''));
      });

      input.addEventListener('blur', function() { setTimeout(hide, 120); });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Refresh balance button
      document.getElementById('refresh-balance').addEventListener('click', checkBalance);
      
      // IMEI lookup
      document.getElementById('lookup-btn').addEventListener('click', lookupIMEIs);
      
      // Reset button
      document.getElementById('reset-btn').addEventListener('click', resetLookup);
      
      // Add manual item
      document.getElementById('addManual').addEventListener('click', addManualItem);
      
      // Import to inventory button
      document.getElementById('import-to-inventory-btn').addEventListener('click', showImportModal);
      
      // Import modal close
      document.getElementById('import-modal-close').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('show');
      });
      
      document.getElementById('import-modal-cancel').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('show');
      });
      
      // Import confirm
      document.getElementById('import-confirm').addEventListener('click', importToInventory);
      
      // Transfer to warehouse button
      document.getElementById('transfer-to-warehouse-btn').addEventListener('click', showTransferModal);
      
      // Transfer modal close
      document.getElementById('transfer-modal-close').addEventListener('click', () => {
        document.getElementById('transfer-modal').classList.remove('show');
      });
      
      document.getElementById('transfer-modal-cancel').addEventListener('click', () => {
        document.getElementById('transfer-modal').classList.remove('show');
      });
      
      // Transfer confirm
      document.getElementById('transfer-confirm').addEventListener('click', transferToWarehouse);
      
      // Inventory search
      document.getElementById('inventory-search-btn').addEventListener('click', () => {
        state.filters.search = document.getElementById('inventory-search').value;
        loadInventory();
      });
      
      // Status filter
      document.getElementById('status-filter').addEventListener('change', () => {
        state.filters.status = document.getElementById('status-filter').value;
        loadInventory();
      });
      
      // Location filter
      document.getElementById('location-filter').addEventListener('change', () => {
        state.filters.location = document.getElementById('location-filter').value;
        loadInventory();
      });
      
      // Open cash drawer buttons
      document.getElementById('open-drawer-btn').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.add('show');
      });
      
      document.getElementById('open-drawer-btn-center').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.add('show');
      });
      
      // Open drawer modal close
      document.getElementById('open-drawer-modal-close').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.remove('show');
      });
      
      document.getElementById('open-drawer-modal-cancel').addEventListener('click', () => {
        document.getElementById('open-drawer-modal').classList.remove('show');
      });
      
      // Open drawer form submit
      document.getElementById('open-drawer-form').addEventListener('submit', (e) => {
        e.preventDefault();
        openCashDrawer();
      });
      
      // Close cash drawer button (will be added dynamically when drawer is open)
      
      // Add transaction button (will be enabled when drawer is open)
      document.getElementById('add-transaction-btn').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.add('show');
      });
      
      // Add transaction modal close
      document.getElementById('add-transaction-modal-close').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.remove('show');
      });
      
      document.getElementById('add-transaction-modal-cancel').addEventListener('click', () => {
        document.getElementById('add-transaction-modal').classList.remove('show');
      });
      
      // Add transaction form submit
      document.getElementById('add-transaction-form').addEventListener('submit', (e) => {
        e.preventDefault();
        addTransaction();
      });
    }

    // IMEI lookup function
    function lookupIMEIs() {
      const imeisText = document.getElementById('imeis').value;
      if (!imeisText.trim()) {
        showAlert('error', 'Please enter at least one IMEI.');
        return;
      }
      
      const imeis = imeisText.split(/[\s,;]+/).map(s => s.trim()).filter(Boolean);
      if (!imeis.length) {
        showAlert('error', 'Please enter valid IMEIs.');
        return;
      }
      
      showLoader();
      
      fetch('/api/intake', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imeis: imeis })
      })
      .then(response => response.json())
      .then(data => {
        hideLoader();
        
        if (data.items && data.items.length) {
          state.rows = data.items;
          renderResults();
          document.getElementById('results-container').style.display = 'block';
        } else {
          showAlert('error', 'No results returned.');
        }
      })
      .catch(error => {
        hideLoader();
        showAlert('error', 'Error looking up IMEIs: ' + error.message);
        console.error('Error:', error);
      });
    }

    // Render results table
    function renderResults() {
      const tbody = document.getElementById('results-body');
      tbody.innerHTML = '';
      
      state.rows.forEach((r, idx) => {
        if (!r.ok) {
          const errorRow = document.createElement('tr');
          errorRow.innerHTML = `
            <td></td>
            <td colspan="11" class="error">
              <i class="fas fa-exclamation-circle"></i>
              IMEI ${escapeHtml(r.imei)} → ${escapeHtml(r.error || 'error')}
            </td>
          `;
          tbody.appendChild(errorRow);
          return;
        }
        
        const confidence = (r.confidence || 0) * 100;
        const confidenceClass = confidence > 80 ? 'success' : (confidence > 50 ? 'warning' : 'error');
        
        const row = document.createElement('tr');
        row.className = 'result-row';
        row.setAttribute('data-idx', idx);
        
        row.innerHTML = `
          <td>
            <input type="checkbox" class="select-item" data-idx="${idx}">
          </td>
          <td><code>${escapeHtml(r.imei)}</code></td>
          <td>${escapeHtml(r.device_display || ((r.manufacturer || '') + ' ' + (r.model_name || '')))}</td>
          <td>${escapeHtml(r.color || '')}</td>
          <td>${escapeHtml(r.storage || '')}</td>
          <td><span class="tag">${escapeHtml(r.carrier || 'Unknown')}</span></td>
          <td class="right">${escapeHtml(String(r.base_price_cents || ''))}</td>
          <td class="right"><b>${escapeHtml(String(r.suggested_price_cents || ''))}</b></td>
          <td>
            <span class="tag ${confidenceClass}">${confidence.toFixed(1)}%</span>
          </td>
          <td>
            <select class="condition-select" data-idx="${idx}">
              <option value="A">A - Like New</option>
              <option value="B" selected>B - Good</option>
              <option value="C">C - Fair</option>
              <option value="D">D - Poor</option>
            </select>
          </td>
          <td>
            <input type="number" class="price-paid" data-idx="${idx}" placeholder="${escapeHtml(String(r.suggested_price_cents || ''))}" value="${escapeHtml(String(r.suggested_price_cents || ''))}">
          </td>
          <td>
            <input type="text" class="notes" data-idx="${idx}" placeholder="Optional notes">
          </td>
        `;
        
        tbody.appendChild(row);
        
        // Add hidden fields for import
        const hiddenFields = document.createElement('div');
        hiddenFields.style.display = 'none';
        hiddenFields.innerHTML = `
          <input type="hidden" class="imei" data-idx="${idx}" value="${escapeHtml(String(r.imei))}">
          <input type="hidden" class="manufacturer" data-idx="${idx}" value="${escapeHtml(String(r.manufacturer || ''))}">
          <input type="hidden" class="model-name" data-idx="${idx}" value="${escapeHtml(String(r.model_name || ''))}">
          <input type="hidden" class="model-code" data-idx="${idx}" value="${escapeHtml(String(r.model_code || ''))}">
          <input type="hidden" class="device-display" data-idx="${idx}" value="${escapeHtml(String(r.device_display || ''))}">
          <input type="hidden" class="suggested-price" data-idx="${idx}" value="${escapeHtml(String(r.suggested_price_cents || ''))}">
        `;
        tbody.appendChild(hiddenFields);
      });
      
      // Select all checkbox
      const selectAllCheckbox = document.getElementById('select-all');
      selectAllCheckbox.checked = false;
      selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.select-item').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
    }

    // Reset lookup
    function resetLookup() {
      document.getElementById('imeis').value = '';
      state.rows = [];
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('results-body').innerHTML = '';
    }

    // Add manual item
    function addManualItem(e) {
      e.preventDefault();
      const device = document.getElementById('m_device').value.trim();
      const color = document.getElementById('m_color').value.trim();
      const storage = document.getElementById('m_storage').value.trim();
      const carrier = document.getElementById('m_carrier').value || 'Unknown';
      const qty = Math.max(1, Number(document.getElementById('m_qty').value || '1'));
      const unitPrice = Number(document.getElementById('m_price').value || '');
      
      if (!device) {
        showAlert('error', 'Please enter a device name.');
        return;
      }
      
      for (let i = 0; i < qty; i++) {
        state.manual.push({
          device: device,
          color: color,
          storage: storage,
          carrier: carrier,
          identifier: '',
          unitPrice: isFinite(unitPrice) ? unitPrice : 0,
          notes: ''
        });
      }
      
      renderManualItems();
      
      // Clear inputs
      document.getElementById('m_device').value = '';
      document.getElementById('m_color').value = '';
      document.getElementById('m_storage').selectedIndex = 0;
      document.getElementById('m_carrier').selectedIndex = 0;
      document.getElementById('m_qty').value = '1';
      document.getElementById('m_price').value = '';
    }

    // Render manual items
    function renderManualItems() {
      const outDiv = document.getElementById('out');
      if (!state.manual.length) {
        outDiv.innerHTML = '';
        document.getElementById('totals').innerText = '';
        return;
      }
      
      let table = [];
      table.push('<table><thead><tr>'
        + '<th>Identifier (IMEI / Serial)</th>'
        + '<th>Device</th>'
        + '<th>Color</th>'
        + '<th>Storage</th>'
        + '<th>Carrier</th>'
        + '<th>Matched (Sheet)</th>'
        + '<th class="right">Price Paid ($)</th>'
        + '<th>Qty</th>'
        + '<th>Notes</th>'
        + '</tr></thead><tbody>');
      
      state.manual.forEach((r, idx) => {
        table.push('<tr>'
          + '<td><input type="text" class="mident" data-idx="'+idx+'" placeholder="IMEI or Serial" value="'+ escapeHtml(r.identifier || '') + '"/></td>'
          + '<td>' + escapeHtml(r.device || '') + '</td>'
          + '<td>' + escapeHtml(r.color || '') + '</td>'
          + '<td>' + escapeHtml(r.storage || '') + '</td>'
          + '<td><span class="tag">' + escapeHtml(r.carrier || 'Unknown') + '</span></td>'
          + '<td><div class="muted">—</div></td>'
          + '<td class="right"><input type="number" class="mpaid" data-idx="' + idx + '" value="' + escapeHtml(String(r.unitPrice || '')) + '" step="1" min="0" /></td>'
          + '<td class="right">1</td>'
          + '<td><input type="text" class="mnote" data-idx="' + idx + '" value="' + escapeHtml(r.notes || '') + '" /></td>'
          + '</tr>');
      });
      
      table.push('</tbody></table>'
        + '<div class="row" style="margin-top:12px;">'
        + '  <button class="btn" id="download">Download CSV</button>'
        + '  <span class="muted">CSV uses a single <b>identifier</b> column (IMEI or Serial).</span>'
        + '</div>');
      
      outDiv.innerHTML = table.join('');
      
      // Identifier validation
      function refreshIdentifierValidation() {
        const inputs = Array.from(document.querySelectorAll('.mident'));
        const seen = new Map();
        inputs.forEach(inp => {
          const v = (inp.value || '').trim();
          const key = v.toUpperCase();
          inp.classList.remove('bad');
          inp.removeAttribute('title');
          
          if (!v) return;
          
          // Duplicate highlight
          if (seen.has(key)) {
            inp.classList.add('bad');
            const other = seen.get(key);
            if (other) other.classList.add('bad');
          } else {
            seen.set(key, inp);
          }
          
          // Soft IMEI check: if all digits and not 15 chars
          if (/^\d+$/.test(v) && v.length !== 15) {
            inp.classList.add('bad');
            inp.title = 'IMEI is usually 15 digits (serials can be any length).';
          }
        });
      }
      
      refreshIdentifierValidation();
      document.querySelectorAll('.mident').forEach(inp => {
        inp.addEventListener('input', refreshIdentifierValidation);
        
        // Update state when identifier changes
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].identifier = this.value.trim();
          }
        });
      });
      
      // Update state when price changes
      document.querySelectorAll('.mpaid').forEach(inp => {
        inp.addEventListener('input', computeTotals);
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].unitPrice = Number(this.value || 0);
          }
        });
      });
      
      // Update state when notes change
      document.querySelectorAll('.mnote').forEach(inp => {
        inp.addEventListener('change', function() {
          const idx = parseInt(this.getAttribute('data-idx'), 10);
          if (isFinite(idx) && state.manual[idx]) {
            state.manual[idx].notes = this.value.trim();
          }
        });
      });
      
      // Enter → focus next identifier
      const idents = Array.from(document.querySelectorAll('.mident'));
      idents.forEach((inp, i) => {
        inp.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const next = idents[i + 1];
            if (next) next.focus();
          }
        });
      });
      
      // Download CSV
      document.getElementById('download').addEventListener('click', downloadCSV);
      
      computeTotals();
      
      // Focus first empty identifier
      setTimeout(function() {
        const firstEmpty = Array.from(document.querySelectorAll('.mident')).find(inp => !inp.value);
        if (firstEmpty) firstEmpty.focus();
      }, 0);
    }

    // Compute totals
    function computeTotals() {
      let totalDollars = 0;
      
      // Add API rows
      document.querySelectorAll('.price-paid').forEach(inp => {
        const v = Number(inp.value || '');
        if (isFinite(v)) totalDollars += v / 100; // Convert cents to dollars
      });
      
      // Add manual rows
      document.querySelectorAll('.mpaid').forEach(inp => {
        const v = Number(inp.value || '');
        if (isFinite(v)) totalDollars += v;
      });
      
      document.getElementById('totals').innerText = 'Total: $' + Math.round(totalDollars);
    }

    // Download CSV
    function downloadCSV() {
      const payload = [];
      
      // API rows
      state.rows.forEach((r, idx) => {
        if (!r.ok) return;
        
        const paidEl = document.querySelector(`.price-paid[data-idx="${idx}"]`);
        const noteEl = document.querySelector(`.notes[data-idx="${idx}"]`);
        const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
        const cents = isFinite(dollars) ? Math.round(dollars) : ''; // Already in cents
        
        payload.push({
          manual: 'no',
          used: r.used ? 'yes' : 'no',
          used_source: r.used_source || '',
          identifier: r.imei,
          manufacturer: r.manufacturer || '',
          model_name: r.model_name || '',
          model_code: r.model_code || '',
          device: r.device_display || '',
          color: r.color || '',
          storage: r.storage || '',
          carrier: r.carrier || 'Unknown',
          icloud_lock: r.icloud_lock_on ? 'ON' : 'OFF',
          condition_hint: r.condition_hint || '',
          estimated_purchase_date: r.estimated_purchase_date || '',
          quantity: 1,
          unit_price_cents: cents,
          line_total_cents: cents,
          suggested_price_cents: (typeof r.suggested_price_cents !== 'undefined' ? r.suggested_price_cents : ''),
          notes: (noteEl ? noteEl.value : '')
        });
      });
      
      // Manual rows
      state.manual.forEach((r, idx) => {
        const paidEl = document.querySelector(`.mpaid[data-idx="${idx}"]`);
        const noteEl = document.querySelector(`.mnote[data-idx="${idx}"]`);
        const identEl = document.querySelector(`.mident[data-idx="${idx}"]`);
        const dollars = Number((paidEl && paidEl.value) ? paidEl.value : '');
        const cents = isFinite(dollars) ? Math.round(dollars * 100) : 0; // Convert to cents
        
        payload.push({
          manual: 'yes',
          used: '',
          used_source: '',
          identifier: identEl ? identEl.value.trim() : '',
          manufacturer: '',
          model_name: '',
          model_code: '',
          device: r.device || '',
          color: r.color || '',
          storage: r.storage || '',
          carrier: r.carrier || 'Unknown',
          icloud_lock: '',
          condition_hint: '',
          estimated_purchase_date: '',
          quantity: 1,
          unit_price_cents: cents,
          line_total_cents: cents,
          suggested_price_cents: '',
          notes: noteEl ? noteEl.value : ''
        });
      });
      
      const header = ['manual','used','used_source','identifier','manufacturer','model_name','model_code','device','color','storage','carrier','icloud_lock','condition_hint','estimated_purchase_date','quantity','unit_price_cents','line_total_cents','suggested_price_cents','notes'];
      const lines = [header.join(',')];
      
      payload.forEach(o => {
        const row = header.map(k => {
          const v = (o[k] != null) ? String(o[k]) : '';
          return JSON.stringify(v).replace(/^\uFEFF/, '');
        }).join(',');
        lines.push(row);
      });
      
      const csv = lines.join('\n');
      
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'intake_export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Show import modal
    function showImportModal() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to import.');
        return;
      }
      
      document.getElementById('import-modal').classList.add('show');
    }

    // Import to inventory
    function importToInventory() {
      const selectedItems = document.querySelectorAll('.select-item:checked');
      const payload = [];
      
      selectedItems.forEach(checkbox => {
        const idx = checkbox.dataset.idx;
        
        payload.push({
          imei: document.querySelector(`.imei[data-idx="${idx}"]`).value,
          manufacturer: document.querySelector(`.manufacturer[data-idx="${idx}"]`).value,
          model_name: document.querySelector(`.model-name[data-idx="${idx}"]`).value,
          model_code: document.querySelector(`.model-code[data-idx="${idx}"]`).value,
          device_display: document.querySelector(`.device-display[data-idx="${idx}"]`).value,
          condition: document.querySelector(`.condition-select[data-idx="${idx}"]`).value,
          price_paid_cents: document.querySelector(`.price-paid[data-idx="${idx}"]`).value,
          suggested_price_cents: document.querySelector(`.suggested-price[data-idx="${idx}"]`).value,
          notes: document.querySelector(`.notes[data-idx="${idx}"]`).value
        });
      });
      
      // Show loader
      showLoader();
      
      // Simulate import request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('import-modal').classList.remove('show');
        
        // Add to local inventory
        payload.forEach(item => {
          state.inventory.push({
            id: Date.now() + Math.floor(Math.random() * 1000),
            imei: item.imei,
            device_display: item.device_display,
            condition: item.condition,
            price_paid_cents: parseInt(item.price_paid_cents),
            status: 'in_stock',
            location: 'store',
            created_at: new Date().toISOString()
          });
        });
        
        showAlert('success', `Imported ${payload.length} items to inventory.`);
        
        // If on inventory tab, refresh the view
        if (document.getElementById('inventory-tab').classList.contains('active')) {
          renderInventory();
        }
      }, 1000);
    }

    // Load inventory
    function loadInventory() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderInventory();
      }, 500);
    }

    // Render inventory
    function renderInventory() {
      const tbody = document.getElementById('inventory-body');
      
      // Filter inventory based on current filters
      const filtered = state.inventory.filter(item => {
        // Status filter
        if (state.filters.status !== 'all' && item.status !== state.filters.status) {
          return false;
        }
        
        // Location filter
        if (state.filters.location !== 'all' && item.location !== state.filters.location) {
          return false;
        }
        
        // Search filter
        if (state.filters.search) {
          const search = state.filters.search.toLowerCase();
          return (
            (item.imei && item.imei.toLowerCase().includes(search)) ||
            (item.device_display && item.device_display.toLowerCase().includes(search))
          );
        }
        
        return true;
      });
      
      // Paginate
      const start = (state.currentPage - 1) * state.itemsPerPage;
      const end = start + state.itemsPerPage;
      const paginatedItems = filtered.slice(start, end);
      
      // Update pagination controls
      const pagination = document.getElementById('inventory-pagination');
      const prevLink = pagination.querySelector('.prev-page');
      const nextLink = pagination.querySelector('.next-page');
      const pageLink = pagination.querySelector('a.active');
      
      pageLink.textContent = state.currentPage;
      
      if (state.currentPage === 1) {
        prevLink.style.opacity = '0.5';
        prevLink.style.pointerEvents = 'none';
      } else {
        prevLink.style.opacity = '1';
        prevLink.style.pointerEvents = 'auto';
      }
      
      if (paginatedItems.length < state.itemsPerPage || end >= filtered.length) {
        nextLink.style.opacity = '0.5';
        nextLink.style.pointerEvents = 'none';
      } else {
        nextLink.style.opacity = '1';
        nextLink.style.pointerEvents = 'auto';
      }
      
      // Add click handlers for pagination
      prevLink.onclick = (e) => {
        e.preventDefault();
        if (state.currentPage > 1) {
          state.currentPage--;
          renderInventory();
        }
      };
      
      nextLink.onclick = (e) => {
        e.preventDefault();
        if (end < filtered.length) {
          state.currentPage++;
          renderInventory();
        }
      };
      
      // Render inventory items
      if (paginatedItems.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 30px;">
              <i class="fas fa-box-open" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
              No inventory items found.
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = '';
      
      paginatedItems.forEach(item => {
        const row = document.createElement('tr');
        
        let statusTag = '';
        if (item.status === 'in_stock') {
          statusTag = '<span class="tag success">In Stock</span>';
        } else if (item.status === 'sold') {
          statusTag = '<span class="tag">Sold</span>';
        } else if (item.status === 'transferred_to_warehouse') {
          statusTag = '<span class="tag warning">Transferred</span>';
        }
        
        row.innerHTML = `
          <td>
            <input type="checkbox" name="item_ids[]" value="${item.id}" class="inventory-select-item" ${item.status !== 'in_stock' ? 'disabled' : ''}>
          </td>
          <td><code>${escapeHtml(item.imei)}</code></td>
          <td>${escapeHtml(item.device_display)}</td>
          <td>${escapeHtml(item.condition)}</td>
          <td>${formatMoney(item.price_paid_cents)}</td>
          <td>${statusTag}</td>
          <td>${formatTimestamp(item.created_at)}</td>
          <td>
            <button type="button" class="btn secondary sm view-item" data-id="${item.id}">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Select all inventory checkbox
      const selectAllInventoryCheckbox = document.getElementById('select-all-inventory');
      selectAllInventoryCheckbox.checked = false;
      selectAllInventoryCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.inventory-select-item:not([disabled])').forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateTransferCount();
      });
      
      // Inventory item checkboxes
      document.querySelectorAll('.inventory-select-item').forEach(checkbox => {
        checkbox.addEventListener('change', updateTransferCount);
      });
      
      // View item buttons
      document.querySelectorAll('.view-item').forEach(button => {
        button.addEventListener('click', () => {
          const itemId = button.getAttribute('data-id');
          // In a real app, this would show a modal with item details
          alert(`View item details for ID: ${itemId}`);
        });
      });
    }

    // Update transfer count
    function updateTransferCount() {
      const count = document.querySelectorAll('.inventory-select-item:checked').length;
      document.getElementById('transfer-count').textContent = count;
    }

    // Show transfer modal
    function showTransferModal() {
      const selectedItems = document.querySelectorAll('.inventory-select-item:checked');
      if (selectedItems.length === 0) {
        showAlert('error', 'Please select at least one item to transfer.');
        return;
      }
      
      updateTransferCount();
      document.getElementById('transfer-modal').classList.add('show');
    }

    // Transfer to warehouse
    function transferToWarehouse() {
      const selectedItems = document.querySelectorAll('.inventory-select-item:checked');
      const itemIds = Array.from(selectedItems).map(checkbox => checkbox.value);
      const notes = document.getElementById('transfer-notes-input').value;
      
      document.getElementById('transfer-notes').value = notes;
      
      // Show loader
      showLoader();
      
      // Simulate transfer request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('transfer-modal').classList.remove('show');
        
        // Update local inventory
        itemIds.forEach(id => {
          const item = state.inventory.find(item => item.id == id);
          if (item) {
            item.status = 'transferred_to_warehouse';
            item.location = 'warehouse';
          }
        });
        
        showAlert('success', `Transferred ${itemIds.length} items to warehouse.`);
        renderInventory();
      }, 1000);
    }

    // Load cash drawer
    function loadCashDrawer() {
      showLoader();
      
      // In a real app, this would fetch from the server
      // For demo purposes, we'll use the local state
      setTimeout(() => {
        hideLoader();
        renderCashDrawer();
      }, 500);
    }

    // Render cash drawer
    function renderCashDrawer() {
      const activeDrawerDiv = document.getElementById('active-cash-drawer');
      const noActiveDrawerDiv = document.getElementById('no-active-drawer');
      const cashDrawerActions = document.getElementById('cash-drawer-actions');
      
      if (state.cashDrawer) {
        // Show active drawer
        activeDrawerDiv.style.display = 'block';
        noActiveDrawerDiv.style.display = 'none';
        
        // Update drawer info
        document.getElementById('opening-amount-display').textContent = formatMoney(state.cashDrawer.opening_amount_cents);
        document.getElementById('current-balance-display').textContent = formatMoney(state.cashDrawer.expected_amount_cents);
        document.getElementById('opened-at-display').textContent = formatTimestamp(state.cashDrawer.opened_at);
        
        // Update actions
        cashDrawerActions.innerHTML = `
          <button class="btn danger" id="close-drawer-btn">
            <i class="fas fa-cash-register"></i> Close Drawer
          </button>
        `;
        
        // Add close drawer event listener
        document.getElementById('close-drawer-btn').addEventListener('click', () => {
          document.getElementById('close-drawer-modal').classList.add('show');
        });
        
        // Close drawer modal close
        document.getElementById('close-drawer-modal-close').addEventListener('click', () => {
          document.getElementById('close-drawer-modal').classList.remove('show');
        });
        
        document.getElementById('close-drawer-modal-cancel').addEventListener('click', () => {
          document.getElementById('close-drawer-modal').classList.remove('show');
        });
        
        // Close drawer form submit
        document.getElementById('close-drawer-form').addEventListener('submit', (e) => {
          e.preventDefault();
          closeCashDrawer();
        });
        
        // Render transactions
        renderTransactions();
      } else {
        // Show no active drawer
        activeDrawerDiv.style.display = 'none';
        noActiveDrawerDiv.style.display = 'block';
        
        // Update actions
        cashDrawerActions.innerHTML = `
          <button class="btn" id="open-drawer-btn">
            <i class="fas fa-cash-register"></i> Open Drawer
          </button>
        `;
        
        // Add open drawer event listener
        document.getElementById('open-drawer-btn').addEventListener('click', () => {
          document.getElementById('open-drawer-modal').classList.add('show');
        });
      }
    }

    // Render transactions
    function renderTransactions() {
      const transactionList = document.getElementById('transaction-list');
      
      if (!state.transactions.length) {
        transactionList.innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <i class="fas fa-receipt" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
            No transactions yet.
          </div>
        `;
        return;
      }
      
      transactionList.innerHTML = '';
      
      state.transactions.forEach(transaction => {
        const item = document.createElement('div');
        item.className = 'transaction-item';
        
        let icon = '';
        if (transaction.transaction_type === 'purchase') {
          icon = '<i class="fas fa-shopping-cart"></i> Purchase';
        } else if (transaction.transaction_type === 'sale') {
          icon = '<i class="fas fa-tag"></i> Sale';
        } else if (transaction.transaction_type === 'adjustment') {
          icon = '<i class="fas fa-sliders-h"></i> Adjustment';
        } else {
          icon = '<i class="fas fa-exchange-alt"></i> ' + transaction.transaction_type.charAt(0).toUpperCase() + transaction.transaction_type.slice(1);
        }
        
        item.innerHTML = `
          <div class="transaction-info">
            <div class="transaction-type">
              ${icon}
            </div>
            <div class="transaction-meta">
              ${formatTimestamp(transaction.created_at)}
              ${transaction.notes ? ' • ' + escapeHtml(transaction.notes) : ''}
            </div>
          </div>
          <div class="transaction-amount ${transaction.amount_cents >= 0 ? 'positive' : 'negative'}">
            ${transaction.amount_cents >= 0 ? '+' : ''}${formatMoney(transaction.amount_cents)}
          </div>
        `;
        
        transactionList.appendChild(item);
      });
    }

    // Open cash drawer
    function openCashDrawer() {
      const amount = document.getElementById('opening-amount').value;
      const notes = document.getElementById('open-drawer-notes').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid opening amount.');
        return;
      }
      
      // Convert dollars to cents
      const amountCents = Math.round(parseFloat(amount) * 100);
      
      // Show loader
      showLoader();
      
      // Simulate open drawer request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('open-drawer-modal').classList.remove('show');
        
        // Create cash drawer
        state.cashDrawer = {
          id: Date.now(),
          opening_amount_cents: amountCents,
          expected_amount_cents: amountCents,
          status: 'open',
          opened_at: new Date().toISOString(),
          notes: notes
        };
        
        showAlert('success', 'Cash drawer successfully opened.');
        renderCashDrawer();
      }, 1000);
    }

    // Close cash drawer
    function closeCashDrawer() {
      const amount = document.getElementById('closing-amount').value;
      const notes = document.getElementById('close-drawer-notes').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid closing amount.');
        return;
      }
      
      // Convert dollars to cents
      const amountCents = Math.round(parseFloat(amount) * 100);
      
      // Show loader
      showLoader();
      
      // Simulate close drawer request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('close-drawer-modal').classList.remove('show');
        
        // Close cash drawer
        state.cashDrawer.closing_amount_cents = amountCents;
        state.cashDrawer.difference_cents = amountCents - state.cashDrawer.expected_amount_cents;
        state.cashDrawer.status = 'closed';
        state.cashDrawer.closed_at = new Date().toISOString();
        state.cashDrawer.notes = notes;
        
        // Reset cash drawer
        state.cashDrawer = null;
        state.transactions = [];
        
        showAlert('success', 'Cash drawer successfully closed.');
        renderCashDrawer();
      }, 1000);
    }

    // Add transaction
    function addTransaction() {
      const type = document.getElementById('transaction-type').value;
      const amount = document.getElementById('transaction-amount').value;
      const notes = document.getElementById('transaction-notes').value;
      
      if (!amount || parseFloat(amount) <= 0) {
        showAlert('error', 'Please enter a valid amount.');
        return;
      }
      
      // Convert dollars to cents and adjust sign based on transaction type
      let amountCents = Math.round(parseFloat(amount) * 100);
      
      // Adjust sign based on transaction type
      if (type === 'purchase') {
        amountCents = -Math.abs(amountCents); // Negative for money out
      } else {
        amountCents = Math.abs(amountCents); // Positive for money in
      }
      
      // Show loader
      showLoader();
      
      // Simulate add transaction request (in a real app, this would be a fetch to the server)
      setTimeout(() => {
        hideLoader();
        document.getElementById('add-transaction-modal').classList.remove('show');
        
        // Add transaction
        state.transactions.push({
          id: Date.now(),
          cash_drawer_id: state.cashDrawer.id,
          amount_cents: amountCents,
          transaction_type: type,
          notes: notes,
          created_at: new Date().toISOString()
        });
        
        // Update cash drawer balance
        state.cashDrawer.expected_amount_cents += amountCents;
        
        showAlert('success', 'Transaction successfully recorded.');
        renderCashDrawer();
      }, 1000);
    }
  </script>
</body>
</html>